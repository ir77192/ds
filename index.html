<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<title>ë‹¤í¬ ì„œë°”ì´ë²„</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;500;600;700&family=Noto+Sans+KR:wght@300;400;500;700&display=swap');
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
:root{
  --c-bg:#0d0f14; --c-surface:#13161e; --c-surface2:#1a1f2b;
  --c-border:#252c3d; --c-border2:#2e3850;
  --c-hp:#e8453c; --c-hp2:#ff6b63;
  --c-xp:#7c5cfc; --c-xp2:#a78bfa;
  --c-gold:#f0c040; --c-gold2:#fad86a;
  --c-evo:#f97316; --c-evo2:#fb923c;
  --c-text:#c9d1e8; --c-text2:#8899bb;
  --c-green:#4ade80; --c-teal:#2dd4bf;
  --c-coin:#FFD700;
}
html,body{width:100%;height:100%;background:var(--c-bg);font-family:'Noto Sans KR',sans-serif;overflow:hidden;user-select:none;touch-action:none;position:relative;}
#gw{position:absolute;}
canvas{display:block;border:1px solid var(--c-border2);border-radius:4px;
  box-shadow:0 0 0 1px rgba(255,255,255,0.04),0 8px 32px rgba(0,0,0,0.6),0 0 60px rgba(124,92,252,0.08);touch-action:none;}

/* HUD */
#hud{position:absolute;top:0;left:0;right:0;display:flex;justify-content:space-between;align-items:flex-start;padding:10px 14px;pointer-events:none;z-index:10;}
.hl{display:flex;flex-direction:column;gap:5px;}
.bw{display:flex;align-items:center;gap:7px;}
.bl{font-family:'Rajdhani',sans-serif;font-size:10px;font-weight:600;color:var(--c-text2);letter-spacing:1.5px;text-transform:uppercase;min-width:22px;}
.bb{width:clamp(100px,22vw,170px);height:7px;background:rgba(255,255,255,0.06);border-radius:99px;overflow:hidden;}
#hp{height:100%;border-radius:99px;background:linear-gradient(90deg,var(--c-hp),var(--c-hp2));box-shadow:0 0 8px rgba(232,69,60,0.5);transition:width 0.15s ease;}
#xp{height:100%;border-radius:99px;background:linear-gradient(90deg,var(--c-xp),var(--c-xp2));box-shadow:0 0 8px rgba(124,92,252,0.5);transition:width 0.25s ease;}
#lvl{font-family:'Rajdhani',sans-serif;font-size:11px;font-weight:600;color:var(--c-text2);letter-spacing:2px;text-transform:uppercase;margin-top:1px;}
#lvl span{color:var(--c-gold);font-size:13px;font-weight:700;}
#timer{font-family:'Rajdhani',sans-serif;font-size:clamp(18px,4vw,26px);font-weight:700;color:var(--c-text);letter-spacing:4px;}
#kills{font-family:'Rajdhani',sans-serif;font-size:11px;font-weight:600;color:var(--c-text2);letter-spacing:2px;text-transform:uppercase;text-align:right;}
#kills span{color:var(--c-hp2);}
#coin-hud{font-family:'Rajdhani',sans-serif;font-size:12px;font-weight:700;color:var(--c-coin);letter-spacing:2px;text-align:right;margin-top:3px;}
#stage-hud{font-family:'Rajdhani',sans-serif;font-size:10px;font-weight:600;color:var(--c-text2);letter-spacing:2px;text-transform:uppercase;text-align:center;}
#stage-hud span{color:var(--c-evo2);}

/* OVERLAYS */
.ov{position:absolute;top:0;left:0;right:0;bottom:0;display:flex;flex-direction:column;align-items:center;justify-content:center;background:rgba(8,10,16,0.93);z-index:100;backdrop-filter:blur(6px);pointer-events:auto;touch-action:auto;overflow-y:auto;}
.ov-title{font-family:'Rajdhani',sans-serif;font-weight:700;color:var(--c-text);letter-spacing:6px;text-transform:uppercase;margin-bottom:4px;}
.ov-sub{font-size:11px;font-weight:500;color:var(--c-text2);letter-spacing:4px;text-transform:uppercase;margin-bottom:28px;}
.sep{width:280px;height:1px;background:linear-gradient(90deg,transparent,var(--c-border2),transparent);margin:16px 0;}
.btn{font-family:'Rajdhani',sans-serif;font-size:13px;font-weight:700;letter-spacing:3px;text-transform:uppercase;color:var(--c-bg);background:var(--c-gold);border:none;border-radius:3px;padding:12px 40px;cursor:pointer;transition:all 0.18s ease;margin:5px;min-height:44px;}
.btn:hover{background:var(--c-gold2);transform:translateY(-1px);box-shadow:0 4px 20px rgba(240,192,64,0.35);}
.btn:active{transform:translateY(0);opacity:0.85;}
.btn-secondary{background:var(--c-surface2);color:var(--c-text);border:1px solid var(--c-border2);}
.btn-secondary:hover{background:var(--c-border2);transform:translateY(-1px);}

/* Level Up */
#luscreen{z-index:50;}
#lu-title{font-family:'Rajdhani',sans-serif;font-size:13px;font-weight:700;color:var(--c-text2);letter-spacing:4px;text-transform:uppercase;margin-bottom:16px;text-align:center;}
#lu-title.evo{color:var(--c-evo2);}
.cards{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;max-width:95vw;padding:0 10px;}
.card{width:clamp(120px,28vw,150px);background:var(--c-surface);border:1px solid var(--c-border2);border-radius:6px;padding:16px 12px 12px;cursor:pointer;transition:all 0.18s ease;position:relative;overflow:hidden;}
.card::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,transparent,var(--c-xp),transparent);opacity:0;transition:opacity 0.18s;}
.card:hover,.card:active{border-color:var(--c-xp2);transform:translateY(-2px);box-shadow:0 8px 24px rgba(0,0,0,0.4);}
.card:hover::before,.card:active::before{opacity:1;}
.card.evo-card{border-color:rgba(249,115,22,0.5);background:rgba(30,15,5,0.8);}
.card.evo-card::before{background:linear-gradient(90deg,transparent,var(--c-evo),transparent);}
.card.evo-card:hover,.card.evo-card:active{border-color:var(--c-evo2);}
.ci{font-size:26px;margin-bottom:8px;text-align:center;line-height:1;}
.cn{font-family:'Rajdhani',sans-serif;font-size:12px;font-weight:700;color:var(--c-text);text-align:center;margin-bottom:5px;letter-spacing:0.5px;}
.card.evo-card .cn{color:var(--c-evo2);}
.cd{font-size:10px;color:var(--c-text2);text-align:center;line-height:1.5;font-weight:400;}
.evo-badge{font-family:'Rajdhani',sans-serif;font-size:9px;font-weight:700;color:var(--c-evo);text-align:center;margin-top:6px;letter-spacing:2px;text-transform:uppercase;}

/* Slots */
#slots{position:absolute;bottom:24px;right:8px;display:flex;flex-direction:column;gap:3px;z-index:10;pointer-events:none;}
.slot{display:flex;align-items:center;gap:5px;padding:3px 7px 3px 5px;border-radius:4px;backdrop-filter:blur(4px);}
.slot.wpn{background:rgba(13,15,20,0.75);border:1px solid var(--c-border);}
.slot.itm{background:rgba(13,15,20,0.65);border:1px solid rgba(45,212,191,0.2);}
.slot.evolved{background:rgba(20,8,0,0.8);border:1px solid rgba(249,115,22,0.4);box-shadow:0 0 8px rgba(249,115,22,0.15);}
.slot.armor-slot{background:rgba(13,15,20,0.75);border:1px solid rgba(100,200,255,0.3);}
.si{font-size:12px;line-height:1;}
.sn{font-family:'Rajdhani',sans-serif;font-size:9px;font-weight:600;color:var(--c-text2);letter-spacing:0.5px;}
.sn.item-name{color:var(--c-teal);}
.sn.evo-name{color:var(--c-evo2);}
.sn.armor-name{color:#88ccff;}
.slv{font-family:'Rajdhani',sans-serif;font-size:9px;font-weight:700;color:var(--c-text2);margin-left:auto;padding-left:6px;}
.slv.maxed{color:var(--c-gold);}

/* Hint - PC only */
#hint{position:absolute;bottom:8px;left:50%;transform:translateX(-50%);font-family:'Rajdhani',sans-serif;font-size:10px;font-weight:500;color:rgba(137,153,187,0.3);letter-spacing:2px;text-transform:uppercase;pointer-events:none;z-index:10;white-space:nowrap;}

/* Evo notif */
#evo-notif{position:absolute;top:52px;left:50%;transform:translateX(-50%);font-family:'Rajdhani',sans-serif;font-size:12px;font-weight:700;color:var(--c-evo2);letter-spacing:2px;text-transform:uppercase;background:rgba(20,10,0,0.88);border:1px solid rgba(249,115,22,0.4);border-radius:3px;padding:6px 16px;pointer-events:none;z-index:20;opacity:0;transition:opacity 0.25s ease;white-space:nowrap;}

/* Stage select */
#stage-select{z-index:100;}
.stage-grid{display:flex;gap:12px;flex-wrap:wrap;justify-content:center;max-width:680px;padding:0 16px;}
.stage-card{width:120px;background:var(--c-surface);border:1px solid var(--c-border2);border-radius:8px;padding:16px 10px 12px;cursor:pointer;transition:all 0.2s;text-align:center;position:relative;}
.stage-card.locked{opacity:0.4;cursor:not-allowed;filter:grayscale(1);}
.stage-card:not(.locked):hover{transform:translateY(-3px);border-color:var(--c-gold);box-shadow:0 8px 24px rgba(240,192,64,0.2);}
.stage-card .s-num{font-family:'Rajdhani',sans-serif;font-size:28px;font-weight:700;color:var(--c-gold);}
.stage-card .s-name{font-family:'Rajdhani',sans-serif;font-size:11px;font-weight:600;color:var(--c-text);margin:4px 0;letter-spacing:1px;}
.stage-card .s-diff{font-size:10px;color:var(--c-text2);margin-bottom:6px;}
.stage-card .s-clear{font-family:'Rajdhani',sans-serif;font-size:9px;font-weight:700;color:var(--c-green);letter-spacing:2px;}
.stage-card .s-lock{font-size:20px;position:absolute;top:8px;right:8px;}
.stage-card .s-coin{font-family:'Rajdhani',sans-serif;font-size:10px;color:var(--c-coin);margin-top:4px;}

/* Shop overlay */
#shopscreen{z-index:110;}
.shop-title{font-family:'Rajdhani',sans-serif;font-size:28px;font-weight:700;color:var(--c-gold);letter-spacing:6px;text-transform:uppercase;margin-bottom:4px;}
.shop-sub{font-family:'Rajdhani',sans-serif;font-size:11px;color:var(--c-text2);letter-spacing:3px;margin-bottom:6px;}
.coin-display{font-family:'Rajdhani',sans-serif;font-size:18px;font-weight:700;color:var(--c-coin);margin-bottom:16px;}
.shop-tabs{display:flex;gap:8px;margin-bottom:16px;}
.shop-tab{font-family:'Rajdhani',sans-serif;font-size:11px;font-weight:700;letter-spacing:2px;text-transform:uppercase;padding:6px 18px;border-radius:3px;cursor:pointer;border:1px solid var(--c-border2);color:var(--c-text2);background:var(--c-surface);transition:all 0.15s;}
.shop-tab.active{background:var(--c-gold);color:var(--c-bg);border-color:var(--c-gold);}
.shop-grid{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;max-width:720px;padding:0 12px;max-height:320px;overflow-y:auto;}
.shop-item{width:130px;background:var(--c-surface);border:1px solid var(--c-border2);border-radius:6px;padding:14px 10px 10px;cursor:pointer;transition:all 0.18s;text-align:center;position:relative;}
.shop-item:hover:not(.owned):not(.cant-afford){transform:translateY(-2px);border-color:var(--c-gold);box-shadow:0 6px 20px rgba(240,192,64,0.2);}
.shop-item.owned{border-color:var(--c-green);opacity:0.7;cursor:default;}
.shop-item.cant-afford{opacity:0.45;cursor:not-allowed;}
.shop-item .si2{font-size:28px;margin-bottom:8px;}
.shop-item .sn2{font-family:'Rajdhani',sans-serif;font-size:11px;font-weight:700;color:var(--c-text);margin-bottom:4px;}
.shop-item .sd2{font-size:9px;color:var(--c-text2);line-height:1.5;margin-bottom:6px;}
.shop-item .sp2{font-family:'Rajdhani',sans-serif;font-size:12px;font-weight:700;color:var(--c-coin);}
.shop-item .sp2.owned-lbl{color:var(--c-green);}
.shop-item.chest-item{border-color:rgba(249,115,22,0.4);background:rgba(20,10,0,0.6);}
.shop-item.chest-item:hover{border-color:var(--c-evo2);}

/* Stat pills */
.stat-row{display:flex;gap:12px;justify-content:center;margin-bottom:6px;}
.stat-pill{background:var(--c-surface2);border:1px solid var(--c-border2);border-radius:4px;padding:6px 14px;text-align:center;min-width:75px;}
.stat-pill .val{font-family:'Rajdhani',sans-serif;font-size:20px;font-weight:700;color:var(--c-text);display:block;line-height:1.2;}
.stat-pill .lbl{font-family:'Rajdhani',sans-serif;font-size:9px;font-weight:600;color:var(--c-text2);letter-spacing:1.5px;text-transform:uppercase;}
#rstats,#wstats{color:var(--c-text2);font-size:13px;line-height:2.2;text-align:center;margin:8px 0 20px;font-family:'Rajdhani',sans-serif;font-weight:500;letter-spacing:1px;}
.note{font-size:10px;color:rgba(137,153,187,0.45);display:block;margin-top:4px;}

@keyframes deathPulse{0%{opacity:1;transform:scale(1);}50%{opacity:0.7;transform:scale(1.04);}100%{opacity:1;transform:scale(1);}}

/* MOBILE JOYSTICK - only on touch/mobile */
#joystick-zone{display:none;position:absolute;left:0;top:0;right:0;bottom:0;z-index:30;pointer-events:none;}
#joystick-base{position:absolute;left:20px;bottom:20px;top:auto;width:100px;height:100px;border-radius:50%;background:rgba(255,255,255,0.04);border:1.5px solid rgba(255,255,255,0.10);pointer-events:none;}
#joystick-thumb{position:absolute;width:42px;height:42px;border-radius:50%;background:rgba(124,92,252,0.45);border:1.5px solid rgba(167,139,250,0.55);box-shadow:0 0 12px rgba(124,92,252,0.35);transform:translate(-50%,-50%);left:50%;top:50%;pointer-events:none;}

/* Only show joystick on actual touch devices */
@media (pointer:coarse){
  #joystick-zone{display:block;}
  #hint{display:none;}
  .bb{width:clamp(70px,16vw,130px);}
  .slot .sn,.slot .slv{font-size:8px;}
  #slots{bottom:20px;right:6px;}
}
/* PC: always hide joystick regardless of screen size */
@media (pointer:fine){
  #joystick-zone{display:none !important;}
}
</style>
</head>
<body>
<div id="gw">
  <canvas id="c"></canvas>

  <!-- HUD -->
  <div id="hud">
    <div class="hl">
      <div class="bw"><span class="bl">HP</span><div class="bb"><div id="hp" style="width:100%"></div></div></div>
      <div class="bw"><span class="bl" style="color:var(--c-xp2)">XP</span><div class="bb"><div id="xp" style="width:0%"></div></div></div>
      <div id="lvl">LV <span id="lvn">1</span></div>
    </div>
    <div style="text-align:center">
      <div id="stage-hud">STAGE <span id="stage-num">1</span></div>
      <div id="timer">15:00</div>
    </div>
    <div style="text-align:right">
      <div id="kills">KILL <span>0</span></div>
      <div id="coin-hud">ğŸª™ 0</div>
      <div style="margin-top:4px;pointer-events:auto;">
        <button id="snd-btn" onclick="toggleSound()" style="background:none;border:1px solid rgba(255,255,255,0.15);border-radius:4px;color:var(--c-text2);font-size:14px;padding:2px 7px;cursor:pointer;line-height:1.4;" title="ì†Œë¦¬ ì¼œê¸°/ë„ê¸°">ğŸ”Š</button>
      </div>
    </div>
  </div>

  <div id="slots"></div>
  <div id="hint">W A S D Â· ì´ë™ Â· ìë™ ê³µê²©</div>
  <div id="evo-notif"></div>

  <!-- Mobile joystick -->
  <div id="joystick-zone">
    <div id="joystick-base"><div id="joystick-thumb"></div></div>
  </div>

  <!-- â•â•â• OVERLAYS â•â•â• -->

  <!-- Start Screen -->
  <div class="ov" id="ss">
    <div class="ov-title" style="font-size:clamp(28px,8vw,42px);margin-bottom:4px;">ë‹¤í¬ ì„œë°”ì´ë²„</div>
    <div class="ov-sub">Dark Survivor</div>
    <div class="sep"></div>
    <button class="btn" onclick="showStageSelect()">ìŠ¤í…Œì´ì§€ ì„ íƒ</button>
    <div style="margin-top:14px;font-family:'Rajdhani',sans-serif;font-size:10px;font-weight:500;color:var(--c-text2);letter-spacing:2px;text-transform:uppercase;text-align:center;line-height:2;">
      15ë¶„ ìƒì¡´ Â· 5ë¶„ë§ˆë‹¤ ë³´ìŠ¤ Â· í´ë¦¬ì–´ ì‹œ ì½”ì¸ íšë“<br>
      <span style="color:var(--c-evo2)">ë§Œë ™+ì•„ì´í…œ â†’ ì§„í™”</span>
    </div>
  </div>

  <!-- Stage Select -->
  <div class="ov" id="stage-select" style="display:none">
    <div class="ov-title" style="font-size:clamp(22px,6vw,34px);">ìŠ¤í…Œì´ì§€ ì„ íƒ</div>
    <div style="font-family:'Rajdhani',sans-serif;font-size:12px;color:var(--c-coin);letter-spacing:2px;margin-bottom:20px;">ğŸª™ <span id="ss-coin">0</span> ì½”ì¸ ë³´ìœ </div>
    <div class="stage-grid" id="stage-grid"></div>
    <div class="sep"></div>
    <div style="display:flex;gap:10px;">
      <button class="btn btn-secondary" onclick="showShop()">ğŸ›’ ìƒì </button>
      <button class="btn btn-secondary" onclick="showOv('ss');hideOv('stage-select')">â† ë’¤ë¡œ</button>
    </div>
  </div>

  <!-- Shop -->
  <div class="ov" id="shopscreen" style="display:none">
    <div class="shop-title">âš”ï¸ ìƒì </div>
    <div class="shop-sub">ì½”ì¸ìœ¼ë¡œ ì¥ë¹„ì™€ ìƒìë¥¼ êµ¬ë§¤í•˜ì„¸ìš”</div>
    <div class="coin-display">ğŸª™ <span id="shop-coin">0</span></div>
    <div class="shop-tabs">
      <div class="shop-tab active" onclick="switchTab('chest')">ğŸ“¦ ìƒì</div>
      <div class="shop-tab" onclick="switchTab('weapon')">âš”ï¸ ë¬´ê¸°</div>
      <div class="shop-tab" onclick="switchTab('armor')">ğŸ›¡ï¸ ë°©ì–´êµ¬</div>
    </div>
    <div class="shop-grid" id="shop-grid"></div>
    <div class="sep"></div>
    <button class="btn btn-secondary" onclick="hideOv('shopscreen');showOv('stage-select')">â† ë’¤ë¡œ</button>
  </div>

  <!-- Chest Result -->
  <div class="ov" id="chest-result" style="display:none">
    <div class="ov-title" style="color:var(--c-evo2);font-size:clamp(20px,5vw,30px);">ğŸ“¦ ìƒì ê°œë´‰!</div>
    <div class="sep"></div>
    <div id="chest-items" style="display:flex;gap:16px;flex-wrap:wrap;justify-content:center;margin:10px 0 20px;"></div>
    <div class="sep"></div>
    <button class="btn" onclick="hideOv('chest-result');showOv('shopscreen')">í™•ì¸</button>
  </div>

  <!-- Level Up -->
  <div class="ov" id="luscreen" style="display:none">
    <div id="lu-title">ë ˆë²¨ ì—…</div>
    <div class="cards" id="cards"></div>
  </div>

  <!-- Stage Clear -->
  <div class="ov" id="clearscreen" style="display:none">
    <div style="font-family:'Rajdhani',sans-serif;font-size:clamp(32px,9vw,48px);font-weight:700;color:var(--c-gold);letter-spacing:6px;text-transform:uppercase;margin-bottom:4px;">í´ë¦¬ì–´!</div>
    <div style="font-family:'Rajdhani',sans-serif;font-size:11px;color:var(--c-text2);letter-spacing:4px;text-transform:uppercase;margin-bottom:20px;">Stage Clear</div>
    <div class="sep"></div>
    <div id="cstats"></div>
    <div id="coin-reward" style="font-family:'Rajdhani',sans-serif;font-size:22px;font-weight:700;color:var(--c-coin);margin:10px 0 20px;"></div>
    <div style="display:flex;gap:10px;">
      <button class="btn" onclick="gotoShopAfterClear()">ğŸ›’ ìƒì  ë°©ë¬¸</button>
      <button class="btn btn-secondary" onclick="gotoStageSelectAfterClear()">ìŠ¤í…Œì´ì§€ ì„ íƒ</button>
    </div>
  </div>

  <!-- Game Over -->
  <div class="ov" id="goscreen" style="display:none">
    <div style="font-family:'Rajdhani',sans-serif;font-size:clamp(36px,10vw,52px);font-weight:700;color:var(--c-hp);letter-spacing:6px;text-transform:uppercase;animation:deathPulse 1s ease infinite;margin-bottom:4px;">ì‚¬ë§</div>
    <div style="font-family:'Rajdhani',sans-serif;font-size:11px;color:var(--c-text2);letter-spacing:4px;text-transform:uppercase;margin-bottom:20px;">You Died</div>
    <div class="sep"></div>
    <div id="rstats"></div>
    <div style="display:flex;gap:10px;">
      <button class="btn" onclick="retryStage()">ë‹¤ì‹œ ë„ì „</button>
      <button class="btn btn-secondary" onclick="gotoStageSelectDead()">ìŠ¤í…Œì´ì§€ ì„ íƒ</button>
    </div>
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CANVAS SETUP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const canvas = document.getElementById('c');
const ctx = canvas.getContext('2d');
const W = 800, H = 560;

let state = 'start';
let keys = {};
let gameTime = 0;
let kills = 0;
let lastTime = 0;
let animId;
let cam = {x:0, y:0};
let player;
let enemies = [], projectiles = [], xpGems = [], dmgNums = [], particles = [];
let orbBurstQueue = [], orbBurstTimer = 0, spawnTimer = 0;
let nextBossTime = 300, bossWarningTimer = 0, activeBoss = null;
let currentStage = 1;
let isBossPhase = false;
let floorItems = [];
let floorItemSpawnTimer = 0;
const MAX_WEAPONS   = 5;
const MAX_ABILITIES = 5;
const FLOOR_ITEM_TYPES = {
  coin:    {icon:'ğŸª™',color:'#FFD700',r:8, label:'ì½”ì¸',   desc:'+20 ì½”ì¸'},
  magnet:  {icon:'ğŸ§²',color:'#4488FF',r:9, label:'ìì„',   desc:'XP ì „ë¶€ í¡ìˆ˜'},
  bomb:    {icon:'ğŸ’£',color:'#FF4422',r:9, label:'í­íƒ„',   desc:'í™”ë©´ ì  ì „ë©¸(ë³´ìŠ¤ ì œì™¸)'},
  chicken: {icon:'ğŸ—',color:'#FFAA44',r:8, label:'ë‹­ë‹¤ë¦¬', desc:'HP +40 íšŒë³µ'},
  poison:  {icon:'â˜ ï¸',color:'#AA44FF',r:8, label:'ë…ì•½',   desc:'HP -30'},
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PERSISTENT SAVE DATA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let saveData = {
  coins: 0,
  clearedStages: [],          // which stages beaten
  ownedEquip: [],             // equipment ids owned
  activeEquip: {weapon:null, armor:null}, // equipped
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STAGE DEFINITIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const STAGES = [
  {id:1, name:'ì €ì£¼ë°›ì€ ìˆ²',    emoji:'ğŸŒ²', diff:'â­',         coinReward:80,  diffMul:1.0, bg:'forest',
   desc:'ê¸°ì´ˆì ì¸ ì–¸ë°ë“œë“¤ì´ ì¶œëª°í•œë‹¤'},
  {id:2, name:'ì–´ë‘ ì˜ ë™êµ´',   emoji:'ğŸ—¿', diff:'â­â­',        coinReward:140, diffMul:1.4, bg:'cave',
   desc:'ë™êµ´ ê¹Šì€ ê³³ì˜ ê°•ë ¥í•œ ë§ˆë¬¼ë“¤'},
  {id:3, name:'í™”ì—¼ ì§€ì˜¥',     emoji:'ğŸ”¥', diff:'â­â­â­',      coinReward:200, diffMul:1.9, bg:'hell',
   desc:'ë¶ˆê½ƒìœ¼ë¡œ ë’¤ë®ì¸ ì§€ì˜¥ì˜ ê²½ê³„'},
  {id:4, name:'ê³µí—ˆì˜ í‹ˆìƒˆ',   emoji:'ğŸŒ€', diff:'â­â­â­â­',    coinReward:280, diffMul:2.6, bg:'void',
   desc:'í˜„ì‹¤ì´ ë¶•ê´´ëœ ê³µê°„, ìµœê°•ì˜ ì ë“¤'},
  {id:5, name:'ì•”í‘ì‹ ì˜ ê¶ì „', emoji:'âš«', diff:'â­â­â­â­â­', coinReward:400, diffMul:3.5, bg:'palace',
   desc:'ì•”í‘ì‹ ì´ ê¸°ë‹¤ë¦¬ëŠ” ìµœí›„ì˜ ì „ì¥'},
];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  EQUIPMENT (Shop items)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const SHOP_WEAPONS = [
  {id:'sw_thunder_rod', name:'ë‡Œì „ ì§€íŒ¡ì´', icon:'âš¡', type:'weapon', cost:120,
   desc:'ë‚™ë¢° ì¿¨íƒ€ì„ -20%, ê³µê²©ë ¥ +15%', bonus:{cdr:0.20, dmg:0.15}, startWeapon:'bolt'},
  {id:'sw_shadow_blade', name:'ê·¸ë¦¼ì ê²€', icon:'ğŸ—¡ï¸', type:'weapon', cost:150,
   desc:'íšŒì „ ê²€ 2ê°œ ì¶”ê°€, ê³µê²©ë ¥ +10%', bonus:{bladeCnt:2, dmg:0.10}, startWeapon:'blade'},
  {id:'sw_arcane_staff', name:'ë¹„ì „ ì§€íŒ¡ì´', icon:'ğŸª„', type:'weapon', cost:180,
   desc:'ë§ˆë²• êµ¬ì²´ +2ê°œ ì¶”ê°€ ë°œì‚¬, ê³µê²©ë ¥ +20%', bonus:{orbExtra:2, dmg:0.20}},
  {id:'sw_frost_lance', name:'ì„œë¦¬ ì°½', icon:'ğŸ”ï¸', type:'weapon', cost:160,
   desc:'ë¹™ê²° ì°½ ì‹œì‘, ì¿¨íƒ€ì„ -15%', bonus:{cdr:0.15}, startWeapon:'ice'},
  {id:'sw_infernal_axe', name:'ì§€ì˜¥ ë„ë¼', icon:'ğŸ”¥', type:'weapon', cost:200,
   desc:'ë„ë¼ ì‹œì‘, ê³µê²©ë ¥ +25%', bonus:{dmg:0.25}, startWeapon:'axe'},
];

const SHOP_ARMORS = [
  {id:'sa_iron_vest', name:'ì² ì œ ì¡°ë¼', icon:'ğŸ›¡ï¸', type:'armor', cost:80,
   desc:'ìµœëŒ€ HP +80', bonus:{hp:80}},
  {id:'sa_shadow_cloak', name:'ê·¸ë¦¼ì ë§í† ', icon:'ğŸŒ‘', type:'armor', cost:100,
   desc:'ì´ë™ì†ë„ +20%', bonus:{spd:0.20}},
  {id:'sa_rune_plate', name:'ë£¬ ê°‘ì˜·', icon:'ğŸ”¯', type:'armor', cost:130,
   desc:'ìµœëŒ€ HP +50, ì¿¨íƒ€ì„ -10%', bonus:{hp:50, cdr:0.10}},
  {id:'sa_dragon_scale', name:'ìš©ë¦° ê°‘ì˜·', icon:'ğŸ‰', type:'armor', cost:180,
   desc:'ìµœëŒ€ HP +120, ê³µê²©ë ¥ +10%', bonus:{hp:120, dmg:0.10}},
  {id:'sa_void_armor', name:'ê³µí—ˆ ê°‘ì˜·', icon:'ğŸŒ€', type:'armor', cost:240,
   desc:'ìµœëŒ€ HP +80, ì´ë™ì†ë„ +15%, ì¿¨íƒ€ì„ -15%', bonus:{hp:80, spd:0.15, cdr:0.15}},
];

const CHESTS = [
  {id:'chest_wooden', name:'ë‚˜ë¬´ ìƒì', icon:'ğŸ“¦', type:'chest', cost:60,
   desc:'ë¬´ì‘ìœ„ ì¥ë¹„ 1ê°œ / ì½”ì¸ 20~50', rarity:'common'},
  {id:'chest_iron', name:'ì² ì œ ìƒì', icon:'ğŸ—³ï¸', type:'chest', cost:120,
   desc:'ë¬´ì‘ìœ„ ì¥ë¹„ 2ê°œ / ì½”ì¸ 40~100', rarity:'rare'},
  {id:'chest_gold', name:'í™©ê¸ˆ ìƒì', icon:'ğŸ’°', type:'chest', cost:220,
   desc:'í¬ê·€ ì¥ë¹„ 2ê°œ + ì½”ì¸ 80~200', rarity:'epic'},
];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  WEAPON DATA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const WEAPON_DATA = {
  orb:    {name:'ë§ˆë²• êµ¬ì²´',   icon:'ğŸ”®', maxLv:5, cdBase:1.2,  dmgBase:25,  spdBase:220, desc:l=>`êµ¬ì²´ ${1+l}ê°œ ì—°ì† ë°œì‚¬ Â· í”¼í•´ ${25+l*10}`},
  axe:    {name:'ë„ë¼',       icon:'ğŸª“', maxLv:5, cdBase:2.0,  dmgBase:50,  spdBase:180, desc:l=>`í¬ë¬¼ì„  ${1+Math.floor(l/2)}ê°œ Â· í”¼í•´ ${50+l*20}`},
  aura:   {name:'ì–´ë‘  ì˜¤ë¼',  icon:'ğŸŒ‘', maxLv:5, cdBase:0.5,  dmgBase:15,  spdBase:0,   desc:l=>`ë²”ìœ„ ${80+l*20}px Â· í”¼í•´ ${15+l*8}`},
  cross:  {name:'ì„±ì‹­ìê°€',   icon:'âœï¸', maxLv:5, cdBase:2.5,  dmgBase:80,  spdBase:200, desc:l=>`4ë°©í–¥ Â· í”¼í•´ ${80+l*25}`},
  bolt:   {name:'ë‚™ë¢°',       icon:'âš¡', maxLv:5, cdBase:1.0,  dmgBase:60,  spdBase:0,   desc:l=>`ëœë¤ ì  ${1+l}ëª… Â· í”¼í•´ ${60+l*20}`},
  nova:   {name:'ë¶ˆê½ƒ í­ë°œ',  icon:'ğŸ’¥', maxLv:5, cdBase:3.0,  dmgBase:120, spdBase:0,   desc:l=>`ë²”ìœ„ ${100+l*30}px Â· í”¼í•´ ${120+l*40}`},
  blade:  {name:'íšŒì „ ê²€',    icon:'âš”ï¸', maxLv:5, cdBase:0.1,  dmgBase:20,  spdBase:0,   desc:l=>`${2+l}ê°œ ê³µì „ Â· í”¼í•´ ${20+l*8}`},
  arrow:  {name:'ë§ˆë²• í™”ì‚´',  icon:'ğŸ¹', maxLv:5, cdBase:0.6,  dmgBase:30,  spdBase:400, desc:l=>`í™”ì‚´ ${1+Math.floor(l/2)}ë°œ Â· í”¼í•´ ${30+l*12}`},
  ice:    {name:'ë¹™ê²° ì°½',    icon:'ğŸ§Š', maxLv:5, cdBase:1.8,  dmgBase:60,  spdBase:260, desc:l=>`ë¹™ê²° ${l}ì´ˆ Â· í”¼í•´ ${60+l*18}`},
  whip:   {name:'ì±„ì°',       icon:'ğŸª¶', maxLv:5, cdBase:1.0,  dmgBase:45,  spdBase:0,   desc:l=>`ë²”ìœ„ ${120+l*20}px Â· í”¼í•´ ${45+l*15}`},
  meteor: {name:'ìš´ì„ ì†Œí™˜',  icon:'â˜„ï¸', maxLv:1, cdBase:1.2,  dmgBase:0, spdBase:0, evolved:true, desc:()=>'ìš´ì„ì´ ìŸì•„ì§„ë‹¤'},
  storm:  {name:'í­í’ ì˜¤ë¼',  icon:'ğŸŒªï¸', maxLv:1, cdBase:0.25, dmgBase:0, spdBase:0, evolved:true, desc:()=>'ë„“ì€ í­í’ ì˜¤ë¼'},
  divine: {name:'ì‹ ì„± ì‹­ì',  icon:'ğŸŒŸ', maxLv:1, cdBase:1.6,  dmgBase:0, spdBase:0, evolved:true, desc:()=>'8ë°©í–¥ ì‹ ì„±í•œ ë¹›'},
  thunder:{name:'ë‡Œê²©',       icon:'ğŸŒ©ï¸', maxLv:1, cdBase:0.35, dmgBase:0, spdBase:0, evolved:true, desc:()=>'ì „ì²´ ë²ˆê°œ ë‚œì‚¬'},
  inferno:{name:'ì§€ì˜¥ë¶ˆ',     icon:'ğŸ”¥', maxLv:1, cdBase:1.8,  dmgBase:0, spdBase:0, evolved:true, desc:()=>'ê±°ëŒ€ ì§€ì† í­ë°œ'},
  phantom:{name:'ìœ ë ¹ ê²€ê¸°',  icon:'ğŸ‘»', maxLv:1, cdBase:0.07, dmgBase:0, spdBase:0, evolved:true, desc:()=>'ìœ ë ¹ì´ ê³µì „'},
  tempest:{name:'í­í’ í™”ì‚´',  icon:'ğŸŒ¬ï¸', maxLv:1, cdBase:0.3,  dmgBase:0, spdBase:0, evolved:true, desc:()=>'í™”ì‚´ í­í’ ë‚œì‚¬'},
  glacier:{name:'ë¹™í•˜ í­ë°œ',  icon:'â„ï¸', maxLv:1, cdBase:2.0,  dmgBase:0, spdBase:0, evolved:true, desc:()=>'í™”ë©´ ì „ì²´ ë¹™ê²°'},
  cyclone:{name:'íšŒì˜¤ë¦¬ ì±„ì°',icon:'ğŸŒ€', maxLv:1, cdBase:0.7,  dmgBase:0, spdBase:0, evolved:true, desc:()=>'ê±°ëŒ€ íšŒì˜¤ë¦¬'},
};

const ACC_DATA = {
  grimoire:  {name:'ë§ˆë²•ì„œ',        icon:'ğŸ“–', desc:'ë§ˆë²• êµ¬ì²´ ì§„í™” Â· ì¿¨íƒ€ì„ -8%',        passive:{cdr:0.08}},
  whetstone: {name:'ìˆ«ëŒ',          icon:'ğŸª¨', desc:'ë„ë¼ ì§„í™” Â· ê³µê²©ë ¥ +12%',             passive:{dmg:0.12}},
  rune:      {name:'ì–´ë‘ ì˜ ë£¬',     icon:'ğŸ”¯', desc:'ì˜¤ë¼ ì§„í™” Â· ê³µê²©ë ¥ +10% Â· ì¿¨íƒ€ì„ -5%', passive:{dmg:0.10, cdr:0.05}},
  halo:      {name:'ì„±ìŠ¤ëŸ¬ìš´ í›„ê´‘', icon:'ğŸ˜‡', desc:'ì‹­ìê°€ ì§„í™” Â· ìµœëŒ€ HP +30',           passive:{hp:30}},
  capacitor: {name:'ì¶•ì „ê¸°',        icon:'ğŸ”‹', desc:'ë‚™ë¢° ì§„í™” Â· ì¿¨íƒ€ì„ -12%',             passive:{cdr:0.12}},
  magma:     {name:'ë§ˆê·¸ë§ˆ ì„',     icon:'ğŸŒ‹', desc:'ë¶ˆê½ƒ í­ë°œ ì§„í™” Â· ê³µê²©ë ¥ +15%',        passive:{dmg:0.15}},
  crystal:   {name:'ìˆ˜ì • íŒŒí¸',     icon:'ğŸ’', desc:'íšŒì „ ê²€ ì§„í™” Â· ì´ë™ì†ë„ +8%',         passive:{spd:0.08}},
  quiver:    {name:'ë§ˆë²• í™”ì‚´í†µ',   icon:'ğŸª„', desc:'ë§ˆë²• í™”ì‚´ ì§„í™” Â· ì¿¨íƒ€ì„ -10%',        passive:{cdr:0.10}},
  permafrost:{name:'ì˜êµ¬ ë™ê²°ì„',   icon:'ğŸ§Š', desc:'ë¹™ê²° ì°½ ì§„í™” Â· ìˆ˜ì§‘ ë²”ìœ„ +25',        passive:{pickup:25}},
  tornado:   {name:'í† ë„¤ì´ë„ ì„',   icon:'ğŸŒªï¸', desc:'ì±„ì° ì§„í™” Â· ì´ë™ì†ë„ +8%',            passive:{spd:0.08}},
};

const EVO_RECIPES = [
  {weapon:'orb',   acc:'grimoire',   result:'meteor',  name:'ìš´ì„ ì†Œí™˜', icon:'â˜„ï¸'},
  {weapon:'axe',   acc:'whetstone',  result:'storm',   name:'í­í’ ì˜¤ë¼', icon:'ğŸŒªï¸'},
  {weapon:'aura',  acc:'rune',       result:'storm',   name:'í­í’ ì˜¤ë¼', icon:'ğŸŒªï¸'},
  {weapon:'cross', acc:'halo',       result:'divine',  name:'ì‹ ì„± ì‹­ì', icon:'ğŸŒŸ'},
  {weapon:'bolt',  acc:'capacitor',  result:'thunder', name:'ë‡Œê²©',      icon:'ğŸŒ©ï¸'},
  {weapon:'nova',  acc:'magma',      result:'inferno', name:'ì§€ì˜¥ë¶ˆ',    icon:'ğŸ”¥'},
  {weapon:'blade', acc:'crystal',    result:'phantom', name:'ìœ ë ¹ ê²€ê¸°', icon:'ğŸ‘»'},
  {weapon:'arrow', acc:'quiver',     result:'tempest', name:'í­í’ í™”ì‚´', icon:'ğŸŒ¬ï¸'},
  {weapon:'ice',   acc:'permafrost', result:'glacier', name:'ë¹™í•˜ í­ë°œ', icon:'â„ï¸'},
  {weapon:'whip',  acc:'tornado',    result:'cyclone', name:'íšŒì˜¤ë¦¬ ì±„ì°',icon:'ğŸŒ€'},
];

const UPGRADES = [
  {id:'orb',weapon:true,name:'ë§ˆë²• êµ¬ì²´',icon:'ğŸ”®'},
  {id:'axe',weapon:true,name:'ë„ë¼',icon:'ğŸª“'},
  {id:'aura',weapon:true,name:'ì–´ë‘  ì˜¤ë¼',icon:'ğŸŒ‘'},
  {id:'cross',weapon:true,name:'ì„±ì‹­ìê°€',icon:'âœï¸'},
  {id:'bolt',weapon:true,name:'ë‚™ë¢°',icon:'âš¡'},
  {id:'nova',weapon:true,name:'ë¶ˆê½ƒ í­ë°œ',icon:'ğŸ’¥'},
  {id:'blade',weapon:true,name:'íšŒì „ ê²€',icon:'âš”ï¸'},
  {id:'arrow',weapon:true,name:'ë§ˆë²• í™”ì‚´',icon:'ğŸ¹'},
  {id:'ice',weapon:true,name:'ë¹™ê²° ì°½',icon:'ğŸ§Š'},
  {id:'whip',weapon:true,name:'ì±„ì°',icon:'ğŸª¶'},
  {id:'grimoire',accessory:true,name:'ë§ˆë²•ì„œ',icon:'ğŸ“–'},
  {id:'whetstone',accessory:true,name:'ìˆ«ëŒ',icon:'ğŸª¨'},
  {id:'rune',accessory:true,name:'ì–´ë‘ ì˜ ë£¬',icon:'ğŸ”¯'},
  {id:'halo',accessory:true,name:'ì„±ìŠ¤ëŸ¬ìš´ í›„ê´‘',icon:'ğŸ˜‡'},
  {id:'capacitor',accessory:true,name:'ì¶•ì „ê¸°',icon:'ğŸ”‹'},
  {id:'magma',accessory:true,name:'ë§ˆê·¸ë§ˆ ì„',icon:'ğŸŒ‹'},
  {id:'crystal',accessory:true,name:'ìˆ˜ì • íŒŒí¸',icon:'ğŸ’'},
  {id:'quiver',accessory:true,name:'ë§ˆë²• í™”ì‚´í†µ',icon:'ğŸª„'},
  {id:'permafrost',accessory:true,name:'ì˜êµ¬ ë™ê²°ì„',icon:'ğŸ§Š'},
  {id:'tornado',accessory:true,name:'í† ë„¤ì´ë„ ì„',icon:'ğŸŒªï¸'},
  {id:'maxhp',name:'ìƒëª…ë ¥ ê°•í™”',icon:'â¤ï¸'},
  {id:'speed',name:'ì´ë™ ì†ë„',icon:'ğŸ’¨'},
  {id:'pickup',name:'ìˆ˜ì§‘ ë²”ìœ„',icon:'âœ¨'},
  {id:'heal',name:'ì¦‰ì‹œ íšŒë³µ',icon:'ğŸ’‰'},
  {id:'dmgup',name:'ê³µê²©ë ¥ ê°•í™”',icon:'âš”ï¸'},
  {id:'cdr',name:'ì¿¨íƒ€ì„ ê°ì†Œ',icon:'â±ï¸'},
];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ENEMY TYPES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const ENEMY_TYPES = [
  {name:'zombie',   color:'#3A7A3A', size:14, hp:30,  spd:60,  xp:5,  dmg:8,  shape:'circle'},
  {name:'bat',      color:'#8A5AAA', size:10, hp:15,  spd:110, xp:3,  dmg:5,  shape:'tri'},
  {name:'skeleton', color:'#C8C8A8', size:13, hp:50,  spd:50,  xp:8,  dmg:12, shape:'circle'},
  {name:'ghost',    color:'#7AA8D8', size:16, hp:25,  spd:80,  xp:6,  dmg:10, shape:'blob', alpha:0.65},
  {name:'werewolf', color:'#8B6A3A', size:18, hp:120, spd:90,  xp:20, dmg:20, shape:'circle'},
  {name:'demon',    color:'#CC2200', size:20, hp:200, spd:70,  xp:35, dmg:30, shape:'circle'},
  {name:'golem',    color:'#6688AA', size:24, hp:400, spd:40,  xp:50, dmg:40, shape:'circle'},
  // High-tier enemies for later stages
  {name:'hellhound',color:'#FF4400', size:16, hp:180, spd:110, xp:30, dmg:28, shape:'circle'},
  {name:'wraith',   color:'#AA44FF', size:18, hp:300, spd:85,  xp:45, dmg:38, shape:'blob', alpha:0.7},
  {name:'voidling', color:'#224466', size:20, hp:500, spd:70,  xp:60, dmg:50, shape:'blob', alpha:0.8},
];

const BOSS_TYPES = [
  {name:'ë¦¬ì¹˜',    icon:'ğŸ’€', color:'#9B59B6', size:36, hp:2000,  spd:55, xp:200, dmg:35, shape:'circle'},
  {name:'ë“œë˜ê³¤',  icon:'ğŸ‰', color:'#E74C3C', size:44, hp:4000,  spd:48, xp:350, dmg:50, shape:'circle'},
  {name:'ì•…ë§ˆì™•',  icon:'ğŸ‘¹', color:'#C0392B', size:40, hp:6000,  spd:60, xp:500, dmg:65, shape:'circle'},
  {name:'ê³µí—ˆì‹ ',  icon:'ğŸŒ‘', color:'#2C3E50', size:50, hp:10000, spd:52, xp:800, dmg:80, shape:'blob', alpha:0.85},
  {name:'ì‹¬ì—°',    icon:'ğŸ•³ï¸', color:'#1A1A2E', size:56, hp:16000, spd:58, xp:1200,dmg:100,shape:'blob', alpha:0.9},
  {name:'ì•”í‘ì‹ ',  icon:'âš«', color:'#0D0D0D', size:62, hp:25000, spd:64, xp:2000,dmg:130,shape:'circle'},
];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STAGE BACKGROUND THEMES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const BG_THEMES = {
  forest: {base:'#0a1208', grid1:'rgba(20,60,20,0.6)', grid2:'rgba(30,80,30,0.03)', vignette:['rgba(0,20,0,0)','rgba(0,0,0,0.6)']},
  cave:   {base:'#0e0c10', grid1:'rgba(60,40,80,0.5)', grid2:'rgba(80,60,100,0.03)', vignette:['rgba(30,0,40,0.04)','rgba(0,0,0,0.65)']},
  hell:   {base:'#150504', grid1:'rgba(100,20,10,0.5)', grid2:'rgba(180,40,10,0.04)', vignette:['rgba(60,0,0,0.06)','rgba(0,0,0,0.6)']},
  void:   {base:'#050510', grid1:'rgba(20,20,100,0.5)', grid2:'rgba(40,40,200,0.04)', vignette:['rgba(0,0,60,0.08)','rgba(0,0,0,0.7)']},
  palace: {base:'#0a0a0a', grid1:'rgba(80,0,80,0.5)', grid2:'rgba(120,0,120,0.05)', vignette:['rgba(40,0,40,0.1)','rgba(0,0,0,0.75)']},
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  OVERLAY HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showOv(id){ document.getElementById(id).style.display='flex'; }
function hideOv(id){ document.getElementById(id).style.display='none'; }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STAGE SELECT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showStageSelect(){
  hideOv('ss');
  renderStageGrid();
  document.getElementById('ss-coin').textContent = saveData.coins;
  showOv('stage-select');
}

function renderStageGrid(){
  const grid = document.getElementById('stage-grid');
  grid.innerHTML = '';
  STAGES.forEach(s=>{
    const cleared = saveData.clearedStages.includes(s.id);
    const locked  = s.id > 1 && !saveData.clearedStages.includes(s.id-1);
    const d = document.createElement('div');
    d.className = 'stage-card' + (locked?' locked':'');
    d.innerHTML = `
      <div style="font-size:28px;margin-bottom:6px;">${s.emoji}</div>
      <div class="s-num">${s.id}</div>
      <div class="s-name">${s.name}</div>
      <div class="s-diff">${s.diff}</div>
      <div class="s-coin">ğŸª™ ${s.coinReward} ì½”ì¸</div>
      ${cleared?'<div class="s-clear" style="margin-top:6px;">âœ“ í´ë¦¬ì–´</div>':''}
      ${locked?'<div class="s-lock">ğŸ”’</div>':''}
    `;
    if(!locked) d.onclick = ()=>{ hideOv('stage-select'); launchStage(s.id); };
    grid.appendChild(d);
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SHOP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let currentShopTab = 'chest';

function showShop(){
  hideOv('stage-select');
  document.getElementById('shop-coin').textContent = saveData.coins;
  renderShopGrid(currentShopTab);
  showOv('shopscreen');
}

function switchTab(tab){
  currentShopTab = tab;
  document.querySelectorAll('.shop-tab').forEach((el,i)=>{
    el.classList.toggle('active', ['chest','weapon','armor'][i]===tab);
  });
  document.getElementById('shop-coin').textContent = saveData.coins;
  renderShopGrid(tab);
}

function renderShopGrid(tab){
  const grid = document.getElementById('shop-grid');
  grid.innerHTML = '';
  let items = tab==='chest' ? CHESTS : tab==='weapon' ? SHOP_WEAPONS : SHOP_ARMORS;
  items.forEach(item=>{
    const owned   = saveData.ownedEquip.includes(item.id);
    const afford  = saveData.coins >= item.cost;
    const d = document.createElement('div');
    d.className = 'shop-item' + (item.type==='chest'?' chest-item':'') + (owned&&item.type!=='chest'?' owned':'') + (!afford&&!owned?' cant-afford':'');
    d.innerHTML = `
      <div class="si2">${item.icon}</div>
      <div class="sn2">${item.name}</div>
      <div class="sd2">${item.desc}</div>
      <div class="sp2 ${owned&&item.type!=='chest'?'owned-lbl':''}">${owned&&item.type!=='chest'?'ë³´ìœ ì¤‘':'ğŸª™ '+item.cost}</div>
    `;
    if((!owned || item.type==='chest') && afford){
      d.onclick = ()=> buyItem(item);
    }
    grid.appendChild(d);
  });
}

function buyItem(item){
  if(saveData.coins < item.cost) return;
  saveData.coins -= item.cost;
  document.getElementById('shop-coin').textContent = saveData.coins;
  if(item.type === 'chest'){
    SFX.chestOpen();
    openChest(item);
  } else {
    saveData.ownedEquip.push(item.id);
    SFX.buyItem();
    renderShopGrid(currentShopTab);
    showNotif(`${item.icon} ${item.name} êµ¬ë§¤!`, '#4ade80');
  }
}

function openChest(chest){
  hideOv('shopscreen');
  const rewards = [];
  const allEquip = [...SHOP_WEAPONS, ...SHOP_ARMORS].filter(e=>!saveData.ownedEquip.includes(e.id));
  const shuffle = arr=>[...arr].sort(()=>Math.random()-0.5);

  if(chest.id==='chest_wooden'){
    // 1 random equip OR coin bonus
    if(allEquip.length>0 && Math.random()<0.6){
      const item = shuffle(allEquip)[0];
      saveData.ownedEquip.push(item.id);
      rewards.push({icon:item.icon, name:item.name, desc:'ì¥ë¹„ íšë“!'});
    } else {
      const bonus = 20+Math.floor(Math.random()*31);
      saveData.coins += bonus;
      rewards.push({icon:'ğŸª™', name:`${bonus} ì½”ì¸`, desc:'ì½”ì¸ íšë“!'});
    }
  } else if(chest.id==='chest_iron'){
    // 2 rewards
    for(let i=0;i<2;i++){
      const rem = [...SHOP_WEAPONS,...SHOP_ARMORS].filter(e=>!saveData.ownedEquip.includes(e.id));
      if(rem.length>0 && Math.random()<0.65){
        const item = shuffle(rem)[0];
        saveData.ownedEquip.push(item.id);
        rewards.push({icon:item.icon, name:item.name, desc:'ì¥ë¹„ íšë“!'});
      } else {
        const bonus = 40+Math.floor(Math.random()*61);
        saveData.coins += bonus;
        rewards.push({icon:'ğŸª™', name:`${bonus} ì½”ì¸`, desc:'ì½”ì¸ íšë“!'});
      }
    }
  } else if(chest.id==='chest_gold'){
    // 2 equip + coins (prefer armors/weapons not owned)
    const rem = [...SHOP_WEAPONS,...SHOP_ARMORS].filter(e=>!saveData.ownedEquip.includes(e.id));
    const picks = shuffle(rem).slice(0,2);
    picks.forEach(item=>{
      saveData.ownedEquip.push(item.id);
      rewards.push({icon:item.icon, name:item.name, desc:'í¬ê·€ ì¥ë¹„!'});
    });
    const bonus = 80+Math.floor(Math.random()*121);
    saveData.coins += bonus;
    rewards.push({icon:'ğŸª™', name:`${bonus} ì½”ì¸`, desc:'ì½”ì¸ ë³´ë„ˆìŠ¤!'});
  }

  // Render result
  const container = document.getElementById('chest-items');
  container.innerHTML = '';
  rewards.forEach(r=>{
    const d = document.createElement('div');
    d.style.cssText='text-align:center;background:var(--c-surface);border:1px solid var(--c-border2);border-radius:8px;padding:16px 20px;';
    d.innerHTML=`<div style="font-size:36px;margin-bottom:8px;">${r.icon}</div>
      <div style="font-family:Rajdhani,sans-serif;font-weight:700;color:var(--c-text);font-size:13px;">${r.name}</div>
      <div style="font-family:Rajdhani,sans-serif;color:var(--c-gold);font-size:10px;margin-top:4px;">${r.desc}</div>`;
    container.appendChild(d);
  });
  showOv('chest-result');
}

function showNotif(msg, color='#fb923c'){
  const el = document.getElementById('evo-notif');
  el.textContent = msg;
  el.style.color = color;
  el.style.opacity = '1';
  setTimeout(()=>{ el.style.opacity='0'; el.style.color=''; }, 2500);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  LAUNCH STAGE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function launchStage(stageId){
  currentStage = stageId;
  const stg = STAGES[stageId-1];
  state = 'playing';
  initPlayer(stg);
  enemies=[];projectiles=[];xpGems=[];dmgNums=[];particles=[];
  orbBurstQueue=[];orbBurstTimer=0;spawnTimer=0;
  kills=0; gameTime=0; lastTime=0;
  nextBossTime=300; bossWarningTimer=0; activeBoss=null;
  isBossPhase=false; floorItems=[]; floorItemSpawnTimer=15;

  document.getElementById('stage-num').textContent = stageId;
  updateSlots();
  lastTime = performance.now();
  cancelAnimationFrame(animId);
  gameLoop(performance.now());
}

function retryStage(){ hideOv('goscreen'); launchStage(currentStage); }

function gotoStageSelectAfterClear(){
  hideOv('clearscreen');
  renderStageGrid();
  document.getElementById('ss-coin').textContent = saveData.coins;
  showOv('stage-select');
}
function gotoStageSelectDead(){
  hideOv('goscreen');
  renderStageGrid();
  document.getElementById('ss-coin').textContent = saveData.coins;
  showOv('stage-select');
}
function gotoShopAfterClear(){
  hideOv('clearscreen');
  document.getElementById('shop-coin').textContent = saveData.coins;
  renderShopGrid(currentShopTab);
  showOv('shopscreen');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PLAYER INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initPlayer(stg){
  const stageMul = stg.diffMul;
  player = {
    x:0, y:0, hp:100, maxHp:100, spd:130,
    xp:0, xpNext:30, level:1,
    weapons:{}, weaponCooldowns:{},
    accessories:{},
    pickupRange:70, invincible:0, facing:1,
    blades:[],
    dmgMul:1.0, cdrMul:1.0,
    stageMul, // enemy scaling reference
  };
  // Apply owned equipment bonuses
  saveData.ownedEquip.forEach(eid=>{
    const equip = [...SHOP_WEAPONS, ...SHOP_ARMORS].find(e=>e.id===eid);
    if(!equip) return;
    const b = equip.bonus;
    if(b.cdr)  player.cdrMul  = Math.max(0.2, player.cdrMul - b.cdr);
    if(b.dmg)  player.dmgMul += b.dmg;
    if(b.hp)   { player.maxHp += b.hp; player.hp = player.maxHp; }
    if(b.spd)  player.spd *= (1+b.spd);
    if(b.pickup) player.pickupRange += b.pickup;
    if(b.orbExtra) player._orbExtra = (player._orbExtra||0)+b.orbExtra;
    if(b.bladeCnt) player._bladeExtra = (player._bladeExtra||0)+b.bladeCnt;
    // Start weapon from equip
    if(equip.startWeapon && !player.weapons[equip.startWeapon]){
      player.weapons[equip.startWeapon] = 1;
      player.weaponCooldowns[equip.startWeapon] = 0;
    }
  });
  // Always start with orb if no weapon
  if(!Object.keys(player.weapons).length){
    player.weapons = {orb:1};
    player.weaponCooldowns = {orb:0};
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STAGE ENEMY POOLS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function getSpawnRate(){
  if(gameTime<60) return 1.4; if(gameTime<120) return 0.95;
  if(gameTime<300) return 0.65; if(gameTime<600) return 0.45;
  return 0.30;
}

function getEnemyPool(){
  const s = currentStage;
  if(s===1){
    if(gameTime<60)  return [0,0,0,1];
    if(gameTime<300) return [0,0,1,1,2];
    return [0,1,1,2,3];
  } else if(s===2){
    if(gameTime<60)  return [0,1,1,2];
    if(gameTime<300) return [1,2,2,3];
    return [1,2,3,4,7];
  } else if(s===3){
    if(gameTime<60)  return [2,3,4,7];
    if(gameTime<300) return [3,4,5,7];
    return [4,5,6,7,7];
  } else if(s===4){
    if(gameTime<60)  return [4,5,6,8];
    if(gameTime<300) return [5,6,8,8,9];
    return [5,6,7,8,9];
  } else {
    if(gameTime<60)  return [5,6,8,9];
    if(gameTime<300) return [6,7,8,9,9];
    return [6,7,8,9,9];
  }
}

function spawnEnemy(){
  const a=Math.random()*Math.PI*2, d=380+Math.random()*100;
  const pool=getEnemyPool();
  const t=ENEMY_TYPES[pool[Math.floor(Math.random()*pool.length)]];
  const stg = STAGES[currentStage-1];
  const timeMul = 1+gameTime/400;
  const stageMul = stg.diffMul;
  const baseSpd = t.spd*(1+gameTime/700)*stageMul*0.7;
  const finalSpd = Math.min(baseSpd, player.spd*0.88);
  enemies.push({
    x:player.x+Math.cos(a)*d, y:player.y+Math.sin(a)*d,
    type:t, hp:t.hp*timeMul*stageMul, maxHp:t.hp*timeMul*stageMul,
    spd:finalSpd, xp:Math.round(t.xp*stageMul),
    dmg:t.dmg*(1+gameTime/500)*stageMul, hitFlash:0,
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  BOSS SPAWN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function spawnBoss(){
  // ë³´ìŠ¤ ë“±ì¥ ì „ ì¼ë°˜ ëª¬ìŠ¤í„° ì „ë©¸ (XP ë“œë¡­ ì—†ì´ ì¡°ìš©íˆ ì œê±°)
  enemies = enemies.filter(e => e.isBoss); // ê¸°ì¡´ ë³´ìŠ¤ë§Œ ë‚¨ê¸°ê³  ëª¨ë‘ ì œê±°
  projectiles = [];
  isBossPhase = true;

  const stg = STAGES[currentStage-1];
  const bossIdx = Math.min(
    Math.floor((gameTime-300)/300) + (currentStage-1),
    BOSS_TYPES.length-1
  );
  const t = BOSS_TYPES[bossIdx];
  const mul = stg.diffMul * (1+gameTime/600);
  const a = Math.random()*Math.PI*2;
  const boss = {
    x:player.x+Math.cos(a)*420, y:player.y+Math.sin(a)*420,
    type:t, hp:t.hp*mul, maxHp:t.hp*mul,
    spd:Math.min(t.spd*(1+gameTime/1000)*stg.diffMul*0.6, player.spd*0.82),
    xp:Math.round(t.xp*stg.diffMul), dmg:t.dmg*mul*0.6, hitFlash:0, isBoss:true,
  };
  enemies.push(boss);
  activeBoss = boss;
  SFX.bossSpawn();
  nextBossTime = gameTime + 300;
}

function showBossWarning(bossType){
  SFX.bossWarning();
  showNotif(`âš ï¸ ${bossType.icon} ${bossType.name} ì¶œí˜„!`, '#ff4444');
  const el=document.getElementById('evo-notif');
  el.style.borderColor='rgba(255,50,50,0.5)';
  el.style.background='rgba(40,0,0,0.9)';
  setTimeout(()=>{ el.style.borderColor=''; el.style.background=''; },3000);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  WEAPON FIRING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function fireWeapons(dt){
  for(let wid in player.weapons){
    const wlv=player.weapons[wid]-1;
    const wd=WEAPON_DATA[wid]; if(!wd) continue;
    player.weaponCooldowns[wid]=(player.weaponCooldowns[wid]||0)-dt;
    if(player.weaponCooldowns[wid]>0) continue;
    player.weaponCooldowns[wid]=wd.cdBase*Math.pow(0.85,wlv)*player.cdrMul;
    switch(wid){
      case'orb':    SFX.orbShoot();   fireOrb(wlv,wd);    break;
      case'axe':    SFX.axeThrow();   fireAxe(wlv,wd);    break;
      case'aura':   SFX.auraHum();    fireAura(wlv,wd);   break;
      case'cross':  SFX.crossShoot(); fireCross(wlv,wd);  break;
      case'bolt':   SFX.boltStrike(); fireBolt(wlv,wd);   break;
      case'nova':   SFX.novaExplode();fireNova(wlv,wd);   break;
      case'blade':                    updateBlade(wlv,wd);break;
      case'arrow':  SFX.arrowShoot(); fireArrow(wlv,wd);  break;
      case'ice':    SFX.iceShoot();   fireIce(wlv,wd);    break;
      case'whip':   SFX.whipCrack();  fireWhip(wlv,wd);   break;
      case'meteor': SFX.meteorFall(); fireMeteor();  break;
      case'storm':  SFX.auraHum();    fireStorm();   break;
      case'divine': SFX.crossShoot(); fireDivine();  break;
      case'thunder':SFX.boltStrike(); fireThunder(); break;
      case'inferno':SFX.novaExplode();fireInferno(); break;
      case'phantom':                  updatePhantom();break;
      case'tempest':SFX.arrowShoot(); fireTempest(); break;
      case'glacier':SFX.iceShoot();   fireGlacier(); break;
      case'cyclone':SFX.whipCrack();  fireCyclone(); break;
    }
  }
}

function nearestEnemy(x,y){ let b=null,bd=Infinity; for(let e of enemies){const d=dist(x,y,e.x,e.y);if(d<bd){bd=d;b=e;}} return b; }
function dist(x1,y1,x2,y2){return Math.hypot(x2-x1,y2-y1);}

function fireOrb(wlv,wd){
  const base = 1+wlv+(player._orbExtra||0);
  const dmg=(wd.dmgBase+wlv*10)*player.dmgMul;
  const target=nearestEnemy(player.x,player.y);
  const a=target?Math.atan2(target.y-player.y,target.x-player.x):0;
  for(let i=0;i<base;i++) orbBurstQueue.push({angle:a,dmg,spd:wd.spdBase});
}
function updateOrbBurst(dt){
  if(!orbBurstQueue.length) return;
  orbBurstTimer-=dt;
  if(orbBurstTimer<=0){
    orbBurstTimer=0.12;
    const o=orbBurstQueue.shift();
    const sp=(Math.random()-0.5)*0.12;
    projectiles.push({x:player.x,y:player.y,vx:Math.cos(o.angle+sp)*o.spd,vy:Math.sin(o.angle+sp)*o.spd,
      dmg:o.dmg,r:7,color:'#9A4FFF',life:2.5,pierce:1,type:'orb',glow:'rgba(168,85,247,0.7)',hitSet:new Set()});
  }
}
function fireAxe(wlv,wd){
  const cnt=1+Math.floor(wlv/2),dmg=(wd.dmgBase+wlv*20)*player.dmgMul;
  for(let i=0;i<cnt;i++){
    const a=Math.random()*Math.PI*2;
    projectiles.push({x:player.x,y:player.y,vx:Math.cos(a)*wd.spdBase,vy:Math.sin(a)*wd.spdBase-200,
      dmg,r:9,color:'#C0A020',life:2.0,pierce:99,type:'axe',gravity:350,glow:'rgba(200,160,32,0.6)',rot:0});
  }
}
function fireAura(wlv,wd){
  const range=80+wlv*20,dmg=(wd.dmgBase+wlv*8)*0.5*player.dmgMul;
  for(let e of enemies){ if(dist(player.x,player.y,e.x,e.y)<range) hitEnemy(e,dmg); }
  particles.push({x:player.x,y:player.y,r:range,life:0.3,maxLife:0.3,type:'ring',color:'rgba(100,0,150,0.3)'});
}
function fireCross(wlv,wd){
  const dmg=(wd.dmgBase+wlv*25)*player.dmgMul;
  for(let i=0;i<4;i++){const a=i*Math.PI/2;projectiles.push({x:player.x,y:player.y,vx:Math.cos(a)*wd.spdBase,vy:Math.sin(a)*wd.spdBase,dmg,r:8,color:'#FFD700',life:3.0,pierce:99,type:'cross',glow:'rgba(255,215,0,0.7)'});}
}
function fireBolt(wlv,wd){
  const cnt=1+wlv,dmg=(wd.dmgBase+wlv*20)*player.dmgMul;
  if(!enemies.length) return;
  const pool=[...enemies].filter(e=>dist(player.x,player.y,e.x,e.y)<600);
  if(!pool.length) return;
  const shuffled=[...pool].sort(()=>Math.random()-0.5).slice(0,cnt);
  for(const e of shuffled){
    hitEnemy(e,dmg);
    particles.push({type:'lightning',x:e.x,y:e.y,life:0.25,maxLife:0.25});
    particles.push({x:e.x,y:e.y,r:0,maxR:30,life:0.2,maxLife:0.2,type:'nova',color:'#aaeeff'});
  }
}
function fireNova(wlv,wd){
  const range=100+wlv*30,dmg=(wd.dmgBase+wlv*40)*player.dmgMul;
  for(let e of enemies){ if(dist(player.x,player.y,e.x,e.y)<range) hitEnemy(e,dmg); }
  particles.push({x:player.x,y:player.y,r:0,maxR:range,life:0.4,maxLife:0.4,type:'nova',color:'#FF6600'});
}
function updateBlade(wlv,wd){
  const cnt=2+wlv+(player._bladeExtra||0),dmg=(wd.dmgBase+wlv*8)*player.dmgMul,radius=60;
  for(let e of enemies){
    for(let i=0;i<cnt;i++){
      const angle=gameTime*2.5+i*(Math.PI*2/cnt);
      const bx=player.x+Math.cos(angle)*radius,by=player.y+Math.sin(angle)*radius;
      if(dist(bx,by,e.x,e.y)<e.type.size+10) hitEnemy(e,dmg*0.05);
    }
  }
}
function fireArrow(wlv,wd){
  const cnt=1+Math.floor(wlv/2),dmg=(wd.dmgBase+wlv*12)*player.dmgMul;
  const target=nearestEnemy(player.x,player.y);
  const baseA=target?Math.atan2(target.y-player.y,target.x-player.x):0;
  for(let i=0;i<cnt;i++){
    const a=baseA+(cnt>1?(i-(cnt-1)/2)*0.25:0);
    projectiles.push({x:player.x,y:player.y,vx:Math.cos(a)*wd.spdBase,vy:Math.sin(a)*wd.spdBase,dmg,r:5,color:'#AAFFAA',life:1.8,pierce:3,type:'bolt',glow:'rgba(170,255,170,0.7)'});
  }
}
function fireIce(wlv,wd){
  const target=nearestEnemy(player.x,player.y); if(!target) return;
  const dmg=(wd.dmgBase+wlv*18)*player.dmgMul,a=Math.atan2(target.y-player.y,target.x-player.x);
  projectiles.push({x:player.x,y:player.y,vx:Math.cos(a)*wd.spdBase,vy:Math.sin(a)*wd.spdBase,
    dmg,r:10,color:'#88CCFF',life:2.2,pierce:2+wlv,type:'orb',glow:'rgba(136,200,255,0.9)',
    onHit:(e)=>{ e.spd*=0.5; setTimeout(()=>{ if(e) e.spd*=2; },(1+wlv)*1000); }});
}
function fireWhip(wlv,wd){
  const range=130+wlv*22,dmg=(wd.dmgBase+wlv*15)*player.dmgMul;
  const dir=player.facing, arcHalf=Math.PI*0.39, faceAngle=dir>0?0:Math.PI;
  for(let e of enemies){
    const dx=e.x-player.x,dy=e.y-player.y,d=Math.hypot(dx,dy);
    if(d>range) continue;
    let diff=Math.atan2(dy,dx)-faceAngle;
    while(diff>Math.PI) diff-=Math.PI*2; while(diff<-Math.PI) diff+=Math.PI*2;
    if(Math.abs(diff)<arcHalf){ hitEnemy(e,dmg); particles.push({x:e.x,y:e.y,vx:dir*80,vy:-40,life:0.25,maxLife:0.25,r:3,color:'#FFE066',type:'dot'}); }
  }
  particles.push({type:'arc',x:player.x,y:player.y,angle:faceAngle,arcHalf,range,life:0.18,maxLife:0.18,color:'rgba(255,220,60,'});
}
function fireTempest(){
  const target=nearestEnemy(player.x,player.y),baseA=target?Math.atan2(target.y-player.y,target.x-player.x):0;
  for(let i=0;i<5;i++){const a=baseA+(i-2)*0.22;projectiles.push({x:player.x,y:player.y,vx:Math.cos(a)*480,vy:Math.sin(a)*480,dmg:180,r:6,color:'#CCFFCC',life:1.5,pierce:99,type:'bolt',glow:'rgba(180,255,180,0.8)'});}
}
function fireGlacier(){
  for(let e of enemies){ if(dist(player.x,player.y,e.x,e.y)<350){ hitEnemy(e,200); e.spd*=0.3; setTimeout(()=>{ if(e) e.spd/=0.3; },2000); } }
  particles.push({x:player.x,y:player.y,r:0,maxR:350,life:0.7,maxLife:0.7,type:'nova',color:'#88CCFF'});
}
function fireCyclone(){
  const dir=player.facing,faceAngle=dir>0?0:Math.PI,arcHalf=Math.PI*0.55;
  for(let e of enemies){
    const dx=e.x-player.x,dy=e.y-player.y,d=Math.hypot(dx,dy);
    if(d>220) continue;
    let diff=Math.atan2(dy,dx)-faceAngle;
    while(diff>Math.PI) diff-=Math.PI*2; while(diff<-Math.PI) diff+=Math.PI*2;
    if(Math.abs(diff)<arcHalf){ hitEnemy(e,110); e.x+=dx/d*80; e.y+=dy/d*80; }
  }
  particles.push({type:'arc',x:player.x,y:player.y,angle:faceAngle,arcHalf,range:220,life:0.3,maxLife:0.3,color:'rgba(255,240,80,'});
}
function fireMeteor(){ const e=enemies[Math.floor(Math.random()*enemies.length)]; if(!e) return; const tx=e.x+(Math.random()-0.5)*80,ty=e.y+(Math.random()-0.5)*80; projectiles.push({x:tx-200,y:ty-200,vx:200,vy:200,dmg:250,r:14,color:'#FF4400',life:1.5,pierce:99,type:'meteor',glow:'rgba(255,68,0,0.9)'}); }
function fireStorm(){ const range=180,dmg=30; for(let e of enemies){ if(dist(player.x,player.y,e.x,e.y)<range) hitEnemy(e,dmg); } particles.push({x:player.x,y:player.y,r:range,life:0.3,maxLife:0.3,type:'ring',color:'rgba(80,200,255,0.5)'}); }
function fireDivine(){ const dmg=280; for(let i=0;i<8;i++){const a=i*Math.PI/4;projectiles.push({x:player.x,y:player.y,vx:Math.cos(a)*240,vy:Math.sin(a)*240,dmg,r:10,color:'#FFFAAA',life:3.5,pierce:99,type:'cross',glow:'rgba(255,255,180,0.9)'});} }
function fireThunder(){ [...enemies].sort((a,b)=>dist(player.x,player.y,a.x,a.y)-dist(player.x,player.y,b.x,b.y)).slice(0,8).forEach(e=>{ hitEnemy(e,200); particles.push({x:e.x,y:e.y,r:20,life:0.2,maxLife:0.2,type:'nova',color:'#88FFFF'}); }); }
function fireInferno(){ const range=180,dmg=60; for(let e of enemies){ if(dist(player.x,player.y,e.x,e.y)<range) hitEnemy(e,dmg); } particles.push({x:player.x,y:player.y,r:0,maxR:range,life:0.6,maxLife:0.6,type:'nova',color:'#FF3300'}); }
function updatePhantom(){ const cnt=4,dmg=80,radius=80; for(let e of enemies){ for(let i=0;i<cnt;i++){ const angle=gameTime*3+i*(Math.PI*2/cnt),bx=player.x+Math.cos(angle)*radius,by=player.y+Math.sin(angle)*radius; if(dist(bx,by,e.x,e.y)<e.type.size+14) hitEnemy(e,dmg*0.06); } } }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  HIT / KILL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function hitEnemy(e,dmg){
  e.hp-=dmg; e.hitFlash=0.12;
  dmgNums.push({x:e.x+(Math.random()-0.5)*18,y:e.y-8,val:Math.round(dmg),life:0.8,vy:-45,color:'#f0c040'});
  if(e.hp<=0) killEnemy(e);
  else if(Math.random()<0.08) SFX.enemyHit(); // ë„ˆë¬´ ìì£¼ ìš¸ë¦¬ì§€ ì•Šê²Œ 8% í™•ë¥ 
}
function killEnemy(e){
  kills++;
  if(e.isBoss){
    activeBoss=null; isBossPhase=false; SFX.bossDie();
    // ë³´ìŠ¤ ì²˜ì¹˜ ë³´ìƒ: ì½”ì¸+ì•„ì´í…œ 3~5ê°œ ë“œë¡­
    for(let i=0;i<3+Math.floor(Math.random()*3);i++){
      const a=Math.random()*Math.PI*2, d=30+Math.random()*80;
      const weights=['coin','coin','magnet','bomb','chicken','chicken'];
      const kind=weights[Math.floor(Math.random()*weights.length)];
      const t2=FLOOR_ITEM_TYPES[kind];
      floorItems.push({x:e.x+Math.cos(a)*d,y:e.y+Math.sin(a)*d,kind,r:t2.r,life:25,bob:Math.random()*6});
    }
    saveData.coins+=30; // ë³´ìŠ¤ ì²˜ì¹˜ ì½”ì¸ ë³´ë„ˆìŠ¤
    document.getElementById('coin-hud').textContent='ğŸª™ '+saveData.coins;
    showNotif('ğŸ’€ ë³´ìŠ¤ ì²˜ì¹˜! +30ğŸª™','#ffd700');
  }
  else if(Math.random()<0.3) SFX.enemyDie(); // 30% í™•ë¥ ë¡œ ì‚¬ë§ìŒ
  xpGems.push({x:e.x,y:e.y,val:e.xp,r:5,life:20});
  for(let i=0;i<6;i++){
    const a=Math.random()*Math.PI*2,spd=40+Math.random()*80;
    particles.push({x:e.x,y:e.y,vx:Math.cos(a)*spd,vy:Math.sin(a)*spd,life:0.5,maxLife:0.5,r:2+Math.random()*2,color:e.type.color,type:'dot'});
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FLOOR ITEMS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const FLOOR_SPAWN_WEIGHTS = ['coin','coin','coin','magnet','bomb','chicken','chicken','poison'];

function spawnFloorItem(){
  // í”Œë ˆì´ì–´ ì£¼ë³€ ëœë¤ ìœ„ì¹˜ì— ì•„ì´í…œ ë“œë¡­
  const a = Math.random()*Math.PI*2;
  const d = 120 + Math.random()*180;
  const typeName = FLOOR_SPAWN_WEIGHTS[Math.floor(Math.random()*FLOOR_SPAWN_WEIGHTS.length)];
  const t = FLOOR_ITEM_TYPES[typeName];
  floorItems.push({
    x: player.x + Math.cos(a)*d,
    y: player.y + Math.sin(a)*d,
    kind: typeName,
    r: t.r,
    life: 18, // 18ì´ˆ í›„ ì‚¬ë¼ì§
    bob: 0,
  });
}

function applyFloorItem(fi){
  const kind = fi.kind;
  if(kind==='coin'){
    saveData.coins += 20;
    document.getElementById('coin-hud').textContent='ğŸª™ '+saveData.coins;
    SFX.coinEarn();
    dmgNums.push({x:fi.x,y:fi.y-6,val:'+20ğŸª™',life:1.0,vy:-30,color:'#FFD700'});
  } else if(kind==='magnet'){
    // í™”ë©´ ì•ˆ ëª¨ë“  XP í¡ìˆ˜
    for(let g of xpGems){ g.x=player.x; g.y=player.y; }
    SFX.levelUp();
    showNotif('ğŸ§² XP ì „ë¶€ í¡ìˆ˜!','#4488ff');
  } else if(kind==='bomb'){
    // ë³´ìŠ¤ ì œì™¸ í™”ë©´ ì•ˆ ëª¨ë“  ì  ì œê±°
    const killed = enemies.filter(e=>!e.isBoss);
    killed.forEach(e=>{
      kills++;
      xpGems.push({x:e.x,y:e.y,val:e.xp,r:5,life:20});
      for(let i=0;i<4;i++){
        const ba=Math.random()*Math.PI*2,bs=40+Math.random()*60;
        particles.push({x:e.x,y:e.y,vx:Math.cos(ba)*bs,vy:Math.sin(ba)*bs,life:0.4,maxLife:0.4,r:2,color:e.type.color,type:'dot'});
      }
    });
    enemies = enemies.filter(e=>e.isBoss);
    // ê±°ëŒ€ í­ë°œ íŒŒí‹°í´
    particles.push({x:player.x,y:player.y,r:0,maxR:400,life:0.6,maxLife:0.6,type:'nova',color:'#FF4422'});
    SFX.novaExplode(); SFX.bossWarning();
    showNotif('ğŸ’£ í­íƒ„ í­ë°œ!','#ff4422');
  } else if(kind==='chicken'){
    const healed = Math.min(40, player.maxHp - player.hp);
    player.hp = Math.min(player.maxHp, player.hp+40);
    SFX.coinEarn();
    dmgNums.push({x:fi.x,y:fi.y-6,val:'+'+Math.round(healed)+'HP',life:1.0,vy:-30,color:'#4ade80'});
  } else if(kind==='poison'){
    const dmg = Math.min(30, player.hp-1); // ì ˆëŒ€ ì¦‰ì‚¬í•˜ì§€ ì•ŠìŒ (ìµœì†Œ 1 HP)
    player.hp = Math.max(1, player.hp-30);
    SFX.playerHit();
    dmgNums.push({x:fi.x,y:fi.y-6,val:'-30HP',life:1.0,vy:-30,color:'#AA44FF'});
    // ë³´ë¼ìƒ‰ í”Œë˜ì‹œ
    particles.push({x:player.x,y:player.y,r:0,maxR:60,life:0.3,maxLife:0.3,type:'nova',color:'#AA44FF'});
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SOUND SYSTEM (Web Audio API - no files needed)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let audioCtx = null;
let masterGain = null;
let soundEnabled = true;

function getAudioCtx(){
  if(!audioCtx){
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    masterGain = audioCtx.createGain();
    masterGain.gain.value = 0.35;
    masterGain.connect(audioCtx.destination);
  }
  if(audioCtx.state === 'suspended') audioCtx.resume();
  return audioCtx;
}

function playTone({freq=440,freq2=null,type='sine',duration=0.15,volume=0.4,
                   attack=0.005,decay=0.05,sustain=0.3,release=0.1,
                   detune=0,freqSlide=null,delay=0}={}){
  if(!soundEnabled) return;
  try{
    const ac=getAudioCtx(); const t=ac.currentTime+delay;
    const osc=ac.createOscillator(); const gain=ac.createGain();
    osc.connect(gain); gain.connect(masterGain);
    osc.type=type; osc.frequency.setValueAtTime(freq,t); osc.detune.setValueAtTime(detune,t);
    if(freqSlide!==null) osc.frequency.linearRampToValueAtTime(freqSlide,t+duration);
    if(freq2!==null) osc.frequency.linearRampToValueAtTime(freq2,t+duration*0.5);
    gain.gain.setValueAtTime(0,t);
    gain.gain.linearRampToValueAtTime(volume,t+attack);
    gain.gain.linearRampToValueAtTime(volume*sustain,t+attack+decay);
    gain.gain.setValueAtTime(volume*sustain,t+duration-release);
    gain.gain.linearRampToValueAtTime(0,t+duration);
    osc.start(t); osc.stop(t+duration+0.01);
  }catch(e){}
}

function playNoise({duration=0.1,volume=0.3,filterFreq=2000,filterType='bandpass',delay=0}={}){
  if(!soundEnabled) return;
  try{
    const ac=getAudioCtx(); const t=ac.currentTime+delay;
    const bufLen=Math.ceil(ac.sampleRate*duration);
    const buf=ac.createBuffer(1,bufLen,ac.sampleRate);
    const data=buf.getChannelData(0);
    for(let i=0;i<bufLen;i++) data[i]=Math.random()*2-1;
    const src=ac.createBufferSource(); src.buffer=buf;
    const filter=ac.createBiquadFilter(); filter.type=filterType; filter.frequency.value=filterFreq;
    const gain=ac.createGain();
    src.connect(filter); filter.connect(gain); gain.connect(masterGain);
    gain.gain.setValueAtTime(volume,t); gain.gain.linearRampToValueAtTime(0,t+duration);
    src.start(t); src.stop(t+duration+0.01);
  }catch(e){}
}

const SFX = {
  orbShoot(){ playTone({freq:520,freqSlide:380,type:'sine',duration:0.12,volume:0.22,attack:0.005,decay:0.04,sustain:0.2,release:0.06}); },
  axeThrow(){ playTone({freq:200,freq2:120,type:'sawtooth',duration:0.18,volume:0.28,attack:0.01,decay:0.08,sustain:0.2,release:0.08}); },
  auraHum(){ playTone({freq:80,type:'sine',duration:0.3,volume:0.1,attack:0.05,decay:0.1,sustain:0.6,release:0.15,detune:5}); },
  crossShoot(){ playTone({freq:660,freqSlide:880,type:'square',duration:0.1,volume:0.2,attack:0.003,decay:0.04,sustain:0.3,release:0.05}); },
  boltStrike(){
    playNoise({duration:0.06,volume:0.45,filterFreq:6000,filterType:'highpass'});
    playTone({freq:120,freqSlide:60,type:'sawtooth',duration:0.08,volume:0.3,attack:0.001,decay:0.03,sustain:0.1,release:0.04});
  },
  novaExplode(){
    playNoise({duration:0.25,volume:0.4,filterFreq:800,filterType:'lowpass'});
    playTone({freq:100,freqSlide:50,type:'sawtooth',duration:0.25,volume:0.28,attack:0.01,decay:0.1,sustain:0.2,release:0.12});
  },
  whipCrack(){
    playNoise({duration:0.08,volume:0.5,filterFreq:4000,filterType:'bandpass'});
    playTone({freq:300,freqSlide:800,type:'sawtooth',duration:0.07,volume:0.25,attack:0.001,decay:0.03,sustain:0.1,release:0.03});
  },
  arrowShoot(){ playTone({freq:700,freqSlide:500,type:'sawtooth',duration:0.09,volume:0.18,attack:0.002,decay:0.04,sustain:0.15,release:0.04}); },
  iceShoot(){
    playTone({freq:900,freqSlide:600,type:'sine',duration:0.14,volume:0.2,attack:0.005,decay:0.05,sustain:0.3,release:0.07,detune:-10});
    playTone({freq:1100,freqSlide:700,type:'sine',duration:0.14,volume:0.1,attack:0.01,decay:0.05,sustain:0.2,release:0.07,delay:0.02});
  },
  meteorFall(){
    playNoise({duration:0.3,volume:0.45,filterFreq:400,filterType:'lowpass'});
    playTone({freq:80,freqSlide:40,type:'sawtooth',duration:0.3,volume:0.35,attack:0.01,decay:0.1,sustain:0.4,release:0.15});
  },
  enemyHit(){ playTone({freq:180,freqSlide:120,type:'square',duration:0.05,volume:0.15,attack:0.001,decay:0.02,sustain:0.1,release:0.02}); },
  enemyDie(){
    playNoise({duration:0.1,volume:0.25,filterFreq:600,filterType:'lowpass'});
    playTone({freq:150,freqSlide:60,type:'sawtooth',duration:0.1,volume:0.2,attack:0.002,decay:0.04,sustain:0.1,release:0.05});
  },
  bossDie(){
    for(let i=0;i<4;i++){
      playNoise({duration:0.3,volume:0.45-i*0.07,filterFreq:800-i*100,filterType:'lowpass',delay:i*0.08});
      playTone({freq:200-i*30,freqSlide:80-i*10,type:'sawtooth',duration:0.3,volume:0.3,attack:0.01,decay:0.08,sustain:0.3,release:0.15,delay:i*0.08});
    }
  },
  playerHit(){
    playNoise({duration:0.1,volume:0.35,filterFreq:300,filterType:'lowpass'});
    playTone({freq:100,freqSlide:60,type:'square',duration:0.1,volume:0.28,attack:0.001,decay:0.04,sustain:0.2,release:0.05});
  },
  playerDie(){
    playNoise({duration:0.5,volume:0.55,filterFreq:200,filterType:'lowpass'});
    for(let i=0;i<5;i++) playTone({freq:300-i*40,freqSlide:80,type:'sawtooth',duration:0.4,volume:0.28-i*0.04,attack:0.01,decay:0.1,sustain:0.3,release:0.2,delay:i*0.05});
  },
  xpPickup(){ playTone({freq:880,freqSlide:1100,type:'sine',duration:0.07,volume:0.12,attack:0.003,decay:0.02,sustain:0.2,release:0.03}); },
  levelUp(){
    const notes=[523,659,784,1047];
    notes.forEach((f,i)=>playTone({freq:f,freqSlide:f*1.05,type:'sine',duration:0.18,volume:0.32,attack:0.005,decay:0.06,sustain:0.4,release:0.08,delay:i*0.1}));
    playTone({freq:1568,type:'triangle',duration:0.4,volume:0.18,attack:0.01,decay:0.1,sustain:0.3,release:0.2,delay:0.4});
  },
  evolution(){
    const notes=[262,330,392,523,659,784];
    notes.forEach((f,i)=>playTone({freq:f,freqSlide:f*1.1,type:'sawtooth',duration:0.3,volume:0.28,attack:0.01,decay:0.08,sustain:0.5,release:0.15,delay:i*0.07}));
    playNoise({duration:0.4,volume:0.18,filterFreq:3000,filterType:'highpass',delay:0.1});
  },
  bossWarning(){
    playTone({freq:110,freqSlide:55,type:'sawtooth',duration:0.5,volume:0.38,attack:0.02,decay:0.1,sustain:0.6,release:0.2});
    playTone({freq:110,freqSlide:55,type:'sawtooth',duration:0.5,volume:0.32,attack:0.02,decay:0.1,sustain:0.6,release:0.2,delay:0.55,detune:15});
  },
  bossSpawn(){
    playNoise({duration:0.6,volume:0.45,filterFreq:200,filterType:'lowpass'});
    for(let i=0;i<3;i++) playTone({freq:80+i*20,type:'sawtooth',duration:0.6,volume:0.35,attack:0.02,decay:0.15,sustain:0.5,release:0.25,delay:i*0.12});
  },
  coinEarn(){
    playTone({freq:1047,freqSlide:1319,type:'sine',duration:0.12,volume:0.28,attack:0.004,decay:0.05,sustain:0.3,release:0.06});
    playTone({freq:1319,freqSlide:1568,type:'sine',duration:0.12,volume:0.18,attack:0.006,decay:0.05,sustain:0.3,release:0.06,delay:0.08});
  },
  buyItem(){
    playTone({freq:440,freqSlide:550,type:'sine',duration:0.15,volume:0.28,attack:0.005,decay:0.05,sustain:0.4,release:0.07});
    playTone({freq:660,freqSlide:880,type:'sine',duration:0.15,volume:0.18,attack:0.01,decay:0.05,sustain:0.3,release:0.07,delay:0.1});
  },
  stageClear(){
    const mel=[523,659,784,880,1047,880,1047,1319];
    mel.forEach((f,i)=>playTone({freq:f,type:'sine',duration:0.22,volume:0.32,attack:0.005,decay:0.07,sustain:0.5,release:0.1,delay:i*0.12}));
  },
  chestOpen(){
    playNoise({duration:0.15,volume:0.28,filterFreq:2000,filterType:'bandpass'});
    [330,415,523,622,784].forEach((f,i)=>playTone({freq:f,type:'sine',duration:0.18,volume:0.28,attack:0.005,decay:0.06,sustain:0.4,release:0.09,delay:i*0.06}));
  },
};

function toggleSound(){
  soundEnabled=!soundEnabled;
  document.getElementById('snd-btn').textContent=soundEnabled?'ğŸ”Š':'ğŸ”‡';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  XP / LEVEL UP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function gainXP(val){
  player.xp+=val;
  if(player.xp>=player.xpNext){
    player.xp-=player.xpNext;
    // ë ˆë²¨ì—… XP ìš”êµ¬ëŸ‰: ì´ˆë°˜ì—” ì²œì²œíˆ, í›„ë°˜ì—” ë” ì²œì²œíˆ ì¦ê°€
    const growthRate = player.level < 10 ? 1.18 : player.level < 20 ? 1.12 : 1.08;
    player.xpNext=Math.round(player.xpNext*growthRate);
    player.level++;
    const evos=getEvolutions();
    if(evos.length>0){ SFX.evolution(); showEvoChoice(evos); }
    else{ SFX.levelUp(); showLevelUp(); }
  }
}
function getEvolutions(){
  const evos=[];
  for(let r of EVO_RECIPES){
    if(player.weapons[r.weapon]>=WEAPON_DATA[r.weapon]?.maxLv && player.accessories[r.acc] && !player.weapons[r.result])
      evos.push(r);
  }
  return evos;
}
function applyEvolution(r){
  delete player.weapons[r.weapon]; delete player.weaponCooldowns[r.weapon];
  delete player.accessories[r.acc];
  player.weapons[r.result]=1; player.weaponCooldowns[r.result]=0;
  updateSlots(); showNotif(`${r.icon} ${r.name} ìœ¼ë¡œ ì§„í™”!`, '#fb923c');
}
function showLevelUp(){
  state='levelup';
  document.getElementById('luscreen').style.display='flex';
  document.getElementById('lvn').textContent=player.level;
  renderCards(buildUpgradePool(), false);
}
function showEvoChoice(evos){
  state='levelup';
  document.getElementById('luscreen').style.display='flex';
  const normal=buildUpgradePool().slice(0,2);
  const cards=[];
  for(let r of evos.slice(0,1)) cards.push({id:r.result,name:`${r.icon} ${r.name}`,icon:r.icon,evo:true,recipe:r,desc:`${WEAPON_DATA[r.weapon].name} MAX + ${ACC_DATA[r.acc].name} â†’ ì§„í™”!`});
  cards.push(...normal);
  renderCards(cards, true);
}
function renderCards(pool, hasEvo){
  const titleEl=document.getElementById('lu-title');
  titleEl.textContent=hasEvo?'ì§„í™” ê°€ëŠ¥':'ë ˆë²¨ ì—…';
  titleEl.className=hasEvo?'evo':'';
  const container=document.getElementById('cards');
  container.innerHTML='';
  for(let up of pool){
    const d=document.createElement('div');
    d.className='card'+(up.evo?' evo-card':'');
    d.innerHTML=`<div class="ci">${up.icon}</div><div class="cn">${up.name}</div><div class="cd">${up.desc||''}</div>${up.evo?'<div class="evo-badge">Evolution</div>':''}`;
    d.onclick=()=>{ if(up.evo) applyEvolution(up.recipe); else applyUpgrade(up); document.getElementById('luscreen').style.display='none'; state='playing'; };
    container.appendChild(d);
  }
}
function buildUpgradePool(){
  const pool=[];
  const all=[...UPGRADES].sort(()=>Math.random()-0.5);
  const weaponCount = Object.keys(player.weapons).filter(w=>!WEAPON_DATA[w]?.evolved).length;
  const accCount = Object.keys(player.accessories).length;
  for(let up of all){
    if(pool.length>=3) break;
    if(up.weapon){
      const wd=WEAPON_DATA[up.id]; if(!wd||wd.evolved) continue;
      const wlv=player.weapons[up.id];
      if(wlv){ if(wlv<wd.maxLv) pool.push({...up,desc:wd.desc(wlv),name:up.name+` Lv.${wlv+1}`}); }
      else if(weaponCount < MAX_WEAPONS) pool.push({...up,desc:wd.desc(0)}); // ìŠ¬ë¡¯ ê½‰ì°¨ë©´ ìƒˆ ë¬´ê¸° ì•ˆ ë‚˜ì˜´
    } else if(up.accessory){
      if(!player.accessories[up.id] && accCount < MAX_ABILITIES){ const ad=ACC_DATA[up.id]; pool.push({...up,desc:ad?ad.desc:'ë³´ì¡° ì•„ì´í…œ'}); }
    } else {
      const descs={maxhp:'ìµœëŒ€ HP +50',speed:'ì´ë™ ì†ë„ +15%',pickup:'ìˆ˜ì§‘ ë²”ìœ„ +30',heal:'HP 50 ì¦‰ì‹œ íšŒë³µ',dmgup:'ê³µê²©ë ¥ +15%',cdr:'ì¿¨íƒ€ì„ -10%'};
      pool.push({...up,desc:descs[up.id]||''});
    }
  }
  while(pool.length<3) pool.push({id:'heal',name:'ì¦‰ì‹œ íšŒë³µ',icon:'ğŸ’‰',desc:'HP 50 ì¦‰ì‹œ íšŒë³µ'});
  return pool.slice(0,3);
}
function applyUpgrade(up){
  if(up.weapon){
    const weaponCount = Object.keys(player.weapons).filter(w=>!WEAPON_DATA[w]?.evolved).length;
    const alreadyHas = !!player.weapons[up.id];
    if(!alreadyHas && weaponCount >= MAX_WEAPONS){ showNotif('âš ï¸ ë¬´ê¸° ìŠ¬ë¡¯ì´ ê°€ë“ ì°¼ìŠµë‹ˆë‹¤ (ìµœëŒ€ 5ê°œ)','#ff6b63'); return; }
    if(!player.weapons[up.id]){player.weapons[up.id]=1;player.weaponCooldowns[up.id]=0;}
    else player.weapons[up.id]++;
    updateSlots();
  } else if(up.accessory){
    const accCount = Object.keys(player.accessories).length;
    if(!player.accessories[up.id] && accCount >= MAX_ABILITIES){ showNotif('âš ï¸ ëŠ¥ë ¥ ìŠ¬ë¡¯ì´ ê°€ë“ ì°¼ìŠµë‹ˆë‹¤ (ìµœëŒ€ 5ê°œ)','#ff6b63'); return; }
    player.accessories[up.id]=1;
    const p=ACC_DATA[up.id]?.passive;
    if(p){
      if(p.cdr)    player.cdrMul=Math.max(0.2,player.cdrMul-p.cdr);
      if(p.dmg)    player.dmgMul+=p.dmg;
      if(p.hp)     { player.maxHp+=p.hp; player.hp=Math.min(player.hp+p.hp,player.maxHp); }
      if(p.spd)    player.spd*=(1+p.spd);
      if(p.pickup) player.pickupRange+=p.pickup;
    }
    updateSlots();
  } else if(up.id==='maxhp'){ player.maxHp+=50; player.hp=Math.min(player.hp+50,player.maxHp); }
  else if(up.id==='speed')  player.spd*=1.15;
  else if(up.id==='pickup') player.pickupRange+=30;
  else if(up.id==='heal')   player.hp=Math.min(player.hp+50,player.maxHp);
  else if(up.id==='dmgup')  player.dmgMul+=0.15;
  else if(up.id==='cdr')    player.cdrMul=Math.max(0.2,player.cdrMul-0.10);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SLOT UI
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateSlots(){
  const container=document.getElementById('slots');
  container.innerHTML='';
  // ì¸ë²¤í† ë¦¬ ì¹´ìš´íŠ¸ í—¤ë”
  const wCnt=Object.keys(player.weapons).filter(w=>!WEAPON_DATA[w]?.evolved).length;
  const aCnt=Object.keys(player.accessories).length;
  const hdr=document.createElement('div');
  hdr.style.cssText='font-family:Rajdhani,sans-serif;font-size:8px;font-weight:700;color:rgba(136,153,187,0.5);letter-spacing:1px;text-align:right;padding:0 7px 2px;';
  hdr.textContent=`ë¬´ê¸° ${wCnt}/${MAX_WEAPONS}  ëŠ¥ë ¥ ${aCnt}/${MAX_ABILITIES}`;
  container.appendChild(hdr);
  for(let wid in player.weapons){
    const wd=WEAPON_DATA[wid]; if(!wd) continue;
    const lv=player.weapons[wid],maxed=wd.maxLv&&lv>=wd.maxLv,isEvolved=wd.evolved;
    const d=document.createElement('div');
    d.className='slot '+(isEvolved?'evolved':'wpn');
    d.innerHTML=`<span class="si">${wd.icon}</span><span class="sn ${isEvolved?'evo-name':''}">${wd.name}</span>${!isEvolved?`<span class="slv ${maxed?'maxed':''}">Lv.${lv}${maxed?' MAX':''}</span>`:'<span class="slv maxed">ì§„í™”</span>'}`;
    container.appendChild(d);
  }
  for(let aid in player.accessories){
    const ad=ACC_DATA[aid]; if(!ad) continue;
    const d=document.createElement('div'); d.className='slot itm';
    d.innerHTML=`<span class="si">${ad.icon}</span><span class="sn item-name">${ad.name}</span>`;
    container.appendChild(d);
  }
  // Show active armor
  saveData.ownedEquip.forEach(eid=>{
    const eq=[...SHOP_ARMORS].find(e=>e.id===eid); if(!eq) return;
    const d=document.createElement('div'); d.className='slot armor-slot';
    d.innerHTML=`<span class="si">${eq.icon}</span><span class="sn armor-name">${eq.name}</span>`;
    container.appendChild(d);
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  GAME LOOP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function gameLoop(ts){
  if(state==='over'||state==='win'||state==='cleared') return;
  animId=requestAnimationFrame(gameLoop);
  if(lastTime===0) lastTime=ts;
  const dt=Math.min((ts-lastTime)/1000,0.05);
  lastTime=ts;
  if(state==='playing') update(dt);
  else if(state==='dying'){
    gameTime+=dt;
    particles.forEach((p,i)=>{ p.life-=dt; if(p.vx!==undefined){p.x+=p.vx*dt;p.y+=p.vy*dt;p.vx*=0.9;p.vy*=0.9;} });
    particles=particles.filter(p=>p.life>0);
    dmgNums.forEach(d=>{ d.life-=dt; d.y+=d.vy*dt; });
    dmgNums=dmgNums.filter(d=>d.life>0);
  }
  render();
}

function update(dt){
  gameTime+=dt;

  // Movement
  let dx=0,dy=0;
  if(keys['ArrowLeft']||keys['KeyA']) dx-=1;
  if(keys['ArrowRight']||keys['KeyD']) dx+=1;
  if(keys['ArrowUp']||keys['KeyW']) dy-=1;
  if(keys['ArrowDown']||keys['KeyS']) dy+=1;
  const joy=getJoystickInput(); dx+=joy.x; dy+=joy.y;
  const dl=Math.hypot(dx,dy)||1;
  if(Math.abs(dx)>0.05||Math.abs(dy)>0.05){
    player.x+=dx/dl*player.spd*dt; player.y+=dy/dl*player.spd*dt;
    if(dx>0.05) player.facing=1; else if(dx<-0.05) player.facing=-1;
  }
  cam.x=player.x; cam.y=player.y;

  if(player.invincible>0) player.invincible-=dt;

  // Spawn enemies (ë³´ìŠ¤ í˜ì´ì¦ˆ ì¤‘ì—” ìŠ¤í° ì°¨ë‹¨)
  if(!isBossPhase){
    spawnTimer-=dt;
    if(spawnTimer<=0){
      spawnTimer=getSpawnRate();
      const cnt=Math.floor(1+gameTime/90*(0.5+currentStage*0.3));
      for(let i=0;i<cnt;i++) spawnEnemy();
    }
  }

  // ë°”ë‹¥ ì•„ì´í…œ ì£¼ê¸°ì  ìƒì„± (15~25ì´ˆë§ˆë‹¤)
  floorItemSpawnTimer-=dt;
  if(floorItemSpawnTimer<=0){
    floorItemSpawnTimer = 15+Math.random()*10;
    spawnFloorItem();
  }

  // ë°”ë‹¥ ì•„ì´í…œ í”½ì—… ì²˜ë¦¬
  for(let i=floorItems.length-1;i>=0;i--){
    const fi=floorItems[i];
    fi.life-=dt; fi.bob=(fi.bob||0)+dt;
    if(dist(player.x,player.y,fi.x,fi.y)<fi.r+18 || fi.life<=0){
      if(fi.life>0) applyFloorItem(fi);
      floorItems.splice(i,1);
    }
  }

  // Boss logic
  if(gameTime>=nextBossTime-10 && bossWarningTimer<=0 && !activeBoss){
    bossWarningTimer=10;
    const bossIdx=Math.min(Math.floor((nextBossTime-300)/300)+(currentStage-1),BOSS_TYPES.length-1);
    showBossWarning(BOSS_TYPES[bossIdx]);
  }
  if(bossWarningTimer>0){ bossWarningTimer-=dt; if(bossWarningTimer<=0&&gameTime>=nextBossTime) spawnBoss(); }
  if(activeBoss&&activeBoss.hp<=0) activeBoss=null;

  // Enemy movement & collision
  for(let i=enemies.length-1;i>=0;i--){
    const e=enemies[i];
    const dx2=player.x-e.x,dy2=player.y-e.y,d=Math.hypot(dx2,dy2)||1;
    e.x+=dx2/d*e.spd*dt; e.y+=dy2/d*e.spd*dt;
    if(e.hitFlash>0) e.hitFlash-=dt;
    if(e.hp<=0){enemies.splice(i,1);continue;}
    if(d<e.type.size+16&&player.invincible<=0){
      player.hp-=e.dmg*dt; player.invincible=0.1;
      if(player.hp<=0){
        player.hp=0; SFX.playerDie();
        dmgNums.push({x:player.x,y:player.y-10,val:'ì‚¬ë§!',life:1.5,vy:-80,color:'#FF2020',big:true});
        setTimeout(()=>gameOver(),600);
        state='dying'; return;
      } else { SFX.playerHit(); }
    }
  }

  fireWeapons(dt);
  updateOrbBurst(dt);

  // Projectiles
  for(let i=projectiles.length-1;i>=0;i--){
    const p=projectiles[i];
    p.x+=p.vx*dt; p.y+=p.vy*dt; p.life-=dt;
    if(p.gravity) p.vy+=p.gravity*dt;
    if(p.rot!==undefined) p.rot+=5*dt;
    if(p.life<=0){projectiles.splice(i,1);continue;}
    let removed=false;
    for(let j=enemies.length-1;j>=0;j--){
      const e=enemies[j];
      if(p.hitSet&&p.hitSet.has(e)) continue;
      if(dist(p.x,p.y,e.x,e.y)<p.r+e.type.size){
        if(p.hitSet) p.hitSet.add(e);
        if(p.onHit) p.onHit(e);
        hitEnemy(e,p.dmg); p.pierce--;
        if(p.pierce<=0){projectiles.splice(i,1);removed=true;break;}
        if(e.hp<=0) enemies.splice(j,1);
      }
    }
    if(!removed&&dist(p.x,p.y,player.x,player.y)>750) projectiles.splice(i,1);
  }

  // XP gems
  for(let i=xpGems.length-1;i>=0;i--){
    const g=xpGems[i]; g.life-=dt;
    const d=dist(player.x,player.y,g.x,g.y);
    if(d<player.pickupRange){
      const spd=200+d*2,dx3=player.x-g.x,dy3=player.y-g.y,dl2=Math.hypot(dx3,dy3)||1;
      g.x+=dx3/dl2*spd*dt; g.y+=dy3/dl2*spd*dt;
    }
    if(dist(player.x,player.y,g.x,g.y)<18||g.life<=0){ if(g.life>0){ gainXP(g.val); SFX.xpPickup(); } xpGems.splice(i,1); }
  }

  // Particles
  for(let i=particles.length-1;i>=0;i--){
    const p=particles[i]; p.life-=dt;
    if(p.vx!==undefined){p.x+=p.vx*dt;p.y+=p.vy*dt;p.vx*=0.9;p.vy*=0.9;}
    if(p.life<=0) particles.splice(i,1);
  }

  // Dmg nums
  for(let i=dmgNums.length-1;i>=0;i--){
    const d=dmgNums[i]; d.life-=dt; d.y+=d.vy*dt;
    if(d.life<=0) dmgNums.splice(i,1);
  }

  // Timer: 15 minutes = 900 seconds
  const remaining = 900 - gameTime;
  if(remaining<=0){ stageClear(); return; }
  const rm=Math.floor(remaining/60),rs=Math.floor(remaining%60);
  document.getElementById('timer').textContent=String(rm).padStart(2,'0')+':'+String(rs).padStart(2,'0');
  // Timer color warning
  document.getElementById('timer').style.color = remaining<60?'#ff6b63':remaining<180?'#fad86a':'var(--c-text)';
  // ë³´ìŠ¤ í˜ì´ì¦ˆ ë°°ê²½ ì•½ê°„ ë¶‰ê²Œ
  document.getElementById('stage-hud').style.color = isBossPhase ? '#ff6b63' : '';

  document.getElementById('hp').style.width=(player.hp/player.maxHp*100)+'%';
  document.getElementById('xp').style.width=(player.xp/player.xpNext*100)+'%';
  document.getElementById('kills').innerHTML='KILL <span>'+kills+'</span>';
  if(isBossPhase){
    document.getElementById('stage-hud').innerHTML=`<span style="color:#ff6b63;animation:none">âš” BOSS âš”</span>`;
  } else {
    document.getElementById('stage-hud').innerHTML=`STAGE <span>${currentStage}</span>`;
  }
  document.getElementById('coin-hud').textContent='ğŸª™ '+saveData.coins;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RENDER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function render(){
  ctx.clearRect(0,0,W,H);

  // Stage-themed background
  const stg = STAGES[currentStage-1] || STAGES[0];
  const theme = BG_THEMES[stg.bg] || BG_THEMES.forest;
  ctx.save();
  const S=72, wx=W/2-cam.x, wy=H/2-cam.y;
  const stx=Math.floor(-wx/S)-1,sty=Math.floor(-wy/S)-1;
  const etx=Math.ceil((W-wx)/S)+1,ety=Math.ceil((H-wy)/S)+1;
  ctx.fillStyle=theme.base; ctx.fillRect(0,0,W,H);
  for(let tx2=stx;tx2<=etx;tx2++){
    for(let ty2=sty;ty2<=ety;ty2++){
      const sx=wx+tx2*S,sy=wy+ty2*S;
      const px=((tx2%2)+2)%2,py=((ty2%2)+2)%2;
      if((px+py)%2===0){ ctx.fillStyle=theme.grid2; ctx.fillRect(sx,sy,S,S); }
    }
  }
  ctx.strokeStyle=theme.grid1; ctx.lineWidth=1;
  for(let tx2=stx;tx2<=etx;tx2++){const sx=wx+tx2*S;ctx.beginPath();ctx.moveTo(sx,0);ctx.lineTo(sx,H);ctx.stroke();}
  for(let ty2=sty;ty2<=ety;ty2++){const sy=wy+ty2*S;ctx.beginPath();ctx.moveTo(0,sy);ctx.lineTo(W,sy);ctx.stroke();}
  const vg=ctx.createRadialGradient(W/2,H/2,60,W/2,H/2,460);
  vg.addColorStop(0,theme.vignette[0]); vg.addColorStop(1,theme.vignette[1]);
  ctx.fillStyle=vg; ctx.fillRect(0,0,W,H);
  ctx.restore();

  const tx=W/2-cam.x, ty2=H/2-cam.y;
  ctx.save(); ctx.translate(tx,ty2);

  // Aura rings
  for(let wid of['aura','storm']){
    if(!player.weapons[wid]) continue;
    const lv=player.weapons[wid]-1,range=wid==='storm'?180:80+lv*20,color=wid==='storm'?'80,200,255':'160,100,255';
    ctx.beginPath();ctx.arc(player.x,player.y,range,0,Math.PI*2);
    ctx.strokeStyle=`rgba(${color},0.35)`;ctx.lineWidth=1.5;ctx.stroke();
    ctx.fillStyle=`rgba(${color},0.04)`;ctx.fill();
  }

  // Orbiting blades/phantom
  for(let wid of['blade','phantom']){
    if(!player.weapons[wid]) continue;
    const isPhantom=wid==='phantom';
    const cnt=isPhantom?4:2+(player.weapons[wid]-1)+(player._bladeExtra||0);
    const radius=isPhantom?80:60,color=isPhantom?'rgba(180,180,255,0.8)':'rgba(200,200,60,0.9)';
    for(let i=0;i<cnt;i++){
      const a=gameTime*(isPhantom?3:2.5)+i*(Math.PI*2/cnt);
      const bx=player.x+Math.cos(a)*radius,by=player.y+Math.sin(a)*radius;
      ctx.save(); ctx.translate(bx,by); ctx.rotate(a);
      ctx.shadowColor=color; ctx.shadowBlur=10; ctx.fillStyle=color;
      if(isPhantom){ ctx.beginPath();ctx.arc(0,-6,5,Math.PI,0);ctx.lineTo(5,4);ctx.quadraticCurveTo(0,8,-5,4);ctx.closePath();ctx.fill(); }
      else { ctx.fillRect(-10,-3,20,6); ctx.fillRect(-12,-5,4,10); }
      ctx.restore();
    }
  }

  // Particles
  for(let p of particles){
    const alpha=p.life/p.maxLife;
    if(p.type==='dot'){ ctx.globalAlpha=alpha;ctx.fillStyle=p.color;ctx.beginPath();ctx.arc(p.x,p.y,p.r,0,Math.PI*2);ctx.fill(); }
    else if(p.type==='ring'){ ctx.globalAlpha=alpha*0.6;ctx.strokeStyle=p.color;ctx.lineWidth=3;ctx.beginPath();ctx.arc(p.x,p.y,p.r,0,Math.PI*2);ctx.stroke(); }
    else if(p.type==='nova'){ const r=p.maxR*(1-p.life/p.maxLife);ctx.globalAlpha=alpha*0.5;ctx.fillStyle=p.color;ctx.beginPath();ctx.arc(p.x,p.y,r,0,Math.PI*2);ctx.fill();ctx.globalAlpha=alpha;ctx.strokeStyle=p.color;ctx.lineWidth=3;ctx.beginPath();ctx.arc(p.x,p.y,r,0,Math.PI*2);ctx.stroke(); }
    else if(p.type==='arc'){ ctx.save();ctx.globalAlpha=alpha*0.85;ctx.strokeStyle=p.color+'0.9)';ctx.lineWidth=5+alpha*4;ctx.lineCap='round';ctx.shadowColor=p.color+'0.8)';ctx.shadowBlur=12;ctx.beginPath();ctx.arc(p.x,p.y,p.range*(1.05-alpha*0.15),p.angle-p.arcHalf,p.angle+p.arcHalf);ctx.stroke();ctx.globalAlpha=alpha*0.5;ctx.strokeStyle='rgba(255,255,200,0.9)';ctx.lineWidth=1.5;ctx.beginPath();ctx.arc(p.x,p.y,p.range*(1.05-alpha*0.15),p.angle-p.arcHalf,p.angle+p.arcHalf);ctx.stroke();ctx.restore(); }
    else if(p.type==='lightning'){
      const topY=p.y-340;ctx.save();ctx.globalAlpha=alpha*0.9;ctx.strokeStyle='#ffffff';ctx.lineWidth=3;ctx.shadowColor='#88eeff';ctx.shadowBlur=18;ctx.beginPath();ctx.moveTo(p.x,topY);
      for(let s=1;s<=7;s++){const sy2=topY+(p.y-topY)*(s/7),jitter=s<7?Math.sin(s*73.1+p.life*40)*18:0;ctx.lineTo(p.x+jitter,sy2);}
      ctx.stroke();ctx.strokeStyle='#ccf8ff';ctx.lineWidth=1.5;ctx.shadowBlur=8;ctx.beginPath();ctx.moveTo(p.x,topY);
      for(let s=1;s<=7;s++){const sy2=topY+(p.y-topY)*(s/7),jitter=s<7?Math.sin(s*73.1+p.life*40)*18:0;ctx.lineTo(p.x+jitter,sy2);}
      ctx.stroke();ctx.restore();
    }
    ctx.globalAlpha=1;
  }

  // XP gems
  for(let g of xpGems){
    const pulse=0.8+0.2*Math.sin(gameTime*8+g.x);
    ctx.save();ctx.translate(g.x,g.y);ctx.shadowColor='#A855F7';ctx.shadowBlur=8;ctx.fillStyle='#A855F7';
    ctx.beginPath();ctx.moveTo(0,-g.r*pulse);ctx.lineTo(g.r*0.6*pulse,g.r*0.6*pulse);ctx.lineTo(-g.r*0.6*pulse,g.r*0.6*pulse);ctx.closePath();ctx.fill();
    ctx.restore();
  }

  // Floor items
  for(let fi of floorItems){
    const t=FLOOR_ITEM_TYPES[fi.kind];
    const bob=Math.sin(fi.bob*3)*4; // ìœ„ì•„ë˜ ë‘¥ì‹¤
    const alpha=fi.life<3?(fi.life/3):1; // 3ì´ˆ ë‚¨ìœ¼ë©´ íˆ¬ëª…í•´ì§€ê¸° ì‹œì‘
    const pulse=0.85+0.15*Math.sin(fi.bob*5);
    ctx.save();
    ctx.translate(fi.x, fi.y+bob);
    ctx.globalAlpha=alpha;
    // ë¹›ë‚˜ëŠ” ì›í˜• ë°°ê²½
    ctx.shadowColor=t.color; ctx.shadowBlur=18;
    ctx.fillStyle=t.color+'44';
    ctx.beginPath(); ctx.arc(0,0,fi.r*1.6*pulse,0,Math.PI*2); ctx.fill();
    ctx.strokeStyle=t.color+'99'; ctx.lineWidth=1.5;
    ctx.beginPath(); ctx.arc(0,0,fi.r*1.6*pulse,0,Math.PI*2); ctx.stroke();
    // ì•„ì´ì½˜ ì´ëª¨ì§€
    ctx.font=`${Math.round(fi.r*2.2)}px serif`;
    ctx.textAlign='center'; ctx.textBaseline='middle';
    ctx.shadowBlur=8; ctx.fillStyle='#fff';
    ctx.fillText(t.icon, 0, 0);
    // ë¼ë²¨
    ctx.font='700 8px Rajdhani,sans-serif';
    ctx.fillStyle=t.color; ctx.shadowBlur=0;
    ctx.fillText(t.label, 0, fi.r*2.2);
    ctx.restore();
  }

  // Enemies
  for(let e of enemies){
    ctx.save();ctx.translate(e.x,e.y);
    const flash=e.hitFlash>0;
    if(e.isBoss){
      const pulse=0.7+0.3*Math.sin(gameTime*4);
      ctx.globalAlpha=0.18*pulse;ctx.fillStyle=e.type.color;ctx.shadowColor=e.type.color;ctx.shadowBlur=40;
      ctx.beginPath();ctx.arc(0,0,e.type.size*1.6,0,Math.PI*2);ctx.fill();
      ctx.globalAlpha=flash?1:(e.type.alpha||1);ctx.shadowBlur=flash?30:20;
    } else {
      ctx.fillStyle=flash?'#FFFFFF':e.type.color;
      if(e.type.alpha) ctx.globalAlpha=e.type.alpha;
      ctx.shadowColor=e.type.color;ctx.shadowBlur=flash?14:6;
    }
    ctx.fillStyle=flash?'#FFFFFF':e.type.color;
    if(e.type.shape==='circle'){
      ctx.beginPath();ctx.arc(0,0,e.type.size,0,Math.PI*2);ctx.fill();
      if(!e.isBoss){ctx.fillStyle='#FF2200';ctx.shadowBlur=4;ctx.beginPath();ctx.arc(-4,-3,2.5,0,Math.PI*2);ctx.fill();ctx.beginPath();ctx.arc(4,-3,2.5,0,Math.PI*2);ctx.fill();}
    } else if(e.type.shape==='tri'){
      ctx.beginPath();ctx.moveTo(0,-e.type.size);ctx.lineTo(e.type.size*0.8,e.type.size*0.6);ctx.lineTo(-e.type.size*0.8,e.type.size*0.6);ctx.closePath();ctx.fill();
    } else {
      ctx.beginPath();
      for(let a=0;a<Math.PI*2;a+=0.2){const r2=e.type.size*(0.8+0.2*Math.sin(a*3+gameTime*2));a<0.2?ctx.moveTo(Math.cos(a)*r2,Math.sin(a)*r2):ctx.lineTo(Math.cos(a)*r2,Math.sin(a)*r2);}
      ctx.closePath();ctx.fill();
    }
    if(e.isBoss){
      ctx.globalAlpha=0.9;ctx.shadowBlur=0;ctx.font=`${Math.round(e.type.size*0.9)}px serif`;ctx.textAlign='center';ctx.textBaseline='middle';ctx.fillText(e.type.icon,0,0);
    }
    if(e.hp<e.maxHp){
      const bw=e.isBoss?e.type.size*3.2:e.type.size*2.6,bh=e.isBoss?5:2.5,bx2=-bw/2,by2=-e.type.size-(e.isBoss?14:7);
      ctx.globalAlpha=0.9;ctx.fillStyle='rgba(255,255,255,0.08)';ctx.fillRect(bx2,by2,bw,bh);
      ctx.fillStyle=e.isBoss?'#ff4444':'#e8453c';if(e.isBoss){ctx.shadowColor='#ff0000';ctx.shadowBlur=8;}
      ctx.fillRect(bx2,by2,bw*(e.hp/e.maxHp),bh);ctx.shadowBlur=0;
      if(e.isBoss){ctx.globalAlpha=0.75;ctx.font='700 9px Rajdhani,sans-serif';ctx.fillStyle='#ffaaaa';ctx.textAlign='center';ctx.fillText(e.type.name,0,by2-5);}
    }
    ctx.globalAlpha=1;ctx.restore();
  }

  // Projectiles
  for(let p of projectiles){
    ctx.save();ctx.translate(p.x,p.y);if(p.rot!==undefined) ctx.rotate(p.rot);
    ctx.shadowColor=p.glow;ctx.shadowBlur=12;ctx.fillStyle=p.color;
    if(p.type==='orb'){ctx.beginPath();ctx.arc(0,0,p.r,0,Math.PI*2);ctx.fill();ctx.fillStyle='rgba(255,255,255,0.5)';ctx.beginPath();ctx.arc(-2,-2,p.r*0.35,0,Math.PI*2);ctx.fill();}
    else if(p.type==='axe'){ctx.beginPath();ctx.moveTo(-p.r,-p.r*0.5);ctx.lineTo(p.r,0);ctx.lineTo(-p.r,p.r*0.5);ctx.closePath();ctx.fill();}
    else if(p.type==='cross'){ctx.fillRect(-p.r,-p.r*0.3,p.r*2,p.r*0.6);ctx.fillRect(-p.r*0.3,-p.r,p.r*0.6,p.r*2);}
    else if(p.type==='bolt'){ctx.shadowBlur=18;ctx.beginPath();ctx.moveTo(-p.r*2,-p.r);ctx.lineTo(0,p.r);ctx.lineTo(p.r*2,-p.r);ctx.closePath();ctx.fill();}
    else if(p.type==='meteor'){ctx.shadowBlur=20;ctx.beginPath();ctx.arc(0,0,p.r,0,Math.PI*2);ctx.fill();ctx.fillStyle='rgba(255,200,100,0.7)';ctx.beginPath();ctx.arc(-2,-3,p.r*0.5,0,Math.PI*2);ctx.fill();}
    ctx.restore();
  }

  // Player
  ctx.save();ctx.translate(player.x,player.y);
  if(player.invincible>0) ctx.globalAlpha=0.5+0.5*Math.sin(gameTime*20);
  ctx.scale(player.facing,1);
  ctx.globalAlpha*=0.25;ctx.fillStyle='#000';ctx.beginPath();ctx.ellipse(0,16,11,5,0,0,Math.PI*2);ctx.fill();
  ctx.globalAlpha=player.invincible>0?(0.5+0.5*Math.sin(gameTime*20)):1;
  ctx.shadowColor='rgba(124,92,252,0.7)';ctx.shadowBlur=16;ctx.fillStyle='#1a0d3a';
  ctx.beginPath();ctx.ellipse(0,3,13,17,0,0,Math.PI*2);ctx.fill();
  ctx.fillStyle='rgba(124,92,252,0.18)';ctx.beginPath();ctx.ellipse(-3,0,7,11,0.2,0,Math.PI*2);ctx.fill();
  ctx.shadowBlur=0;ctx.fillStyle='#e8cdb0';ctx.beginPath();ctx.ellipse(0,-6,6,7,0,0,Math.PI*2);ctx.fill();
  ctx.fillStyle='#e8453c';ctx.shadowColor='#e8453c';ctx.shadowBlur=8;
  ctx.beginPath();ctx.arc(-2.5,-6.5,1.8,0,Math.PI*2);ctx.fill();
  ctx.beginPath();ctx.arc(2.5,-6.5,1.8,0,Math.PI*2);ctx.fill();
  ctx.restore();

  // Cooldown bars
  ctx.save();ctx.translate(W/2-cam.x,H/2-cam.y);
  const mainWeapons=Object.keys(player.weapons).filter(w=>!WEAPON_DATA[w]?.evolved);
  const barW=40,barH=3,barGap=5,totalBarW=mainWeapons.length*(barW+barGap)-barGap;
  let bx=player.x-totalBarW/2;const by=player.y+28;
  for(let wid of mainWeapons){
    const wd=WEAPON_DATA[wid];if(!wd) continue;
    const cd=player.weaponCooldowns[wid]||0,maxCd=wd.cdBase*Math.pow(0.85,player.weapons[wid]-1)*player.cdrMul;
    const fill=Math.max(0,1-cd/maxCd),ready=fill>=0.99;
    ctx.fillStyle='rgba(255,255,255,0.08)';ctx.beginPath();ctx.roundRect?ctx.roundRect(bx,by,barW,barH,99):ctx.fillRect(bx,by,barW,barH);ctx.fill();
    ctx.fillStyle=ready?'#4ade80':`rgba(124,92,252,${0.4+fill*0.6})`;if(ready){ctx.shadowColor='#4ade80';ctx.shadowBlur=6;}
    ctx.beginPath();ctx.roundRect?ctx.roundRect(bx,by,barW*fill,barH,99):ctx.fillRect(bx,by,barW*fill,barH);ctx.fill();
    ctx.shadowBlur=0;ctx.font='8px serif';ctx.fillStyle='rgba(255,255,255,0.45)';ctx.textAlign='center';ctx.fillText(wd.icon,bx+barW/2,by-2);
    bx+=barW+barGap;
  }
  ctx.restore();

  // Damage numbers
  for(let d of dmgNums){
    const alpha=Math.min(1,d.life/0.8);
    ctx.save();ctx.globalAlpha=alpha;
    if(d.big){
      const t=1-d.life/1.5;ctx.font=`700 ${Math.round(38+t*6)}px 'Rajdhani',sans-serif`;ctx.fillStyle='#e8453c';ctx.strokeStyle='rgba(0,0,0,0.7)';ctx.lineWidth=3;ctx.textAlign='center';ctx.shadowColor='#e8453c';ctx.shadowBlur=24;ctx.strokeText(d.val,d.x,d.y);ctx.fillText(d.val,d.x,d.y);
    } else {
      ctx.font=`600 ${12+Math.round((1-alpha)*3)}px 'Rajdhani',sans-serif`;ctx.fillStyle=d.color||'#f0c040';ctx.shadowColor=d.color||'#f0c040';ctx.shadowBlur=4;ctx.textAlign='center';ctx.fillText(d.val,d.x,d.y);
    }
    ctx.restore();
  }
  ctx.restore();

  // Boss phase - ë¹¨ê°„ í…Œë‘ë¦¬ í”Œë˜ì‹œ
  if(isBossPhase){
    const pulse=0.4+0.3*Math.sin(gameTime*3);
    ctx.save();
    ctx.strokeStyle=`rgba(232,69,60,${pulse})`;
    ctx.lineWidth=6;
    ctx.strokeRect(3,3,W-6,H-6);
    ctx.font='700 11px Rajdhani,sans-serif';
    ctx.fillStyle=`rgba(255,100,80,${0.7+0.3*Math.sin(gameTime*4)})`;
    ctx.textAlign='center';
    ctx.fillText('âš” BOSS BATTLE âš”', W/2, H-14);
    ctx.restore();
  }

  // Boss HP bar
  if(activeBoss&&activeBoss.hp>0){
    const bx=W/2-180,by2=8,bw=360,bh=8,pct=activeBoss.hp/activeBoss.maxHp,pulse=0.85+0.15*Math.sin(gameTime*6);
    ctx.fillStyle='rgba(0,0,0,0.65)';ctx.beginPath();ctx.roundRect?ctx.roundRect(bx-2,by2-2,bw+4,bh+4,3):ctx.fillRect(bx-2,by2-2,bw+4,bh+4);ctx.fill();
    ctx.fillStyle='rgba(255,255,255,0.07)';ctx.beginPath();ctx.roundRect?ctx.roundRect(bx,by2,bw,bh,2):ctx.fillRect(bx,by2,bw,bh);ctx.fill();
    const g=ctx.createLinearGradient(bx,0,bx+bw*pct,0);g.addColorStop(0,'#7b0000');g.addColorStop(1,`rgba(255,${Math.round(40*pulse)},40,1)`);
    ctx.fillStyle=g;ctx.shadowColor='#ff2020';ctx.shadowBlur=10;
    ctx.beginPath();ctx.roundRect?ctx.roundRect(bx,by2,bw*pct,bh,2):ctx.fillRect(bx,by2,bw*pct,bh);ctx.fill();
    ctx.shadowBlur=0;ctx.font='700 11px Rajdhani,sans-serif';ctx.fillStyle='rgba(255,170,170,0.9)';ctx.textAlign='center';
    ctx.fillText(`${activeBoss.type.icon} ${activeBoss.type.name}`,W/2,by2+bh+12);
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  GAME OVER / CLEAR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function gameOver(){
  state='over';
  const remaining=900-gameTime,m=Math.floor((900-remaining)/60),s=Math.floor((900-remaining)%60);
  document.getElementById('rstats').innerHTML=`
    <div class="stat-row">
      <div class="stat-pill"><span class="val">${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}</span><span class="lbl">ìƒì¡´ ì‹œê°„</span></div>
      <div class="stat-pill"><span class="val">${kills}</span><span class="lbl">ì²˜ì¹˜ ìˆ˜</span></div>
      <div class="stat-pill"><span class="val">${player.level}</span><span class="lbl">ë ˆë²¨</span></div>
    </div>
    <span class="note">ìŠ¤í…Œì´ì§€ ${currentStage} â€” ${STAGES[currentStage-1].name}</span>`;
  let flashes=0;
  const fi=setInterval(()=>{
    ctx.save();ctx.fillStyle=`rgba(200,0,0,${0.6-flashes*0.12})`;ctx.fillRect(0,0,W,H);ctx.restore();
    flashes++;if(flashes>=5){clearInterval(fi);document.getElementById('goscreen').style.display='flex';}
  },80);
}

function stageClear(){
  state='cleared';
  cancelAnimationFrame(animId);
  const stg = STAGES[currentStage-1];
  // Mark cleared
  if(!saveData.clearedStages.includes(currentStage)) saveData.clearedStages.push(currentStage);
  // Award coins
  const earned = stg.coinReward;
  saveData.coins += earned;
  SFX.stageClear();
  document.getElementById('coin-hud').textContent = 'ğŸª™ '+saveData.coins;

  document.getElementById('cstats').innerHTML=`
    <div class="stat-row">
      <div class="stat-pill"><span class="val">${kills}</span><span class="lbl">ì²˜ì¹˜ ìˆ˜</span></div>
      <div class="stat-pill"><span class="val">${player.level}</span><span class="lbl">ë ˆë²¨</span></div>
      <div class="stat-pill"><span class="val">Stage ${currentStage}</span><span class="lbl">í´ë¦¬ì–´</span></div>
    </div>`;
  document.getElementById('coin-reward').textContent = `ğŸª™ +${earned} ì½”ì¸ íšë“!`;

  // Flash gold
  let flashes=0;
  const fi=setInterval(()=>{
    ctx.save();ctx.fillStyle=`rgba(240,192,64,${0.4-flashes*0.08})`;ctx.fillRect(0,0,W,H);ctx.restore();
    flashes++;if(flashes>=5){clearInterval(fi);document.getElementById('clearscreen').style.display='flex';}
  },80);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INPUT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.addEventListener('keydown',e=>{keys[e.code]=true;e.preventDefault(); getAudioCtx();});
document.addEventListener('keyup',e=>{keys[e.code]=false;});
document.addEventListener('click', ()=>getAudioCtx(), {once:true});
document.addEventListener('touchstart', ()=>getAudioCtx(), {once:true});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CANVAS SCALING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let scale=1;
function resizeCanvas(){
  const maxW=window.innerWidth,maxH=window.innerHeight;
  scale=Math.min(maxW/W,maxH/H,1);
  const gw=document.getElementById('gw');
  gw.style.width=(W*scale)+'px'; gw.style.height=(H*scale)+'px';
  gw.style.transform=`scale(${scale})`; gw.style.transformOrigin='top left';
  gw.style.left=Math.round((maxW-W*scale)/2)+'px'; gw.style.top=Math.round((maxH-H*scale)/2)+'px';
  canvas.width=W; canvas.height=H;
}
window.addEventListener('resize',resizeCanvas); resizeCanvas();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  VIRTUAL JOYSTICK (touch only)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const jBase=document.getElementById('joystick-base');
const jThumb=document.getElementById('joystick-thumb');
let jActive=false,jId=null,jOrigin={x:0,y:0},jDelta={x:0,y:0};
const JR=38;

function jStart(cx,cy){
  const gw=document.getElementById('gw'),rect=gw.getBoundingClientRect();
  const lx=(cx-rect.left)/scale,ly=(cy-rect.top)/scale;
  if(lx>W/2) return false;
  jActive=true;jBase.style.left=(lx-50)+'px';jBase.style.bottom='auto';jBase.style.top=(ly-50)+'px';
  jOrigin={x:lx,y:ly};jDelta={x:0,y:0};jThumb.style.left='50%';jThumb.style.top='50%';
  return true;
}
function jMove(cx,cy){
  if(!jActive) return;
  const gw=document.getElementById('gw'),rect=gw.getBoundingClientRect();
  const lx=(cx-rect.left)/scale,ly=(cy-rect.top)/scale;
  const dx=lx-jOrigin.x,dy=ly-jOrigin.y,len=Math.hypot(dx,dy)||1,clamped=Math.min(len,JR);
  jDelta={x:(dx/len)*clamped/JR,y:(dy/len)*clamped/JR};
  jThumb.style.left=(50+jDelta.x*JR)+'px';jThumb.style.top=(50+jDelta.y*JR)+'px';jThumb.style.transform='translate(-50%,-50%)';
}
function jEnd(){ jActive=false;jId=null;jDelta={x:0,y:0};jThumb.style.left='50%';jThumb.style.top='50%';jBase.style.left='20px';jBase.style.top='auto';jBase.style.bottom='20px'; }
function getJoystickInput(){ return jActive?jDelta:{x:0,y:0}; }

canvas.addEventListener('touchstart',e=>{e.preventDefault();for(const t of e.changedTouches){if(jId===null&&jStart(t.clientX,t.clientY)){jId=t.identifier;}}},{passive:false});
canvas.addEventListener('touchmove',e=>{e.preventDefault();for(const t of e.changedTouches){if(t.identifier===jId)jMove(t.clientX,t.clientY);}},{passive:false});
canvas.addEventListener('touchend',e=>{e.preventDefault();for(const t of e.changedTouches){if(t.identifier===jId)jEnd();}},{passive:false});
canvas.addEventListener('touchcancel',e=>{e.preventDefault();jEnd();},{passive:false});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  START SCREEN BG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
(function initRender(){ animId=requestAnimationFrame(initRender); renderStartBg(); })();
function renderStartBg(){
  ctx.fillStyle='#0d1018';ctx.fillRect(0,0,W,H);
  ctx.strokeStyle='rgba(255,255,255,0.04)';ctx.lineWidth=1;
  for(let x=0;x<W;x+=72){ctx.beginPath();ctx.moveTo(x,0);ctx.lineTo(x,H);ctx.stroke();}
  for(let y=0;y<H;y+=72){ctx.beginPath();ctx.moveTo(0,y);ctx.lineTo(W,y);ctx.stroke();}
  const vg=ctx.createRadialGradient(W/2,H/2,60,W/2,H/2,420);
  vg.addColorStop(0,'rgba(124,92,252,0.06)');vg.addColorStop(1,'rgba(0,0,0,0.6)');
  ctx.fillStyle=vg;ctx.fillRect(0,0,W,H);
}
</script>
</body>
</html>
