<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<title>ë‹¤í¬ ì„œë°”ì´ë²„</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;500;600;700&family=Noto+Sans+KR:wght@300;400;500;700&display=swap');
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
:root{
  --c-bg:#0d0f14; --c-surface:#13161e; --c-surface2:#1a1f2b;
  --c-border:#252c3d; --c-border2:#2e3850;
  --c-hp:#e8453c; --c-hp2:#ff6b63;
  --c-xp:#7c5cfc; --c-xp2:#a78bfa;
  --c-gold:#f0c040; --c-gold2:#fad86a;
  --c-evo:#f97316; --c-evo2:#fb923c;
  --c-text:#c9d1e8; --c-text2:#8899bb;
  --c-green:#4ade80; --c-teal:#2dd4bf;
  --c-coin:#FFD700;
  --c-miner:#c8a060;
}
html,body{width:100%;height:100%;background:var(--c-bg);font-family:'Noto Sans KR',sans-serif;overflow:hidden;user-select:none;touch-action:none;position:relative;}
#gw{position:absolute;}
canvas{display:block;border:1px solid var(--c-border2);border-radius:4px;
  box-shadow:0 0 0 1px rgba(255,255,255,0.04),0 8px 32px rgba(0,0,0,0.6),0 0 60px rgba(124,92,252,0.08);touch-action:none;}

/* HUD */
#hud{position:absolute;top:0;left:0;right:0;display:flex;justify-content:space-between;align-items:flex-start;padding:10px 14px;pointer-events:none;z-index:10;}
.hl{display:flex;flex-direction:column;gap:5px;}
.bw{display:flex;align-items:center;gap:7px;}
.bl{font-family:'Rajdhani',sans-serif;font-size:10px;font-weight:600;color:var(--c-text2);letter-spacing:1.5px;text-transform:uppercase;min-width:22px;}
.bb{width:clamp(100px,22vw,170px);height:7px;background:rgba(255,255,255,0.06);border-radius:99px;overflow:hidden;}
#hp{height:100%;border-radius:99px;background:linear-gradient(90deg,var(--c-hp),var(--c-hp2));box-shadow:0 0 8px rgba(232,69,60,0.5);transition:width 0.15s ease;}
#xp{height:100%;border-radius:99px;background:linear-gradient(90deg,var(--c-xp),var(--c-xp2));box-shadow:0 0 8px rgba(124,92,252,0.5);transition:width 0.25s ease;}
#lvl{font-family:'Rajdhani',sans-serif;font-size:11px;font-weight:600;color:var(--c-text2);letter-spacing:2px;text-transform:uppercase;margin-top:1px;}
#lvl span{color:var(--c-gold);font-size:13px;font-weight:700;}
#char-badge{font-family:'Rajdhani',sans-serif;font-size:9px;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;margin-top:2px;}
#timer{font-family:'Rajdhani',sans-serif;font-size:clamp(18px,4vw,26px);font-weight:700;color:var(--c-text);letter-spacing:4px;}
#kills{font-family:'Rajdhani',sans-serif;font-size:11px;font-weight:600;color:var(--c-text2);letter-spacing:2px;text-transform:uppercase;text-align:right;}
#kills span{color:var(--c-hp2);}
#coin-hud{font-family:'Rajdhani',sans-serif;font-size:12px;font-weight:700;color:var(--c-coin);letter-spacing:2px;text-align:right;margin-top:3px;}
#stage-hud{font-family:'Rajdhani',sans-serif;font-size:10px;font-weight:600;color:var(--c-text2);letter-spacing:2px;text-transform:uppercase;text-align:center;}
#stage-hud span{color:var(--c-evo2);}

/* ì¿¨ë‹¤ìš´ HUD */
#cooldown-hud{position:absolute;bottom:8px;left:50%;transform:translateX(-50%);display:flex;gap:6px;align-items:flex-end;z-index:10;pointer-events:none;}
.cd-slot{display:flex;flex-direction:column;align-items:center;gap:3px;min-width:44px;}
.cd-icon{font-size:18px;line-height:1;filter:drop-shadow(0 0 6px rgba(124,92,252,0.7));}
.cd-icon.evolved{filter:drop-shadow(0 0 8px rgba(249,115,22,0.9));}
.cd-bar-wrap{width:44px;height:4px;background:rgba(255,255,255,0.07);border-radius:99px;overflow:hidden;border:1px solid rgba(255,255,255,0.08);}
.cd-bar{height:100%;border-radius:99px;background:linear-gradient(90deg,var(--c-xp),var(--c-xp2));transition:width 0.05s linear;}
.cd-bar.ready{background:linear-gradient(90deg,#4ade80,#86efac);box-shadow:0 0 6px rgba(74,222,128,0.8);}
.cd-label{font-family:'Rajdhani',sans-serif;font-size:8px;font-weight:700;color:var(--c-text2);letter-spacing:0.5px;text-align:center;max-width:44px;overflow:hidden;white-space:nowrap;text-overflow:ellipsis;}
.cd-label.evo-lbl{color:var(--c-evo2);}

/* OVERLAYS */
.ov{position:absolute;top:0;left:0;right:0;bottom:0;display:flex;flex-direction:column;align-items:center;justify-content:center;background:rgba(8,10,16,0.93);z-index:100;backdrop-filter:blur(6px);pointer-events:auto;touch-action:auto;overflow-y:auto;}
.ov-title{font-family:'Rajdhani',sans-serif;font-weight:700;color:var(--c-text);letter-spacing:6px;text-transform:uppercase;margin-bottom:4px;}
.ov-sub{font-size:11px;font-weight:500;color:var(--c-text2);letter-spacing:4px;text-transform:uppercase;margin-bottom:28px;}
.sep{width:280px;height:1px;background:linear-gradient(90deg,transparent,var(--c-border2),transparent);margin:16px 0;}
.btn{font-family:'Rajdhani',sans-serif;font-size:13px;font-weight:700;letter-spacing:3px;text-transform:uppercase;color:var(--c-bg);background:var(--c-gold);border:none;border-radius:3px;padding:12px 40px;cursor:pointer;transition:all 0.18s ease;margin:5px;min-height:44px;}
.btn:hover{background:var(--c-gold2);transform:translateY(-1px);box-shadow:0 4px 20px rgba(240,192,64,0.35);}
.btn:active{transform:translateY(0);opacity:0.85;}
.btn-secondary{background:var(--c-surface2);color:var(--c-text);border:1px solid var(--c-border2);}
.btn-secondary:hover{background:var(--c-border2);transform:translateY(-1px);}

/* Character Select */
#char-select{z-index:105;}
.char-grid{display:flex;gap:16px;flex-wrap:wrap;justify-content:center;max-width:600px;padding:0 16px;}
.char-card{width:150px;background:var(--c-surface);border:1px solid var(--c-border2);border-radius:8px;padding:18px 12px 14px;cursor:pointer;transition:all 0.2s;text-align:center;position:relative;}
.char-card:hover{transform:translateY(-3px);border-color:var(--c-gold);box-shadow:0 8px 24px rgba(240,192,64,0.2);}
.char-card.selected{border-color:var(--c-gold);box-shadow:0 0 0 2px rgba(240,192,64,0.4);}
.char-card.miner-card{border-color:rgba(200,160,96,0.5);background:rgba(20,15,5,0.9);}
.char-card.miner-card:hover,.char-card.miner-card.selected{border-color:var(--c-miner);box-shadow:0 8px 24px rgba(200,160,96,0.25);}
.char-icon{font-size:36px;margin-bottom:8px;}
.char-name{font-family:'Rajdhani',sans-serif;font-size:14px;font-weight:700;color:var(--c-text);margin-bottom:4px;letter-spacing:1px;}
.char-card.miner-card .char-name{color:var(--c-miner);}
.char-desc{font-size:9px;color:var(--c-text2);line-height:1.6;}
.char-stats{margin-top:8px;font-family:'Rajdhani',sans-serif;font-size:8px;color:var(--c-text2);letter-spacing:0.5px;}
.char-tag{display:inline-block;font-family:'Rajdhani',sans-serif;font-size:8px;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;padding:2px 8px;border-radius:2px;margin-top:6px;}
.tag-warrior{background:rgba(232,69,60,0.2);color:var(--c-hp2);border:1px solid rgba(232,69,60,0.3);}
.tag-miner{background:rgba(200,160,96,0.2);color:var(--c-miner);border:1px solid rgba(200,160,96,0.3);}
.tag-batter{background:rgba(251,146,60,0.2);color:#fb923c;border:1px solid rgba(251,146,60,0.3);}
.char-card.batter-card{border-color:rgba(251,146,60,0.5);background:rgba(20,10,0,0.9);}
.char-card.batter-card:hover,.char-card.batter-card.selected{border-color:#fb923c;box-shadow:0 8px 24px rgba(251,146,60,0.25);}
.char-card.batter-card .char-name{color:#fb923c;}
.tag-gunner{background:rgba(156,163,175,0.2);color:#d1d5db;border:1px solid rgba(156,163,175,0.3);}
.char-card.gunner-card{border-color:rgba(156,163,175,0.4);background:rgba(10,12,16,0.95);}
.char-card.gunner-card:hover,.char-card.gunner-card.selected{border-color:#d1d5db;box-shadow:0 8px 24px rgba(200,210,220,0.2);}
.char-card.gunner-card .char-name{color:#d1d5db;}

/* Level Up */
#luscreen{z-index:50;}
#lu-title{font-family:'Rajdhani',sans-serif;font-size:13px;font-weight:700;color:var(--c-text2);letter-spacing:4px;text-transform:uppercase;margin-bottom:16px;text-align:center;}
#lu-title.evo{color:var(--c-evo2);}
.cards{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;max-width:95vw;padding:0 10px;}
.card{width:clamp(120px,28vw,150px);background:var(--c-surface);border:1px solid var(--c-border2);border-radius:6px;padding:16px 12px 12px;cursor:pointer;transition:all 0.18s ease;position:relative;overflow:hidden;}
.card::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,transparent,var(--c-xp),transparent);opacity:0;transition:opacity 0.18s;}
.card:hover,.card:active{border-color:var(--c-xp2);transform:translateY(-2px);box-shadow:0 8px 24px rgba(0,0,0,0.4);}
.card:hover::before,.card:active::before{opacity:1;}
.card.evo-card{border-color:rgba(249,115,22,0.5);background:rgba(30,15,5,0.8);}
.card.evo-card::before{background:linear-gradient(90deg,transparent,var(--c-evo),transparent);}
.card.evo-card:hover,.card.evo-card:active{border-color:var(--c-evo2);}
.ci{font-size:26px;margin-bottom:8px;text-align:center;line-height:1;}
.cn{font-family:'Rajdhani',sans-serif;font-size:12px;font-weight:700;color:var(--c-text);text-align:center;margin-bottom:5px;letter-spacing:0.5px;}
.card.evo-card .cn{color:var(--c-evo2);}
.cd{font-size:10px;color:var(--c-text2);text-align:center;line-height:1.5;font-weight:400;}
.evo-badge{font-family:'Rajdhani',sans-serif;font-size:9px;font-weight:700;color:var(--c-evo);text-align:center;margin-top:6px;letter-spacing:2px;text-transform:uppercase;}

/* Slots */
#slots{position:absolute;bottom:60px;right:8px;display:flex;flex-direction:column;gap:3px;z-index:10;pointer-events:none;}
.slot{display:flex;align-items:center;gap:5px;padding:3px 7px 3px 5px;border-radius:4px;backdrop-filter:blur(4px);}
.slot.wpn{background:rgba(13,15,20,0.75);border:1px solid var(--c-border);}
.slot.itm{background:rgba(13,15,20,0.65);border:1px solid rgba(45,212,191,0.2);}
.slot.evolved{background:rgba(20,8,0,0.8);border:1px solid rgba(249,115,22,0.4);box-shadow:0 0 8px rgba(249,115,22,0.15);}
.slot.armor-slot{background:rgba(13,15,20,0.75);border:1px solid rgba(100,200,255,0.3);}
.si{font-size:12px;line-height:1;}
.sn{font-family:'Rajdhani',sans-serif;font-size:9px;font-weight:600;color:var(--c-text2);letter-spacing:0.5px;}
.sn.item-name{color:var(--c-teal);}
.sn.evo-name{color:var(--c-evo2);}
.sn.armor-name{color:#88ccff;}
.slv{font-family:'Rajdhani',sans-serif;font-size:9px;font-weight:700;color:var(--c-text2);margin-left:auto;padding-left:6px;}
.slv.maxed{color:var(--c-gold);}

/* Stage select */
#stage-select{z-index:100;}
.stage-grid{display:flex;gap:12px;flex-wrap:wrap;justify-content:center;max-width:680px;padding:0 16px;}
.stage-card{width:120px;background:var(--c-surface);border:1px solid var(--c-border2);border-radius:8px;padding:16px 10px 12px;cursor:pointer;transition:all 0.2s;text-align:center;position:relative;}
.stage-card.locked{opacity:0.4;cursor:not-allowed;filter:grayscale(1);}
.stage-card:not(.locked):hover{transform:translateY(-3px);border-color:var(--c-gold);box-shadow:0 8px 24px rgba(240,192,64,0.2);}
.stage-card .s-num{font-family:'Rajdhani',sans-serif;font-size:28px;font-weight:700;color:var(--c-gold);}
.stage-card .s-name{font-family:'Rajdhani',sans-serif;font-size:11px;font-weight:600;color:var(--c-text);margin:4px 0;letter-spacing:1px;}
.stage-card .s-diff{font-size:10px;color:var(--c-text2);margin-bottom:6px;}
.stage-card .s-clear{font-family:'Rajdhani',sans-serif;font-size:9px;font-weight:700;color:var(--c-green);letter-spacing:2px;}
.stage-card .s-lock{font-size:20px;position:absolute;top:8px;right:8px;}
.stage-card .s-coin{font-family:'Rajdhani',sans-serif;font-size:10px;color:var(--c-coin);margin-top:4px;}

/* Shop overlay */
#shopscreen{z-index:110;}
.shop-title{font-family:'Rajdhani',sans-serif;font-size:28px;font-weight:700;color:var(--c-gold);letter-spacing:6px;text-transform:uppercase;margin-bottom:4px;}
.shop-sub{font-family:'Rajdhani',sans-serif;font-size:11px;color:var(--c-text2);letter-spacing:3px;margin-bottom:6px;}
.coin-display{font-family:'Rajdhani',sans-serif;font-size:18px;font-weight:700;color:var(--c-coin);margin-bottom:16px;}
.shop-tabs{display:flex;gap:8px;margin-bottom:16px;}
.shop-tab{font-family:'Rajdhani',sans-serif;font-size:11px;font-weight:700;letter-spacing:2px;text-transform:uppercase;padding:6px 18px;border-radius:3px;cursor:pointer;border:1px solid var(--c-border2);color:var(--c-text2);background:var(--c-surface);transition:all 0.15s;}
.shop-tab.active{background:var(--c-gold);color:var(--c-bg);border-color:var(--c-gold);}
.shop-grid{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;max-width:720px;padding:0 12px;max-height:320px;overflow-y:auto;}
.shop-item{width:130px;background:var(--c-surface);border:1px solid var(--c-border2);border-radius:6px;padding:14px 10px 10px;cursor:pointer;transition:all 0.18s;text-align:center;position:relative;}
.shop-item:hover:not(.owned):not(.cant-afford){transform:translateY(-2px);border-color:var(--c-gold);box-shadow:0 6px 20px rgba(240,192,64,0.2);}
.shop-item.owned{border-color:var(--c-green);opacity:0.7;cursor:default;}
.shop-item.cant-afford{opacity:0.45;cursor:not-allowed;}
.shop-item .si2{font-size:28px;margin-bottom:8px;}
.shop-item .sn2{font-family:'Rajdhani',sans-serif;font-size:11px;font-weight:700;color:var(--c-text);margin-bottom:4px;}
.shop-item .sd2{font-size:9px;color:var(--c-text2);line-height:1.5;margin-bottom:6px;}
.shop-item .sp2{font-family:'Rajdhani',sans-serif;font-size:12px;font-weight:700;color:var(--c-coin);}
.shop-item .sp2.owned-lbl{color:var(--c-green);}
.shop-item.chest-item{border-color:rgba(249,115,22,0.4);background:rgba(20,10,0,0.6);}
.shop-item.chest-item:hover{border-color:var(--c-evo2);}

/* Stat pills */
.stat-row{display:flex;gap:12px;justify-content:center;margin-bottom:6px;}
.stat-pill{background:var(--c-surface2);border:1px solid var(--c-border2);border-radius:4px;padding:6px 14px;text-align:center;min-width:75px;}
.stat-pill .val{font-family:'Rajdhani',sans-serif;font-size:20px;font-weight:700;color:var(--c-text);display:block;line-height:1.2;}
.stat-pill .lbl{font-family:'Rajdhani',sans-serif;font-size:9px;font-weight:600;color:var(--c-text2);letter-spacing:1.5px;text-transform:uppercase;}
#rstats,#wstats{color:var(--c-text2);font-size:13px;line-height:2.2;text-align:center;margin:8px 0 20px;font-family:'Rajdhani',sans-serif;font-weight:500;letter-spacing:1px;}
.note{font-size:10px;color:rgba(137,153,187,0.45);display:block;margin-top:4px;}

#hint{position:absolute;bottom:8px;left:50%;transform:translateX(-50%);font-family:'Rajdhani',sans-serif;font-size:10px;font-weight:500;color:rgba(137,153,187,0.3);letter-spacing:2px;text-transform:uppercase;pointer-events:none;z-index:10;white-space:nowrap;}
#evo-notif{position:absolute;top:52px;left:50%;transform:translateX(-50%);font-family:'Rajdhani',sans-serif;font-size:12px;font-weight:700;color:var(--c-evo2);letter-spacing:2px;text-transform:uppercase;background:rgba(20,10,0,0.88);border:1px solid rgba(249,115,22,0.4);border-radius:3px;padding:6px 16px;pointer-events:none;z-index:20;opacity:0;transition:opacity 0.25s ease;white-space:nowrap;}

/* Chest Result */
#chest-result{z-index:120;}

@keyframes deathPulse{0%{opacity:1;transform:scale(1);}50%{opacity:0.7;transform:scale(1.04);}100%{opacity:1;transform:scale(1);}}
@keyframes pickaxeSpin{0%{transform:rotate(0deg);}100%{transform:rotate(360deg);}}
@keyframes fadeIn{from{opacity:0;transform:translateY(8px);}to{opacity:1;transform:translateY(0);}}

/* â˜… ì¼ì‹œì •ì§€ ë²„íŠ¼ - ì˜¤ë¥¸ìª½ ìƒë‹¨ìœ¼ë¡œ ì´ë™ */
#pause-btn{
  position:absolute;top:8px;right:90px;left:auto;transform:none;
  z-index:15;pointer-events:auto;
  background:rgba(13,15,20,0.82);border:1px solid var(--c-border2);
  border-radius:5px;color:var(--c-text2);font-size:12px;font-family:'Rajdhani',sans-serif;
  font-weight:700;letter-spacing:2px;padding:3px 10px;cursor:pointer;
  transition:all 0.15s;min-height:28px;line-height:1.6;
}
#pause-btn:hover{background:var(--c-surface2);color:var(--c-text);}

/* ì¼ì‹œì •ì§€ ì˜¤ë²„ë ˆì´ */
#pausescreen{z-index:90;}

/* ë°ë¯¸ì§€ í†µê³„ ì˜¤ë²„ë ˆì´ */
#statsscreen{z-index:95;}
.dmg-stat-list{width:min(440px,90vw);margin-bottom:10px;}
.dmg-row{display:flex;align-items:center;gap:8px;margin-bottom:9px;animation:fadeIn 0.3s ease both;}
.dmg-icon{font-size:15px;width:20px;text-align:center;flex-shrink:0;}
.dmg-name{font-family:'Rajdhani',sans-serif;font-size:11px;font-weight:600;color:var(--c-text);min-width:86px;letter-spacing:0.5px;}
.dmg-bar-bg{flex:1;height:11px;background:rgba(255,255,255,0.06);border-radius:99px;overflow:hidden;border:1px solid rgba(255,255,255,0.05);}
.dmg-bar-fill{height:100%;border-radius:99px;transition:width 0.5s ease;}
.dmg-val{font-family:'Rajdhani',sans-serif;font-size:10px;font-weight:700;color:var(--c-text2);min-width:66px;text-align:right;letter-spacing:0.5px;}
.dmg-pct{font-family:'Rajdhani',sans-serif;font-size:10px;font-weight:700;min-width:36px;text-align:right;}

/* ì„¸ë¡œ ë°©í–¥ ê²½ê³  */
#rotate-prompt{
  display:none;position:fixed;top:0;left:0;right:0;bottom:0;
  background:#0d0f14;z-index:9999;
  flex-direction:column;align-items:center;justify-content:center;gap:20px;
}
#rotate-prompt.show{display:flex;}
.rot-icon{font-size:52px;animation:rotAnim 1.1s ease-in-out infinite alternate;}
.rot-text{font-family:'Rajdhani',sans-serif;font-size:14px;font-weight:700;color:var(--c-text2);letter-spacing:3px;text-transform:uppercase;}
@keyframes rotAnim{from{transform:rotate(0deg);}to{transform:rotate(90deg);}}

/* Mobile Joystick */
#joystick-zone{display:none;position:absolute;left:0;top:0;right:0;bottom:0;z-index:30;pointer-events:none;}
#joystick-base{position:absolute;left:20px;bottom:20px;top:auto;width:100px;height:100px;border-radius:50%;background:rgba(255,255,255,0.04);border:1.5px solid rgba(255,255,255,0.10);pointer-events:none;}
#joystick-thumb{position:absolute;width:42px;height:42px;border-radius:50%;background:rgba(124,92,252,0.45);border:1.5px solid rgba(167,139,250,0.55);box-shadow:0 0 12px rgba(124,92,252,0.35);transform:translate(-50%,-50%);left:50%;top:50%;pointer-events:none;}

@media (pointer:coarse){
  #joystick-zone{display:block;}
  #hint{display:none;}
  .bb{width:clamp(70px,16vw,130px);}
  #slots{bottom:60px;right:6px;}
  #cooldown-hud{bottom:6px;}

/* ì„¸ë¡œ ëª¨ë“œ (ìº”ë²„ìŠ¤ê°€ ì‘ì„ ë•Œ) ëŒ€ì‘ - HUD ì¶•ì†Œ */
@media (max-width: 500px) {
  #timer{font-size:18px;letter-spacing:2px;}
  .bb{width:clamp(70px,28vw,130px);}
  #pause-btn{font-size:10px;padding:4px 8px;}
  #hud{padding:7px 8px;}
  .cd-icon{font-size:15px;}
  .cd-label{font-size:8px;}
  .cd-bar-wrap{width:36px;}
}
}
@media (pointer:fine){
  #joystick-zone{display:none !important;}
}
</style>
</head>
<body>
<div id="gw">
  <canvas id="c"></canvas>

  <!-- HUD -->
  <div id="hud">
    <div class="hl">
      <div class="bw"><span class="bl">HP</span><div class="bb"><div id="hp" style="width:100%"></div></div></div>
      <div class="bw"><span class="bl" style="color:var(--c-xp2)">XP</span><div class="bb"><div id="xp" style="width:0%"></div></div></div>
      <div id="lvl">LV <span id="lvn">1</span></div>
      <div id="char-badge"></div>
    </div>
    <div style="text-align:center">
      <div id="stage-hud">STAGE <span id="stage-num">1</span></div>
      <div id="timer">15:00</div>
    </div>
    <div style="text-align:right">
      <div id="kills">KILL <span>0</span></div>
      <div id="coin-hud">ğŸª™ 0</div>
      <div style="margin-top:4px;pointer-events:auto;">
        <button id="snd-btn" onclick="toggleSound()" style="background:none;border:1px solid rgba(255,255,255,0.15);border-radius:4px;color:var(--c-text2);font-size:14px;padding:2px 7px;cursor:pointer;line-height:1.4;" title="ì†Œë¦¬ ì¼œê¸°/ë„ê¸°">ğŸ”Š</button>
      </div>
    </div>
  </div>

  <div id="cooldown-hud"></div>
  <div id="slots"></div>
  <div id="hint">W A S D Â· ì´ë™ Â· ìë™ ê³µê²©</div>
  <div id="evo-notif"></div>

  <!-- â˜… ì¼ì‹œì •ì§€ ë²„íŠ¼ (ì˜¤ë¥¸ìª½ ìƒë‹¨) -->
  <button id="pause-btn" onclick="togglePause()" style="display:none">â¸ ì¼ì‹œì •ì§€</button>

  <!-- ì„¸ë¡œ ë°©í–¥ ê²½ê³  -->
  <div id="rotate-prompt">
    <div class="rot-icon">ğŸ“±</div>
    <div class="rot-text">ê¸°ê¸°ë¥¼ ê°€ë¡œë¡œ ëŒë ¤ì£¼ì„¸ìš”</div>
    <div style="font-family:'Rajdhani',sans-serif;font-size:11px;color:rgba(137,153,187,0.5);letter-spacing:2px;">ROTATE DEVICE</div>
  </div>

  <div id="joystick-zone">
    <div id="joystick-base"><div id="joystick-thumb"></div></div>
  </div>

  <!-- Start Screen -->
  <div class="ov" id="ss">
    <div class="ov-title" style="font-size:clamp(28px,8vw,42px);margin-bottom:4px;">ë‹¤í¬ ì„œë°”ì´ë²„</div>
    <div class="ov-sub">Dark Survivor</div>
    <div class="sep"></div>
    <button class="btn" onclick="showCharSelect()">ê²Œì„ ì‹œì‘</button>
    <div style="margin-top:14px;font-family:'Rajdhani',sans-serif;font-size:10px;font-weight:500;color:var(--c-text2);letter-spacing:2px;text-transform:uppercase;text-align:center;line-height:2;">
      15ë¶„ ìƒì¡´ Â· 5ë¶„ë§ˆë‹¤ ë³´ìŠ¤ Â· í´ë¦¬ì–´ ì‹œ ì½”ì¸ íšë“<br>
      <span style="color:var(--c-evo2)">ë§Œë ™+ì•„ì´í…œ â†’ ì§„í™”</span> Â· <span style="color:var(--c-miner)">ì „ì‚¬ Â· ê´‘ë¶€ Â· </span><span style="color:#fb923c">íƒ€ì</span> Â· <span style="color:#d1d5db">ìƒ·ê±´ë§¨</span>
    </div>
  </div>

  <!-- Character Select -->
  <div class="ov" id="char-select" style="display:none">
    <div class="ov-title" style="font-size:clamp(22px,6vw,32px);">ìºë¦­í„° ì„ íƒ</div>
    <div class="ov-sub">Choose Your Hero</div>
    <div class="char-grid">
      <div class="char-card" id="cc-warrior" onclick="selectChar('warrior')">
        <div class="char-icon">âš”ï¸</div>
        <div class="char-name">ì „ì‚¬</div>
        <div class="char-desc">ê°•ì¸í•œ ì „íˆ¬ ì „ë¬¸ê°€<br>ê· í˜•ì¡íŒ ìŠ¤íƒ¯</div>
        <div class="char-stats">HP 100 Â· SPD 130<br>ì‹œì‘ ë¬´ê¸°: ë§ˆë²• êµ¬ì²´</div>
        <div class="char-tag tag-warrior">WARRIOR</div>
      </div>
      <div class="char-card miner-card" id="cc-miner" onclick="selectChar('miner')">
        <div class="char-icon">â›ï¸</div>
        <div class="char-name">ê´‘ë¶€</div>
        <div class="char-desc">ë¶€ë©”ë‘ ê³¡ê´­ì´ë¡œ ì‹¸ìš´ë‹¤<br>ì½”ì¸ & XP ìˆ˜ì§‘ íŠ¹í™”</div>
        <div class="char-stats">HP 85 Â· SPD 120<br>ì‹œì‘ ë¬´ê¸°: ê³¡ê´­ì´</div>
        <div class="char-tag tag-miner">MINER</div>
      </div>
      <div class="char-card batter-card" id="cc-hunter" onclick="selectChar('hunter')">
        <div class="char-icon">ğŸ</div>
        <div class="char-name">íƒ€ì</div>
        <div class="char-desc">ì•¼êµ¬ë°©ë§ì´ë¡œ ì ì„ ë‚ ë ¤ë²„ë ¤<br>ê°•íƒ€ & ë„‰ë°± íŠ¹í™”</div>
        <div class="char-stats">HP 120 Â· SPD 125<br>ì‹œì‘ ë¬´ê¸°: ì•¼êµ¬ë°©ë§ì´</div>
        <div class="char-tag tag-batter">BATTER</div>
      </div>
      <div class="char-card gunner-card" id="cc-gunner" onclick="selectChar('gunner')">
        <div class="char-icon">ğŸ”«</div>
        <div class="char-name">ìƒ·ê±´ë§¨</div>
        <div class="char-desc">ìƒ·ê±´ìœ¼ë¡œ ê·¼ê±°ë¦¬ ì  ì´ˆí† í™”<br>íƒ„í™˜ ìˆ˜Â·ì¿¨íƒ€ì„ íŠ¹í™”</div>
        <div class="char-stats">HP 95 Â· SPD 130<br>ì‹œì‘ ë¬´ê¸°: ìƒ·ê±´</div>
        <div class="char-tag tag-gunner">GUNNER</div>
      </div>
    </div>
    <div class="sep"></div>
    <div id="char-selected-info" style="font-family:'Rajdhani',sans-serif;font-size:11px;color:var(--c-text2);letter-spacing:2px;text-align:center;margin-bottom:12px;min-height:20px;"></div>
    <div style="display:flex;gap:10px;">
      <button class="btn" id="char-confirm-btn" onclick="confirmCharAndShowStage()" style="display:none">ì„ íƒ í™•ì¸ â†’</button>
      <button class="btn btn-secondary" onclick="hideOv('char-select');showOv('ss')">â† ë’¤ë¡œ</button>
    </div>
  </div>

  <!-- Stage Select -->
  <div class="ov" id="stage-select" style="display:none">
    <div class="ov-title" style="font-size:clamp(22px,6vw,34px);">ìŠ¤í…Œì´ì§€ ì„ íƒ</div>
    <div style="font-family:'Rajdhani',sans-serif;font-size:12px;color:var(--c-coin);letter-spacing:2px;margin-bottom:20px;">ğŸª™ <span id="ss-coin">0</span> ì½”ì¸ ë³´ìœ </div>
    <div class="stage-grid" id="stage-grid"></div>
    <div class="sep"></div>
    <div style="display:flex;gap:10px;">
      <button class="btn btn-secondary" onclick="showShop()">ğŸ›’ ìƒì </button>
      <button class="btn btn-secondary" onclick="hideOv('stage-select');showCharSelect()">â† ìºë¦­í„° ë³€ê²½</button>
    </div>
  </div>

  <!-- Shop -->
  <div class="ov" id="shopscreen" style="display:none">
    <div class="shop-title">âš”ï¸ ìƒì </div>
    <div class="shop-sub">ì½”ì¸ìœ¼ë¡œ ì¥ë¹„ì™€ ìƒìë¥¼ êµ¬ë§¤í•˜ì„¸ìš”</div>
    <div class="coin-display">ğŸª™ <span id="shop-coin">0</span></div>
    <div class="shop-tabs">
      <div class="shop-tab active" onclick="switchTab('chest')">ğŸ“¦ ìƒì</div>
      <div class="shop-tab" onclick="switchTab('armor')">ğŸ›¡ï¸ ë°©ì–´êµ¬</div>
    </div>
    <div class="shop-grid" id="shop-grid"></div>
    <div class="sep"></div>
    <button class="btn btn-secondary" onclick="hideOv('shopscreen');renderStageGrid();showOv('stage-select')">â† ë’¤ë¡œ</button>
  </div>

  <!-- Chest Result -->
  <div class="ov" id="chest-result" style="display:none">
    <div class="ov-title" style="color:var(--c-evo2);font-size:clamp(20px,5vw,30px);">ğŸ“¦ ìƒì ê°œë´‰!</div>
    <div class="sep"></div>
    <div id="chest-items" style="display:flex;gap:16px;flex-wrap:wrap;justify-content:center;margin:10px 0 20px;"></div>
    <div class="sep"></div>
    <button class="btn" onclick="hideOv('chest-result');showOv('shopscreen')">í™•ì¸</button>
  </div>

  <!-- Level Up -->
  <div class="ov" id="luscreen" style="display:none">
    <div id="lu-title">ë ˆë²¨ ì—…</div>
    <div class="cards" id="cards"></div>
    <button id="reroll-btn" onclick="rerollCards()" style="margin-top:10px;font-family:'Rajdhani',sans-serif;font-size:11px;font-weight:700;letter-spacing:2px;text-transform:uppercase;padding:7px 18px;background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.15);border-radius:6px;color:var(--c-text2);cursor:pointer;transition:all 0.2s;">ğŸ”„ ìƒˆë¡œê³ ì¹¨ <span id="reroll-badge" style="background:rgba(124,92,252,0.6);color:#fff;border-radius:4px;padding:1px 6px;font-size:10px;margin-left:4px;">1íšŒ</span></button>
  </div>

  <!-- Stage Clear -->
  <div class="ov" id="clearscreen" style="display:none">
    <div style="font-family:'Rajdhani',sans-serif;font-size:clamp(32px,9vw,48px);font-weight:700;color:var(--c-gold);letter-spacing:6px;text-transform:uppercase;margin-bottom:4px;">í´ë¦¬ì–´!</div>
    <div style="font-family:'Rajdhani',sans-serif;font-size:11px;color:var(--c-text2);letter-spacing:4px;text-transform:uppercase;margin-bottom:20px;">Stage Clear</div>
    <div class="sep"></div>
    <div id="cstats"></div>
    <div id="coin-reward" style="font-family:'Rajdhani',sans-serif;font-size:22px;font-weight:700;color:var(--c-coin);margin:10px 0 20px;"></div>
    <div style="display:flex;gap:10px;">
      <button class="btn" onclick="gotoShopAfterClear()">ğŸ›’ ìƒì  ë°©ë¬¸</button>
      <button class="btn btn-secondary" onclick="gotoStageSelectAfterClear()">ìŠ¤í…Œì´ì§€ ì„ íƒ</button>
    </div>
  </div>

  <!-- Pause Screen -->
  <div class="ov" id="pausescreen" style="display:none">
    <div class="ov-title" style="font-size:clamp(28px,8vw,40px);margin-bottom:4px;">ì¼ì‹œì •ì§€</div>
    <div class="ov-sub">PAUSED</div>
    <div class="sep"></div>
    <div style="display:flex;flex-direction:column;gap:10px;align-items:center;">
      <button class="btn" onclick="resumeGame()">â–¶ ê³„ì† í•˜ê¸°</button>
      <button class="btn btn-secondary" onclick="showDmgStats()">ğŸ“Š ë°ë¯¸ì§€ í†µê³„</button>
      <button class="btn btn-secondary" onclick="pauseToMenu()">ğŸ  ë©”ë‰´ë¡œ ë‚˜ê°€ê¸°</button>
    </div>
  </div>

  <!-- Damage Stats Screen -->
  <div class="ov" id="statsscreen" style="display:none">
    <div class="ov-title" style="font-size:clamp(18px,5vw,26px);color:var(--c-gold);margin-bottom:4px;">ğŸ“Š ë°ë¯¸ì§€ í†µê³„</div>
    <div id="stats-total-dmg" style="font-family:'Rajdhani',sans-serif;font-size:13px;font-weight:600;color:var(--c-text2);letter-spacing:2px;text-align:center;margin-bottom:14px;"></div>
    <div class="dmg-stat-list" id="dmg-stat-list"></div>
    <div class="sep"></div>
    <button class="btn btn-secondary" onclick="hideOv('statsscreen');showOv('pausescreen')">â† ëŒì•„ê°€ê¸°</button>
  </div>

  <!-- Game Over -->
  <div class="ov" id="goscreen" style="display:none">
    <div style="font-family:'Rajdhani',sans-serif;font-size:clamp(36px,10vw,52px);font-weight:700;color:var(--c-hp);letter-spacing:6px;text-transform:uppercase;animation:deathPulse 1s ease infinite;margin-bottom:4px;">ì‚¬ë§</div>
    <div style="font-family:'Rajdhani',sans-serif;font-size:11px;color:var(--c-text2);letter-spacing:4px;text-transform:uppercase;margin-bottom:20px;">You Died</div>
    <div class="sep"></div>
    <div id="rstats"></div>
    <div style="display:flex;gap:10px;">
      <button class="btn" onclick="retryStage()">ë‹¤ì‹œ ë„ì „</button>
      <button class="btn btn-secondary" onclick="gotoStageSelectDead()">ìŠ¤í…Œì´ì§€ ì„ íƒ</button>
    </div>
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CANVAS SETUP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const canvas = document.getElementById('c');
const ctx = canvas.getContext('2d');
let W = 800, H = 560;

let state = 'start';
let keys = {};
let gameTime = 0;
let kills = 0;
let lastTime = 0;
let animId;
let cam = {x:0, y:0};
let player;
let enemies = [], projectiles = [], xpGems = [], dmgNums = [], particles = [];
let orbBurstQueue = [], orbBurstTimer = 0, spawnTimer = 0;
let nextBossTime = 300, bossWarningTimer = 0, activeBoss = null;
let finalBossSpawned = false;
let currentStage = 1;
let isBossPhase = false;
let floorItems = [];
let floorItemSpawnTimer = 0;
let bossProjectiles = [];
let boomerangs = [];
let selectedChar = null;

// â˜… ë°ë¯¸ì§€ íŠ¸ë˜í‚¹
let weaponDmgTracker = {};
let totalDmgDealt = 0;

// â˜… ì¼ì‹œì •ì§€ ìƒíƒœ
let isPaused = false;

const MAX_WEAPONS   = 5;
const MAX_ABILITIES = 5;
const FLOOR_ITEM_TYPES = {
  coin:    {icon:'ğŸª™',color:'#FFD700',r:8, label:'ì½”ì¸',   desc:'+20 ì½”ì¸'},
  magnet:  {icon:'ğŸ§²',color:'#4488FF',r:9, label:'ìì„',   desc:'XP ì „ë¶€ í¡ìˆ˜'},
  bomb:    {icon:'ğŸ’£',color:'#FF4422',r:9, label:'í­íƒ„',   desc:'í™”ë©´ ì  ì „ë©¸(ë³´ìŠ¤ ì œì™¸)'},
  chicken: {icon:'ğŸ—',color:'#FFAA44',r:8, label:'ë‹­ë‹¤ë¦¬', desc:'HP +40 íšŒë³µ'},
  poison:  {icon:'â˜ ï¸',color:'#AA44FF',r:8, label:'ë…ì•½',   desc:'HP -30'},
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  â˜… LOCAL STORAGE SAVE / LOAD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const SAVE_KEY = 'darkSurvivor_save_v2';

function defaultSave(){
  return { coins:0, clearedStages:[], ownedEquip:[], activeEquip:{weapon:null, armor:null} };
}

function loadSave(){
  try {
    const raw = localStorage.getItem(SAVE_KEY);
    if(raw){
      const parsed = JSON.parse(raw);
      if(typeof parsed.coins !== 'number') parsed.coins = 0;
      if(!Array.isArray(parsed.clearedStages)) parsed.clearedStages = [];
      if(!Array.isArray(parsed.ownedEquip)) parsed.ownedEquip = [];
      if(!parsed.activeEquip) parsed.activeEquip = {weapon:null,armor:null};
      return parsed;
    }
  } catch(e) { console.warn('Save load failed:', e); }
  return defaultSave();
}

function writeSave(){
  try {
    localStorage.setItem(SAVE_KEY, JSON.stringify(saveData));
  } catch(e) { console.warn('Save write failed:', e); }
}

let saveData = loadSave();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CHARACTER DEFINITIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const CHARACTERS = {
  warrior: {
    name:'ì „ì‚¬', icon:'âš”ï¸',
    maxHp:100, spd:130, pickupRange:70,
    startWeapon:'orb',
    dmgMul:1.0, cdrMul:1.0,
    color:'#7c5cfc', badgeColor:'#a78bfa',
    desc:'ê· í˜•ì¡íŒ ì „íˆ¬ì›, ë§ˆë²• êµ¬ì²´ë¡œ ì‹œì‘',
    exclusiveWeapons:['orb'],
    bannedWeapons:['pickaxe','goldenPick','bat','homerun'],
  },
  miner: {
    name:'ê´‘ë¶€', icon:'â›ï¸',
    maxHp:85, spd:120, pickupRange:90,
    startWeapon:'pickaxe',
    dmgMul:1.15, cdrMul:0.92,
    color:'#c8a060', badgeColor:'#e8b870',
    desc:'ë¶€ë©”ë‘ ê³¡ê´­ì´ íˆ¬ì²™, ì½”ì¸+XP ìˆ˜ì§‘ íŠ¹í™”',
    bonusXP: 1.2,
    exclusiveWeapons:['pickaxe'],
    bannedWeapons:['bat','homerun','orb','meteor'],
  },
  hunter: {
    name:'íƒ€ì', icon:'ğŸ',
    maxHp:120, spd:125, pickupRange:70,
    startWeapon:'bat',
    dmgMul:1.3, cdrMul:1.0,
    color:'#fb923c', badgeColor:'#fdba74',
    desc:'ì•¼êµ¬ë°©ë§ì´ ê°•íƒ€, ë„‰ë°±+ê´‘ì—­ íƒ€ê²© íŠ¹í™”',
    batBonus: true,
    exclusiveWeapons:['bat'],
    bannedWeapons:['pickaxe','goldenPick','orb','meteor'],
  },
  gunner: {
    name:'ìƒ·ê±´ë§¨', icon:'ğŸ”«',
    maxHp:95, spd:130, pickupRange:70,
    startWeapon:'shotgun',
    dmgMul:1.0, cdrMul:0.95,
    color:'#d1d5db', badgeColor:'#f3f4f6',
    desc:'ìƒ·ê±´ ìë™ì¡°ì¤€, íƒ„í™˜ìˆ˜+ì¿¨íƒ€ì„ ê°•í™”',
    shotgunBonus: true,
    exclusiveWeapons:['shotgun'],
    bannedWeapons:['pickaxe','goldenPick','bat','homerun'],
  },
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STAGES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const STAGES = [
  {id:1, name:'ì €ì£¼ë°›ì€ ìˆ²',    emoji:'ğŸŒ²', diff:'â­',         coinReward:80,  diffMul:1.0, bg:'forest'},
  {id:2, name:'ì–´ë‘ ì˜ ë™êµ´',   emoji:'ğŸ—¿', diff:'â­â­',        coinReward:140, diffMul:1.4, bg:'cave'},
  {id:3, name:'í™”ì—¼ ì§€ì˜¥',     emoji:'ğŸ”¥', diff:'â­â­â­',      coinReward:200, diffMul:1.9, bg:'hell'},
  {id:4, name:'ê³µí—ˆì˜ í‹ˆìƒˆ',   emoji:'ğŸŒ€', diff:'â­â­â­â­',    coinReward:280, diffMul:2.6, bg:'void'},
  {id:5, name:'ì•”í‘ì‹ ì˜ ê¶ì „', emoji:'âš«', diff:'â­â­â­â­â­', coinReward:400, diffMul:3.5, bg:'palace'},
];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SHOP ITEMS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const SHOP_ARMORS = [
  {id:'sa_iron_vest',    name:'ì² ì œ ì¡°ë¼',   icon:'ğŸ›¡ï¸', type:'armor', cost:80,  desc:'ìµœëŒ€ HP +80',                          bonus:{hp:80}},
  {id:'sa_shadow_cloak', name:'ê·¸ë¦¼ì ë§í† ', icon:'ğŸŒ‘', type:'armor', cost:100, desc:'ì´ë™ì†ë„ +20%',                        bonus:{spd:0.20}},
  {id:'sa_rune_plate',   name:'ë£¬ ê°‘ì˜·',     icon:'ğŸ”¯', type:'armor', cost:130, desc:'ìµœëŒ€ HP +50, ì¿¨íƒ€ì„ -10%',            bonus:{hp:50, cdr:0.10}},
  {id:'sa_dragon_scale', name:'ìš©ë¦° ê°‘ì˜·',   icon:'ğŸ‰', type:'armor', cost:180, desc:'ìµœëŒ€ HP +120, ê³µê²©ë ¥ +10%',           bonus:{hp:120, dmg:0.10}},
  {id:'sa_void_armor',   name:'ê³µí—ˆ ê°‘ì˜·',   icon:'ğŸŒ€', type:'armor', cost:240, desc:'ìµœëŒ€ HP +80, ì´ë™ì†ë„ +15%, ì¿¨íƒ€ì„ -15%', bonus:{hp:80, spd:0.15, cdr:0.15}},
  {id:'sa_miner_belt',   name:'ê´‘ë¶€ í—ˆë¦¬ë ', icon:'â›ï¸', type:'armor', cost:110, desc:'ìˆ˜ì§‘ ë²”ìœ„ +50, ê³¡ê´­ì´ ê³µê²©ë ¥ +20%',   bonus:{pickup:50, dmg:0.10}},
];

const CHESTS = [
  {id:'chest_wooden', name:'ë‚˜ë¬´ ìƒì', icon:'ğŸ“¦', type:'chest', cost:60,  desc:'ë¬´ì‘ìœ„ ì¥ë¹„ 1ê°œ / ì½”ì¸ 20~50', rarity:'common'},
  {id:'chest_iron',   name:'ì² ì œ ìƒì', icon:'ğŸ—³ï¸', type:'chest', cost:120, desc:'ë¬´ì‘ìœ„ ì¥ë¹„ 2ê°œ / ì½”ì¸ 40~100', rarity:'rare'},
  {id:'chest_gold',   name:'í™©ê¸ˆ ìƒì', icon:'ğŸ’°', type:'chest', cost:220, desc:'í¬ê·€ ì¥ë¹„ 2ê°œ + ì½”ì¸ 80~200',  rarity:'epic'},
];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  WEAPON DATA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const WEAPON_DATA = {
  pickaxe:{name:'ê³¡ê´­ì´',icon:'â›ï¸',maxLv:5,cdBase:1.4,dmgBase:40,spdBase:280,
    desc:l=>`ë¶€ë©”ë‘ ${1+Math.floor(l/2)}ê°œ Â· í”¼í•´ ${40+l*18} Â· ê´€í†µ`},
  orb:    {name:'ë§ˆë²• êµ¬ì²´',   icon:'ğŸ”®', maxLv:5, cdBase:1.2,  dmgBase:25,  spdBase:220, desc:l=>`êµ¬ì²´ ${1+l}ê°œ ì—°ì† ë°œì‚¬ Â· í”¼í•´ ${25+l*10}`},
  axe:    {name:'ë„ë¼',       icon:'ğŸª“', maxLv:5, cdBase:2.0,  dmgBase:50,  spdBase:180, desc:l=>`í¬ë¬¼ì„  ${1+Math.floor(l/2)}ê°œ Â· í”¼í•´ ${50+l*20}`},
  aura:   {name:'ì–´ë‘  ì˜¤ë¼',  icon:'ğŸŒ‘', maxLv:5, cdBase:0.5,  dmgBase:15,  spdBase:0,   desc:l=>`ë²”ìœ„ ${80+l*20}px Â· í”¼í•´ ${15+l*8}`},
  cross:  {name:'ì„±ì‹­ìê°€',   icon:'âœï¸', maxLv:5, cdBase:2.5,  dmgBase:80,  spdBase:200, desc:l=>`4ë°©í–¥ Â· í”¼í•´ ${80+l*25}`},
  bolt:   {name:'ë‚™ë¢°',       icon:'âš¡', maxLv:5, cdBase:1.0,  dmgBase:60,  spdBase:0,   desc:l=>`ëœë¤ ì  ${1+l}ëª… Â· í”¼í•´ ${60+l*20}`},
  nova:   {name:'ë¶ˆê½ƒ í­ë°œ',  icon:'ğŸ’¥', maxLv:5, cdBase:3.0,  dmgBase:120, spdBase:0,   desc:l=>`ë²”ìœ„ ${100+l*30}px Â· í”¼í•´ ${120+l*40}`},
  blade:  {name:'íšŒì „ ê²€',    icon:'âš”ï¸', maxLv:5, cdBase:0.1,  dmgBase:20,  spdBase:0,   desc:l=>`${2+l}ê°œ ê³µì „ Â· í”¼í•´ ${20+l*8}`},
  arrow:  {name:'ë§ˆë²• í™”ì‚´',  icon:'ğŸ¹', maxLv:5, cdBase:0.6,  dmgBase:30,  spdBase:400, desc:l=>`í™”ì‚´ ${1+Math.floor(l/2)}ë°œ Â· í”¼í•´ ${30+l*12}`},
  ice:    {name:'ë¹™ê²° ì°½',    icon:'ğŸ§Š', maxLv:5, cdBase:1.8,  dmgBase:60,  spdBase:260, desc:l=>`ë¹™ê²° ${l}ì´ˆ Â· í”¼í•´ ${60+l*18}`},
  bat:    {name:'ì•¼êµ¬ë°©ë§ì´', icon:'ğŸ', maxLv:5, cdBase:1.2,  dmgBase:60,  spdBase:0,   desc:l=>`ë¶€ì±„ê¼´ ê°•íƒ€ Â· í”¼í•´ ${60+l*20} Â· ë„‰ë°±`},
  shotgun:{name:'ìƒ·ê±´',      icon:'ğŸ”«', maxLv:5, cdBase:1.6,  dmgBase:28,  spdBase:500, desc:l=>`íƒ„í™˜ ${3+l}ë°œ Â· í”¼í•´ ${28+l*8}Ã—${3+l} Â· ìë™ì¡°ì¤€`},
  meteor: {name:'ìš´ì„ ì†Œí™˜',  icon:'â˜„ï¸', maxLv:1, cdBase:1.2,  dmgBase:0, spdBase:0, evolved:true, desc:()=>'ìš´ì„ì´ ìŸì•„ì§„ë‹¤'},
  storm:  {name:'í­í’ ì˜¤ë¼',  icon:'ğŸŒªï¸', maxLv:1, cdBase:0.25, dmgBase:0, spdBase:0, evolved:true, desc:()=>'ë„“ì€ í­í’ ì˜¤ë¼'},
  divine: {name:'ì‹ ì„± ì‹­ì',  icon:'ğŸŒŸ', maxLv:1, cdBase:1.6,  dmgBase:0, spdBase:0, evolved:true, desc:()=>'8ë°©í–¥ ì‹ ì„±í•œ ë¹›'},
  thunder:{name:'ë‡Œê²©',       icon:'ğŸŒ©ï¸', maxLv:1, cdBase:0.35, dmgBase:0, spdBase:0, evolved:true, desc:()=>'ì „ì²´ ë²ˆê°œ ë‚œì‚¬'},
  inferno:{name:'ì§€ì˜¥ë¶ˆ',     icon:'ğŸ”¥', maxLv:1, cdBase:1.8,  dmgBase:0, spdBase:0, evolved:true, desc:()=>'ê±°ëŒ€ ì§€ì† í­ë°œ'},
  phantom:{name:'ìœ ë ¹ ê²€ê¸°',  icon:'ğŸ‘»', maxLv:1, cdBase:0.07, dmgBase:0, spdBase:0, evolved:true, desc:()=>'ìœ ë ¹ì´ ê³µì „'},
  tempest:{name:'í­í’ í™”ì‚´',  icon:'ğŸŒ¬ï¸', maxLv:1, cdBase:0.3,  dmgBase:0, spdBase:0, evolved:true, desc:()=>'í™”ì‚´ í­í’ ë‚œì‚¬'},
  glacier:{name:'ë¹™í•˜ í­ë°œ',  icon:'â„ï¸', maxLv:1, cdBase:2.0,  dmgBase:0, spdBase:0, evolved:true, desc:()=>'í™”ë©´ ì „ì²´ ë¹™ê²°'},
  homerun:{name:'í™ˆëŸ°í¬',    icon:'ğŸ’«', maxLv:1, cdBase:0.9,  dmgBase:0, spdBase:0, evolved:true, desc:()=>'ì „ë°©ìœ„ ì´ˆê°•íƒ€ í­ë°œ'},
  minigun:{name:'ê¸°ê´€ì´',    icon:'ğŸ’¥', maxLv:1, cdBase:0.05, dmgBase:0, spdBase:0, evolved:true, desc:()=>'ì¿¨íƒ€ì„ ì—†ëŠ” ì—°ì† ì‚¬ê²©'},
  goldenPick:{name:'í™©ê¸ˆ ê³¡ê´­ì´',icon:'âœ¨',maxLv:1,cdBase:0.9,dmgBase:0,spdBase:0,evolved:true,desc:()=>'3ê°œ í™©ê¸ˆ ë¶€ë©”ë‘ ê°ê°œê²©íŒŒ'},
};

const ACC_DATA = {
  grimoire:  {name:'ë§ˆë²•ì„œ',        icon:'ğŸ“–', desc:'ë§ˆë²• êµ¬ì²´ ì§„í™” Â· ì¿¨íƒ€ì„ -8%',          passive:{cdr:0.08}},
  whetstone: {name:'ìˆ«ëŒ',          icon:'ğŸª¨', desc:'ë„ë¼ ì§„í™” Â· ê³µê²©ë ¥ +12%',               passive:{dmg:0.12}},
  rune:      {name:'ì–´ë‘ ì˜ ë£¬',     icon:'ğŸ”¯', desc:'ì˜¤ë¼ ì§„í™” Â· ê³µê²©ë ¥ +10% Â· ì¿¨íƒ€ì„ -5%', passive:{dmg:0.10, cdr:0.05}},
  halo:      {name:'ì„±ìŠ¤ëŸ¬ìš´ í›„ê´‘', icon:'ğŸ˜‡', desc:'ì‹­ìê°€ ì§„í™” Â· ìµœëŒ€ HP +30',             passive:{hp:30}},
  capacitor: {name:'ì¶•ì „ê¸°',        icon:'ğŸ”‹', desc:'ë‚™ë¢° ì§„í™” Â· ì¿¨íƒ€ì„ -12%',               passive:{cdr:0.12}},
  magma:     {name:'ë§ˆê·¸ë§ˆ ì„',     icon:'ğŸŒ‹', desc:'ë¶ˆê½ƒ í­ë°œ ì§„í™” Â· ê³µê²©ë ¥ +15%',          passive:{dmg:0.15}},
  crystal:   {name:'ìˆ˜ì • íŒŒí¸',     icon:'ğŸ’', desc:'íšŒì „ ê²€ ì§„í™” Â· ì´ë™ì†ë„ +8%',           passive:{spd:0.08}},
  quiver:    {name:'ë§ˆë²• í™”ì‚´í†µ',   icon:'ğŸª„', desc:'ë§ˆë²• í™”ì‚´ ì§„í™” Â· ì¿¨íƒ€ì„ -10%',          passive:{cdr:0.10}},
  permafrost:{name:'ì˜êµ¬ ë™ê²°ì„',   icon:'ğŸ§Š', desc:'ë¹™ê²° ì°½ ì§„í™” Â· ìˆ˜ì§‘ ë²”ìœ„ +25',          passive:{pickup:25}},
  slugger:   {name:'ìŠ¬ëŸ¬ê±° ì¥ê°‘', icon:'ğŸ§¤', desc:'ë°©ë§ì´ ì§„í™” Â· ê³µê²©ë ¥ +18%',              passive:{dmg:0.18}},
  ammobox:   {name:'íƒ„ì•½ ìƒì',   icon:'ğŸ“¦', desc:'ìƒ·ê±´ ì§„í™” â†’ ê¸°ê´€ì´ Â· ì¿¨íƒ€ì„ -10%',       passive:{cdr:0.10}},
  goldvein:  {name:'í™©ê¸ˆ ê´‘ë§¥',     icon:'ğŸ¥‡', desc:'ê³¡ê´­ì´ ì§„í™” Â· ì½”ì¸ +50% Â· ê³µê²©ë ¥ +10%', passive:{dmg:0.10}},
};

const EVO_RECIPES = [
  {weapon:'orb',     acc:'grimoire',   result:'meteor',     name:'ìš´ì„ ì†Œí™˜',   icon:'â˜„ï¸'},
  {weapon:'axe',     acc:'whetstone',  result:'storm',      name:'í­í’ ì˜¤ë¼',   icon:'ğŸŒªï¸'},
  {weapon:'aura',    acc:'rune',       result:'storm',      name:'í­í’ ì˜¤ë¼',   icon:'ğŸŒªï¸'},
  {weapon:'cross',   acc:'halo',       result:'divine',     name:'ì‹ ì„± ì‹­ì',   icon:'ğŸŒŸ'},
  {weapon:'bolt',    acc:'capacitor',  result:'thunder',    name:'ë‡Œê²©',         icon:'ğŸŒ©ï¸'},
  {weapon:'nova',    acc:'magma',      result:'inferno',    name:'ì§€ì˜¥ë¶ˆ',       icon:'ğŸ”¥'},
  {weapon:'blade',   acc:'crystal',    result:'phantom',    name:'ìœ ë ¹ ê²€ê¸°',   icon:'ğŸ‘»'},
  {weapon:'arrow',   acc:'quiver',     result:'tempest',    name:'í­í’ í™”ì‚´',   icon:'ğŸŒ¬ï¸'},
  {weapon:'ice',     acc:'permafrost', result:'glacier',    name:'ë¹™í•˜ í­ë°œ',   icon:'â„ï¸'},
  {weapon:'bat',     acc:'slugger',    result:'homerun',    name:'í™ˆëŸ°í¬',      icon:'ğŸ’«'},
  {weapon:'shotgun', acc:'ammobox',    result:'minigun',    name:'ê¸°ê´€ì´',      icon:'ğŸ’¥'},
  {weapon:'pickaxe', acc:'goldvein',   result:'goldenPick', name:'í™©ê¸ˆ ê³¡ê´­ì´', icon:'âœ¨'},
];

const UPGRADES = [
  {id:'pickaxe',weapon:true,name:'ê³¡ê´­ì´',icon:'â›ï¸'},
  {id:'orb',weapon:true,name:'ë§ˆë²• êµ¬ì²´',icon:'ğŸ”®'},
  {id:'axe',weapon:true,name:'ë„ë¼',icon:'ğŸª“'},
  {id:'aura',weapon:true,name:'ì–´ë‘  ì˜¤ë¼',icon:'ğŸŒ‘'},
  {id:'cross',weapon:true,name:'ì„±ì‹­ìê°€',icon:'âœï¸'},
  {id:'bolt',weapon:true,name:'ë‚™ë¢°',icon:'âš¡'},
  {id:'nova',weapon:true,name:'ë¶ˆê½ƒ í­ë°œ',icon:'ğŸ’¥'},
  {id:'blade',weapon:true,name:'íšŒì „ ê²€',icon:'âš”ï¸'},
  {id:'arrow',weapon:true,name:'ë§ˆë²• í™”ì‚´',icon:'ğŸ¹'},
  {id:'ice',weapon:true,name:'ë¹™ê²° ì°½',icon:'ğŸ§Š'},
  {id:'bat',weapon:true,name:'ì•¼êµ¬ë°©ë§ì´',icon:'ğŸ'},
  {id:'shotgun',weapon:true,name:'ìƒ·ê±´',icon:'ğŸ”«'},
  {id:'grimoire',accessory:true,name:'ë§ˆë²•ì„œ',icon:'ğŸ“–'},
  {id:'whetstone',accessory:true,name:'ìˆ«ëŒ',icon:'ğŸª¨'},
  {id:'rune',accessory:true,name:'ì–´ë‘ ì˜ ë£¬',icon:'ğŸ”¯'},
  {id:'halo',accessory:true,name:'ì„±ìŠ¤ëŸ¬ìš´ í›„ê´‘',icon:'ğŸ˜‡'},
  {id:'capacitor',accessory:true,name:'ì¶•ì „ê¸°',icon:'ğŸ”‹'},
  {id:'magma',accessory:true,name:'ë§ˆê·¸ë§ˆ ì„',icon:'ğŸŒ‹'},
  {id:'crystal',accessory:true,name:'ìˆ˜ì • íŒŒí¸',icon:'ğŸ’'},
  {id:'quiver',accessory:true,name:'ë§ˆë²• í™”ì‚´í†µ',icon:'ğŸª„'},
  {id:'permafrost',accessory:true,name:'ì˜êµ¬ ë™ê²°ì„',icon:'ğŸ§Š'},
  {id:'slugger',accessory:true,name:'ìŠ¬ëŸ¬ê±° ì¥ê°‘',icon:'ğŸ§¤'},
  {id:'ammobox',accessory:true,name:'íƒ„ì•½ ìƒì',icon:'ğŸ“¦'},
  {id:'goldvein',accessory:true,name:'í™©ê¸ˆ ê´‘ë§¥',icon:'ğŸ¥‡'},
  {id:'maxhp',name:'ìƒëª…ë ¥ ê°•í™”',icon:'â¤ï¸'},
  {id:'speed',name:'ì´ë™ ì†ë„',icon:'ğŸ’¨'},
  {id:'pickup',name:'ìˆ˜ì§‘ ë²”ìœ„',icon:'âœ¨'},
  {id:'heal',name:'ì¦‰ì‹œ íšŒë³µ',icon:'ğŸ’‰'},
  {id:'dmgup',name:'ê³µê²©ë ¥ ê°•í™”',icon:'âš”ï¸'},
  {id:'cdr',name:'ì¿¨íƒ€ì„ ê°ì†Œ',icon:'â±ï¸'},
];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ENEMY TYPES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const ENEMY_TYPES = [
  {name:'zombie',   color:'#3A7A3A', size:14, hp:30,  spd:60,  xp:5,  dmg:16,  shape:'circle'},
  {name:'bat',      color:'#8A5AAA', size:10, hp:15,  spd:110, xp:3,  dmg:12,  shape:'tri'},
  {name:'skeleton', color:'#C8C8A8', size:13, hp:50,  spd:50,  xp:8,  dmg:22,  shape:'circle'},
  {name:'ghost',    color:'#7AA8D8', size:16, hp:25,  spd:80,  xp:6,  dmg:18,  shape:'blob', alpha:0.65},
  {name:'werewolf', color:'#8B6A3A', size:18, hp:120, spd:90,  xp:20, dmg:36, shape:'circle'},
  {name:'demon',    color:'#CC2200', size:20, hp:200, spd:70,  xp:35, dmg:52, shape:'circle'},
  {name:'golem',    color:'#6688AA', size:24, hp:400, spd:40,  xp:50, dmg:68, shape:'circle'},
  {name:'hellhound',color:'#FF4400', size:16, hp:180, spd:110, xp:30, dmg:48, shape:'circle'},
  {name:'wraith',   color:'#AA44FF', size:18, hp:300, spd:85,  xp:45, dmg:62, shape:'blob', alpha:0.7},
  {name:'voidling', color:'#224466', size:20, hp:500, spd:70,  xp:60, dmg:80, shape:'blob', alpha:0.8},
];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  BOSS TYPES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const BOSS_TYPES = [
  {name:'ë¦¬ì¹˜',   icon:'ğŸ’€', color:'#9B59B6', size:38, hp:4000,  spd:65, xp:200, dmg:75,  shape:'circle', atkCd:2.0, atkPatterns:['single','spread']},
  {name:'ë“œë˜ê³¤', icon:'ğŸ‰', color:'#E74C3C', size:46, hp:8000,  spd:58, xp:350, dmg:100, shape:'circle', atkCd:1.7, atkPatterns:['spread','burst']},
  {name:'ì•…ë§ˆì™•', icon:'ğŸ‘¹', color:'#C0392B', size:42, hp:14000, spd:72, xp:500, dmg:130, shape:'circle', atkCd:1.4, atkPatterns:['spiral','burst']},
  {name:'ê³µí—ˆì‹ ', icon:'ğŸŒ‘', color:'#2C3E50', size:52, hp:22000, spd:64, xp:800, dmg:160, shape:'blob', alpha:0.85, atkCd:1.1, atkPatterns:['void','spread','spiral']},
  {name:'ì‹¬ì—°',   icon:'ğŸ•³ï¸', color:'#1A1A2E', size:58, hp:36000, spd:70, xp:1200,dmg:195, shape:'blob', alpha:0.9,  atkCd:0.9, atkPatterns:['void','burst','spiral']},
  {name:'ì•”í‘ì‹ ', icon:'âš«', color:'#0D0D0D', size:65, hp:60000, spd:78, xp:2000,dmg:250, shape:'circle',atkCd:0.65,atkPatterns:['void','spread','burst','spiral']},
];

const BOSS_ATK_PATTERNS = {
  single: (boss) => {
    const a = Math.atan2(player.y-boss.y, player.x-boss.x);
    bossProjectiles.push({x:boss.x,y:boss.y,vx:Math.cos(a)*200,vy:Math.sin(a)*200,
      dmg:boss.type.dmg*0.5,r:8,color:'#CC44FF',life:4.0,glow:'rgba(200,68,255,0.8)',type:'boss_single'});
    SFX.boltStrike();
  },
  spread: (boss) => {
    const a = Math.atan2(player.y-boss.y, player.x-boss.x);
    for(let i=-1;i<=1;i++){
      const ang=a+i*0.35;
      bossProjectiles.push({x:boss.x,y:boss.y,vx:Math.cos(ang)*240,vy:Math.sin(ang)*240,
        dmg:boss.type.dmg*0.4,r:7,color:'#FF6622',life:3.5,glow:'rgba(255,102,34,0.8)',type:'boss_spread'});
    }
    SFX.novaExplode();
  },
  burst: (boss) => {
    for(let i=0;i<8;i++){
      const ang=(i/8)*Math.PI*2+gameTime;
      bossProjectiles.push({x:boss.x,y:boss.y,vx:Math.cos(ang)*180,vy:Math.sin(ang)*180,
        dmg:boss.type.dmg*0.35,r:6,color:'#FF2244',life:3.0,glow:'rgba(255,34,68,0.8)',type:'boss_burst'});
    }
    SFX.bossWarning();
  },
  spiral: (boss) => {
    for(let i=0;i<4;i++){
      const ang=(i/4)*Math.PI*2+gameTime*2;
      bossProjectiles.push({x:boss.x,y:boss.y,vx:Math.cos(ang)*220,vy:Math.sin(ang)*220,
        dmg:boss.type.dmg*0.45,r:9,color:'#44AAFF',life:3.5,glow:'rgba(68,170,255,0.8)',type:'boss_spiral'});
    }
    SFX.boltStrike();
  },
  void: (boss) => {
    const a = Math.atan2(player.y-boss.y, player.x-boss.x);
    bossProjectiles.push({x:boss.x,y:boss.y,vx:Math.cos(a)*120,vy:Math.sin(a)*120,
      dmg:boss.type.dmg*0.8,r:14,color:'#220033',life:6.0,glow:'rgba(100,0,200,0.9)',type:'boss_void',
      homing:true,homingStr:140});
    SFX.bossSpawn();
  },
};

const BG_THEMES = {
  forest:{base:'#0a1208',grid1:'rgba(20,60,20,0.6)',grid2:'rgba(30,80,30,0.03)',vignette:['rgba(0,20,0,0)','rgba(0,0,0,0.6)']},
  cave:  {base:'#0e0c10',grid1:'rgba(60,40,80,0.5)',grid2:'rgba(80,60,100,0.03)',vignette:['rgba(30,0,40,0.04)','rgba(0,0,0,0.65)']},
  hell:  {base:'#150504',grid1:'rgba(100,20,10,0.5)',grid2:'rgba(180,40,10,0.04)',vignette:['rgba(60,0,0,0.06)','rgba(0,0,0,0.6)']},
  void:  {base:'#050510',grid1:'rgba(20,20,100,0.5)',grid2:'rgba(40,40,200,0.04)',vignette:['rgba(0,0,60,0.08)','rgba(0,0,0,0.7)']},
  palace:{base:'#0a0a0a',grid1:'rgba(80,0,80,0.5)',grid2:'rgba(120,0,120,0.05)',vignette:['rgba(40,0,40,0.1)','rgba(0,0,0,0.75)']},
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  OVERLAY HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showOv(id){ document.getElementById(id).style.display='flex'; }
function hideOv(id){ document.getElementById(id).style.display='none'; }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CHARACTER SELECT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showCharSelect(){
  hideOv('ss');
  hideOv('stage-select');
  selectedChar = null;
  document.getElementById('char-confirm-btn').style.display='none';
  document.getElementById('char-selected-info').textContent='';
  document.querySelectorAll('.char-card').forEach(c=>c.classList.remove('selected'));
  showOv('char-select');
}

function selectChar(charId){
  selectedChar = charId;
  document.querySelectorAll('.char-card').forEach(c=>c.classList.remove('selected'));
  document.getElementById('cc-'+charId).classList.add('selected');
  const ch = CHARACTERS[charId];
  document.getElementById('char-selected-info').textContent = `${ch.icon} ${ch.name} ì„ íƒë¨ â€” ${ch.desc}`;
  document.getElementById('char-selected-info').style.color = ch.badgeColor;
  document.getElementById('char-confirm-btn').style.display='inline-block';
}

function confirmCharAndShowStage(){
  if(!selectedChar) return;
  hideOv('char-select');
  renderStageGrid();
  document.getElementById('ss-coin').textContent = saveData.coins;
  showOv('stage-select');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STAGE SELECT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderStageGrid(){
  const grid = document.getElementById('stage-grid');
  grid.innerHTML = '';
  STAGES.forEach(s=>{
    const cleared = saveData.clearedStages.includes(s.id);
    const locked  = s.id>1 && !saveData.clearedStages.includes(s.id-1);
    const d = document.createElement('div');
    d.className = 'stage-card'+(locked?' locked':'');
    d.innerHTML = `
      <div style="font-size:28px;margin-bottom:6px;">${s.emoji}</div>
      <div class="s-num">${s.id}</div>
      <div class="s-name">${s.name}</div>
      <div class="s-diff">${s.diff}</div>
      <div class="s-coin">ğŸª™ ${s.coinReward} ì½”ì¸</div>
      ${cleared?'<div class="s-clear" style="margin-top:6px;">âœ“ í´ë¦¬ì–´</div>':''}
      ${locked?'<div class="s-lock">ğŸ”’</div>':''}
    `;
    if(!locked) d.onclick=()=>{ hideOv('stage-select'); launchStage(s.id); };
    grid.appendChild(d);
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SHOP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let currentShopTab = 'chest';

function showShop(){
  hideOv('stage-select');
  document.getElementById('shop-coin').textContent = saveData.coins;
  renderShopGrid(currentShopTab);
  showOv('shopscreen');
}

function switchTab(tab){
  currentShopTab = tab;
  document.querySelectorAll('.shop-tab').forEach((el,i)=>{
    el.classList.toggle('active', ['chest','armor'][i]===tab);
  });
  document.getElementById('shop-coin').textContent = saveData.coins;
  renderShopGrid(tab);
}

function renderShopGrid(tab){
  const grid = document.getElementById('shop-grid');
  grid.innerHTML = '';
  const items = tab==='chest' ? CHESTS : SHOP_ARMORS;
  items.forEach(item=>{
    const owned   = saveData.ownedEquip.includes(item.id);
    const afford  = saveData.coins >= item.cost;
    const d = document.createElement('div');
    d.className = 'shop-item'+(item.type==='chest'?' chest-item':'')+(owned&&item.type!=='chest'?' owned':'')+((!afford&&!owned)?' cant-afford':'');
    d.innerHTML = `
      <div class="si2">${item.icon}</div>
      <div class="sn2">${item.name}</div>
      <div class="sd2">${item.desc}</div>
      <div class="sp2 ${owned&&item.type!=='chest'?'owned-lbl':''}">${owned&&item.type!=='chest'?'ë³´ìœ ì¤‘':'ğŸª™ '+item.cost}</div>
    `;
    if((!owned||item.type==='chest') && afford) d.onclick=()=>buyItem(item);
    grid.appendChild(d);
  });
}

function buyItem(item){
  if(saveData.coins<item.cost) return;
  saveData.coins -= item.cost;
  document.getElementById('shop-coin').textContent = saveData.coins;
  if(item.type==='chest'){ SFX.chestOpen(); openChest(item); }
  else {
    saveData.ownedEquip.push(item.id);
    SFX.buyItem(); writeSave();
    renderShopGrid(currentShopTab);
    showNotif(`${item.icon} ${item.name} êµ¬ë§¤!`,'#4ade80');
  }
}

function openChest(chest){
  hideOv('shopscreen');
  const rewards = [];
  const allEquip = [...SHOP_ARMORS].filter(e=>!saveData.ownedEquip.includes(e.id));
  const shuffle = arr=>[...arr].sort(()=>Math.random()-0.5);

  if(chest.id==='chest_wooden'){
    if(allEquip.length>0&&Math.random()<0.6){
      const item=shuffle(allEquip)[0]; saveData.ownedEquip.push(item.id);
      rewards.push({icon:item.icon,name:item.name,desc:'ì¥ë¹„ íšë“!'});
    } else {
      const bonus=20+Math.floor(Math.random()*31); saveData.coins+=bonus;
      rewards.push({icon:'ğŸª™',name:`${bonus} ì½”ì¸`,desc:'ì½”ì¸ íšë“!'});
    }
  } else if(chest.id==='chest_iron'){
    for(let i=0;i<2;i++){
      const rem=[...SHOP_ARMORS].filter(e=>!saveData.ownedEquip.includes(e.id));
      if(rem.length>0&&Math.random()<0.65){
        const item=shuffle(rem)[0]; saveData.ownedEquip.push(item.id);
        rewards.push({icon:item.icon,name:item.name,desc:'ì¥ë¹„ íšë“!'});
      } else {
        const bonus=40+Math.floor(Math.random()*61); saveData.coins+=bonus;
        rewards.push({icon:'ğŸª™',name:`${bonus} ì½”ì¸`,desc:'ì½”ì¸ íšë“!'});
      }
    }
  } else if(chest.id==='chest_gold'){
    const rem=[...SHOP_ARMORS].filter(e=>!saveData.ownedEquip.includes(e.id));
    shuffle(rem).slice(0,2).forEach(item=>{
      saveData.ownedEquip.push(item.id);
      rewards.push({icon:item.icon,name:item.name,desc:'í¬ê·€ ì¥ë¹„!'});
    });
    const bonus=80+Math.floor(Math.random()*121); saveData.coins+=bonus;
    rewards.push({icon:'ğŸª™',name:`${bonus} ì½”ì¸`,desc:'ì½”ì¸ ë³´ë„ˆìŠ¤!'});
  }
  writeSave();

  const container = document.getElementById('chest-items');
  container.innerHTML = '';
  rewards.forEach(r=>{
    const d=document.createElement('div');
    d.style.cssText='text-align:center;background:var(--c-surface);border:1px solid var(--c-border2);border-radius:8px;padding:16px 20px;';
    d.innerHTML=`<div style="font-size:36px;margin-bottom:8px;">${r.icon}</div>
      <div style="font-family:Rajdhani,sans-serif;font-weight:700;color:var(--c-text);font-size:13px;">${r.name}</div>
      <div style="font-family:Rajdhani,sans-serif;color:var(--c-gold);font-size:10px;margin-top:4px;">${r.desc}</div>`;
    container.appendChild(d);
  });
  showOv('chest-result');
}

function showNotif(msg, color='#fb923c'){
  const el=document.getElementById('evo-notif');
  el.textContent=msg; el.style.color=color; el.style.opacity='1';
  setTimeout(()=>{ el.style.opacity='0'; el.style.color=''; },2500);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  LAUNCH STAGE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function launchStage(stageId){
  currentStage = stageId;
  const stg = STAGES[stageId-1];
  state = 'playing';
  isPaused = false;
  rerollUsed = false;
  initPlayer(stg);
  enemies=[]; projectiles=[]; bossProjectiles=[]; xpGems=[]; dmgNums=[]; particles=[];
  boomerangs=[];
  orbBurstQueue=[]; orbBurstTimer=0; spawnTimer=0;
  kills=0; gameTime=0; lastTime=0;
  nextBossTime=300; bossWarningTimer=0; activeBoss=null;
  isBossPhase=false; floorItems=[]; floorItemSpawnTimer=15;
  finalBossSpawned=false;
  weaponDmgTracker={};
  totalDmgDealt=0;

  document.getElementById('stage-num').textContent=stageId;
  if(selectedChar){
    const ch=CHARACTERS[selectedChar];
    const badge=document.getElementById('char-badge');
    badge.textContent=`${ch.icon} ${ch.name}`;
    badge.style.color=ch.badgeColor;
  }
  document.getElementById('pause-btn').style.display='block';
  updateSlots(); updateCooldownHUD();
  lastTime=performance.now();
  cancelAnimationFrame(animId);
  gameLoop(performance.now());
}

function retryStage(){ hideOv('goscreen'); launchStage(currentStage); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  â˜… PAUSE SYSTEM
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function togglePause(){
  if(state==='playing'){ isPaused=true; state='paused'; showOv('pausescreen'); }
  else if(state==='paused'){ resumeGame(); }
}
function resumeGame(){
  hideOv('pausescreen'); hideOv('statsscreen');
  isPaused=false; state='playing';
  lastTime=performance.now();
  gameLoop(performance.now());
}
function pauseToMenu(){
  hideOv('pausescreen'); hideOv('statsscreen');
  document.getElementById('pause-btn').style.display='none';
  state='over'; isPaused=false;
  cancelAnimationFrame(animId);
  renderStageGrid();
  document.getElementById('ss-coin').textContent=saveData.coins;
  showOv('stage-select');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  â˜… DAMAGE STATS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function trackDamage(weaponId, dmg){
  if(!weaponDmgTracker[weaponId]) weaponDmgTracker[weaponId]=0;
  weaponDmgTracker[weaponId]+=dmg;
  totalDmgDealt+=dmg;
}

function showDmgStats(){
  hideOv('pausescreen');
  const entries=Object.entries(weaponDmgTracker).sort((a,b)=>b[1]-a[1]);
  const total=totalDmgDealt||1;

  document.getElementById('stats-total-dmg').textContent=
    `ì´ ëˆ„ì  í”¼í•´: ${Math.round(total).toLocaleString()} Â· ì²˜ì¹˜: ${kills}`;

  const list=document.getElementById('dmg-stat-list');
  list.innerHTML='';

  const COLORS=['#7c5cfc','#e8453c','#f0c040','#4ade80','#2dd4bf','#fb923c','#88ccff','#ff88cc','#aaff44','#ff4422'];

  entries.forEach(([wid,dmg],idx)=>{
    const wd=WEAPON_DATA[wid]; if(!wd) return;
    const pct=(dmg/total*100);
    const barW=Math.max(2,pct);
    const color=COLORS[idx%COLORS.length];
    const isEvolved=wd.evolved;
    const row=document.createElement('div');
    row.className='dmg-row';
    row.style.animationDelay=(idx*0.05)+'s';
    row.innerHTML=`
      <div class="dmg-icon">${wd.icon}</div>
      <div class="dmg-name" style="color:${isEvolved?'var(--c-evo2)':'var(--c-text)'}">${wd.name}</div>
      <div class="dmg-bar-bg">
        <div class="dmg-bar-fill" style="width:${barW}%;background:${color};box-shadow:0 0 6px ${color}88;"></div>
      </div>
      <div class="dmg-val">${Math.round(dmg).toLocaleString()}</div>
      <div class="dmg-pct" style="color:${color}">${pct.toFixed(1)}%</div>
    `;
    list.appendChild(row);
  });

  if(entries.length===0){
    list.innerHTML=`<div style="font-family:'Rajdhani',sans-serif;font-size:12px;color:var(--c-text2);text-align:center;letter-spacing:2px;">ì•„ì§ ë°ë¯¸ì§€ ì—†ìŒ</div>`;
  }
  showOv('statsscreen');
}

function gotoStageSelectAfterClear(){
  document.getElementById('pause-btn').style.display='none';
  hideOv('clearscreen');
  renderStageGrid();
  document.getElementById('ss-coin').textContent=saveData.coins;
  showOv('stage-select');
}
function gotoStageSelectDead(){
  document.getElementById('pause-btn').style.display='none';
  hideOv('goscreen');
  renderStageGrid();
  document.getElementById('ss-coin').textContent=saveData.coins;
  showOv('stage-select');
}
function gotoShopAfterClear(){
  document.getElementById('pause-btn').style.display='none';
  hideOv('clearscreen');
  document.getElementById('shop-coin').textContent=saveData.coins;
  renderShopGrid(currentShopTab);
  showOv('shopscreen');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PLAYER INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initPlayer(stg){
  const ch = selectedChar ? CHARACTERS[selectedChar] : CHARACTERS.warrior;
  const stageMul = stg.diffMul;

  player = {
    x:0, y:0, hp:ch.maxHp, maxHp:ch.maxHp,
    spd:ch.spd, xp:0, xpNext:30, level:1,
    weapons:{}, weaponCooldowns:{},
    accessories:{},
    pickupRange:ch.pickupRange,
    invincible:0, facing:1, aimAngle:0,
    dmgMul:ch.dmgMul, cdrMul:ch.cdrMul,
    stageMul, charId:ch.startWeapon,
    bonusXP: ch.bonusXP || 1.0,
    isMiner: selectedChar === 'miner',
    isHunter: selectedChar === 'hunter',
    isGunner: selectedChar === 'gunner',
  };
  player.weapons[ch.startWeapon] = 1;
  player.weaponCooldowns[ch.startWeapon] = 0;

  // íƒ€ì: ë°©ë§ì´ ëŒ€ë¯¸ì§€/ë„‰ë°± ê°•í™”
  if(ch.batBonus){
    player._batDmgBonus  = 0.40; // ë°©ë§ì´ ëŒ€ë¯¸ì§€ +40%
    player._batKnockback = 120;  // ê°•í•œ ë„‰ë°±
  } else {
    player._batDmgBonus  = 0;
    player._batKnockback = 60;
  }

  saveData.ownedEquip.forEach(eid=>{
    const equip=[...SHOP_ARMORS].find(e=>e.id===eid);
    if(!equip) return;
    const b=equip.bonus;
    if(b.cdr)    player.cdrMul=Math.max(0.2,player.cdrMul-b.cdr);
    if(b.dmg)    player.dmgMul+=b.dmg;
    if(b.hp)     { player.maxHp+=b.hp; player.hp=player.maxHp; }
    if(b.spd)    player.spd*=(1+b.spd);
    if(b.pickup) player.pickupRange+=b.pickup;
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  COOLDOWN HUD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateCooldownHUD(){
  if(!player) return;
  const container=document.getElementById('cooldown-hud');
  container.innerHTML='';
  for(let wid in player.weapons){
    const wd=WEAPON_DATA[wid]; if(!wd) continue;
    const isEvolved=wd.evolved, lv=player.weapons[wid];
    const maxCd=wd.cdBase*Math.pow(0.85,lv-1)*player.cdrMul;
    const cd=player.weaponCooldowns[wid]||0;
    const fill=Math.max(0,Math.min(1,1-cd/maxCd));
    const ready=fill>=0.99;
    const slot=document.createElement('div');
    slot.className='cd-slot'; slot.id='cdslot_'+wid;
    slot.innerHTML=`
      <div class="cd-icon${isEvolved?' evolved':''}">${wd.icon}</div>
      <div class="cd-bar-wrap">
        <div class="cd-bar${ready?' ready':''}" id="cdbar_${wid}" style="width:${Math.round(fill*100)}%"></div>
      </div>
      <div class="cd-label${isEvolved?' evo-lbl':''}">${wd.name}${!isEvolved?' Lv.'+lv:''}</div>
    `;
    container.appendChild(slot);
  }
}

function refreshCooldownBars(){
  if(!player||state==='start') return;
  for(let wid in player.weapons){
    const wd=WEAPON_DATA[wid]; if(!wd) continue;
    const lv=player.weapons[wid];
    const maxCd=wd.cdBase*Math.pow(0.85,lv-1)*player.cdrMul;
    const cd=player.weaponCooldowns[wid]||0;
    const fill=Math.max(0,Math.min(1,1-cd/maxCd));
    const ready=fill>=0.99;
    const bar=document.getElementById('cdbar_'+wid);
    if(bar){ bar.style.width=Math.round(fill*100)+'%'; bar.className='cd-bar'+(ready?' ready':''); }
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ENEMY SPAWN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function getSpawnRate(){
  if(gameTime<60)  return 1.4;
  if(gameTime<120) return 0.95;
  if(gameTime<300) return 0.65;
  if(gameTime<600) return 0.45;
  return 0.30;
}

function getEnemyPool(){
  const s=currentStage;
  if(s===1){ if(gameTime<60) return [0,0,0,1]; if(gameTime<300) return [0,0,1,1,2]; return [0,1,1,2,3]; }
  else if(s===2){ if(gameTime<60) return [0,1,1,2]; if(gameTime<300) return [1,2,2,3]; return [1,2,3,4,7]; }
  else if(s===3){ if(gameTime<60) return [2,3,4,7]; if(gameTime<300) return [3,4,5,7]; return [4,5,6,7,7]; }
  else if(s===4){ if(gameTime<60) return [4,5,6,8]; if(gameTime<300) return [5,6,8,8,9]; return [5,6,7,8,9]; }
  else { if(gameTime<60) return [5,6,8,9]; if(gameTime<300) return [6,7,8,9,9]; return [6,7,8,9,9]; }
}

function spawnEnemy(){
  const a=Math.random()*Math.PI*2, d=380+Math.random()*100;
  const pool=getEnemyPool();
  const t=ENEMY_TYPES[pool[Math.floor(Math.random()*pool.length)]];
  const stg=STAGES[currentStage-1];
  const timeMul=1+gameTime/400, stageMul=stg.diffMul;
  const baseSpd=t.spd*(1+gameTime/700)*stageMul*0.7;
  const finalSpd=Math.min(baseSpd, player.spd*0.88);
  enemies.push({
    x:player.x+Math.cos(a)*d, y:player.y+Math.sin(a)*d,
    type:t, hp:t.hp*timeMul*stageMul, maxHp:t.hp*timeMul*stageMul,
    spd:finalSpd, xp:Math.round(t.xp*stageMul),
    dmg:t.dmg*(1+gameTime/500)*stageMul, hitFlash:0,
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  BOSS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function spawnBoss(){
  enemies=enemies.filter(e=>e.isBoss);
  projectiles=[]; bossProjectiles=[]; isBossPhase=true;
  const stg=STAGES[currentStage-1];
  const bossIdx=Math.min(Math.floor((gameTime-300)/300)+(currentStage-1),BOSS_TYPES.length-1);
  const t=BOSS_TYPES[bossIdx];
  const mul=stg.diffMul*(1+gameTime/600);
  const a=Math.random()*Math.PI*2;
  const boss={
    x:player.x+Math.cos(a)*420, y:player.y+Math.sin(a)*420,
    type:t, hp:t.hp*mul, maxHp:t.hp*mul,
    spd:Math.min(t.spd*(1+gameTime/1000)*stg.diffMul*0.6, player.spd*0.82),
    xp:Math.round(t.xp*stg.diffMul), dmg:t.dmg*mul*0.6, hitFlash:0, isBoss:true,
    atkCd:t.atkCd||2.5, atkTimer:1.5, patternIdx:0,
  };
  enemies.push(boss); activeBoss=boss;
  SFX.bossSpawn();
  nextBossTime=gameTime+300;
}

function spawnFinalBoss(){
  enemies=enemies.filter(e=>e.isBoss);
  projectiles=[]; bossProjectiles=[]; isBossPhase=true;
  const stg=STAGES[currentStage-1];
  // ìµœê°• ë³´ìŠ¤: ì•”í‘ì‹  ê³ ì •, ìŠ¤íƒ¯ 1.5ë°° ê°•í™”
  const t=BOSS_TYPES[BOSS_TYPES.length-1];
  const mul=stg.diffMul*1.5;
  const a=Math.random()*Math.PI*2;
  const boss={
    x:player.x+Math.cos(a)*420, y:player.y+Math.sin(a)*420,
    type:t, hp:t.hp*mul, maxHp:t.hp*mul,
    spd:Math.min(t.spd*1.2*stg.diffMul*0.7, player.spd*0.9),
    xp:Math.round(t.xp*stg.diffMul*2), dmg:t.dmg*mul*0.7,
    hitFlash:0, isBoss:true,
    atkCd:t.atkCd*0.7, atkTimer:1.0, patternIdx:0,
    isFinalBoss:true,
  };
  enemies.push(boss); activeBoss=boss;
  SFX.bossSpawn();
  showNotif(`âš ï¸ âš« ì•”í‘ì‹  ê°•ë¦¼! âš ï¸ ê²©íŒŒí•˜ë©´ í´ë¦¬ì–´!`,'#ff0044');
}

function showBossWarning(bossType){
  SFX.bossWarning();
  showNotif(`âš ï¸ ${bossType.icon} ${bossType.name} ì¶œí˜„!`,'#ff4444');
  const el=document.getElementById('evo-notif');
  el.style.borderColor='rgba(255,50,50,0.5)'; el.style.background='rgba(40,0,0,0.9)';
  setTimeout(()=>{ el.style.borderColor=''; el.style.background=''; },3000);
}

function updateBossAttacks(dt){
  if(!activeBoss||activeBoss.hp<=0) return;
  const boss=activeBoss;
  boss.atkTimer-=dt;
  if(boss.atkTimer<=0){
    boss.atkTimer=boss.atkCd;
    const patterns=boss.type.atkPatterns||['single'];
    const patternName=patterns[boss.patternIdx%patterns.length];
    boss.patternIdx++;
    const fn=BOSS_ATK_PATTERNS[patternName];
    if(fn) fn(boss);
  }
  for(let i=bossProjectiles.length-1;i>=0;i--){
    const p=bossProjectiles[i];
    if(p.homing&&p.homingStr){
      const dx=player.x-p.x, dy=player.y-p.y, d=Math.hypot(dx,dy)||1;
      p.vx+=(dx/d)*p.homingStr*dt; p.vy+=(dy/d)*p.homingStr*dt;
      const spd=Math.hypot(p.vx,p.vy);
      if(spd>160){ p.vx=p.vx/spd*160; p.vy=p.vy/spd*160; }
    }
    p.x+=p.vx*dt; p.y+=p.vy*dt; p.life-=dt;
    if(p.life<=0){ bossProjectiles.splice(i,1); continue; }
    if(dist(p.x,p.y,player.x,player.y)<p.r+16&&player.invincible<=0){
      player.hp-=p.dmg; player.invincible=0.4;
      bossProjectiles.splice(i,1);
      dmgNums.push({x:player.x+(Math.random()-0.5)*20,y:player.y-10,val:Math.round(p.dmg),life:0.8,vy:-50,color:'#ff4444'});
      SFX.playerHit();
      if(player.hp<=0){ player.hp=0; SFX.playerDie(); state='dying'; setTimeout(()=>gameOver(),600); }
    }
    if(dist(p.x,p.y,player.x,player.y)>900) bossProjectiles.splice(i,1);
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  â˜…â˜…â˜… BOOMERANG PICKAXE - ê°ê°œê²©íŒŒ ì¡°ì¤€ â˜…â˜…â˜…
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function firePickaxe(wlv, wd){
  const cnt = 1 + Math.floor(wlv/2);
  const dmg = (wd.dmgBase + wlv*18) * player.dmgMul;
  const isGolden = !!player.weapons['goldenPick'];
  const spd = 280;

  // â˜… ë‹¤ì¤‘ ë°œì‚¬ ì‹œ ê°ê° ë‹¤ë¥¸ ì ì„ ì¡°ì¤€
  // ê°€ê¹Œìš´ ìˆœì„œë¡œ ì  ëª©ë¡ ì •ë ¬
  const sortedEnemies = [...enemies].sort((a,b)=>
    dist(player.x,player.y,a.x,a.y) - dist(player.x,player.y,b.x,b.y)
  );

  for(let i=0; i<cnt; i++){
    let angle;
    if(sortedEnemies.length === 0){
      // ì ì´ ì—†ìœ¼ë©´ ë¶€ì±„ê¼´ë¡œ ë°œì‚¬
      angle = (i-(cnt-1)/2) * 0.35;
    } else {
      // ê° ê³¡ê´­ì´ë§ˆë‹¤ ë‹¤ë¥¸ ì ì„ ì¡°ì¤€ (ìˆœí™˜)
      const target = sortedEnemies[i % sortedEnemies.length];
      // ê°™ì€ ì ì„ ì—¬ëŸ¬ ë²ˆ ì¡°ì¤€í•  ë•Œ ì•½ê°„ì˜ í¸ì°¨ ì¶”ê°€
      const jitter = (i > 0 && sortedEnemies.length < cnt) ? (i * 0.18 * (i%2===0?1:-1)) : 0;
      angle = Math.atan2(target.y-player.y, target.x-player.x) + jitter;
    }
    const maxDist = 180 + wlv*30;

    boomerangs.push({
      x: player.x, y: player.y,
      vx: Math.cos(angle)*spd, vy: Math.sin(angle)*spd,
      dmg,
      r: isGolden ? 11 : 9,
      color: isGolden ? '#FFD700' : '#c8a060',
      glowColor: isGolden ? 'rgba(255,215,0,0.9)' : 'rgba(200,160,96,0.8)',
      maxDist, distTraveled: 0,
      returning: false,
      rot: 0, rotSpd: 12,
      hitSet: new Set(),
      pierce: isGolden ? 99 : 3 + wlv,
      life: 4.0,
      isGolden,
    });
  }
  SFX.axeThrow();
}

function updateBoomerangs(dt){
  for(let i=boomerangs.length-1; i>=0; i--){
    const b = boomerangs[i];
    b.life -= dt;
    b.rot += b.rotSpd * dt;

    if(!b.returning){
      const moved = Math.hypot(b.vx*dt, b.vy*dt);
      b.distTraveled += moved;
      b.x += b.vx*dt; b.y += b.vy*dt;

      if(b.distTraveled >= b.maxDist){
        b.returning = true;
        b.hitSet.clear();
      }
    } else {
      const dx = player.x - b.x, dy = player.y - b.y;
      const d = Math.hypot(dx, dy)||1;
      const returnSpd = 320;
      b.vx = (dx/d)*returnSpd; b.vy = (dy/d)*returnSpd;
      b.x += b.vx*dt; b.y += b.vy*dt;

      if(d < 20 || b.life <= 0){
        boomerangs.splice(i, 1);
        continue;
      }
    }

    if(b.life <= 0){ boomerangs.splice(i, 1); continue; }

    for(let j=enemies.length-1; j>=0; j--){
      const e = enemies[j];
      if(b.hitSet.has(e)) continue;
      if(dist(b.x, b.y, e.x, e.y) < b.r + e.type.size){
        b.hitSet.add(e);
        hitEnemy(e, b.dmg, b.isGolden?'goldenPick':'pickaxe');
        const col = b.isGolden ? '#FFD700' : '#c8a060';
        for(let k=0; k<4; k++){
          const a=Math.random()*Math.PI*2, s=50+Math.random()*80;
          particles.push({x:e.x,y:e.y,vx:Math.cos(a)*s,vy:Math.sin(a)*s,life:0.35,maxLife:0.35,r:2.5,color:col,type:'dot'});
        }
        if(b.pierce<=0){ boomerangs.splice(i, 1); break; }
        b.pierce--;
      }
    }
  }
}

// â˜…â˜…â˜… í™©ê¸ˆ ê³¡ê´­ì´ - ê°ê°œê²©íŒŒ ì¡°ì¤€ â˜…â˜…â˜…
function fireGoldenPick(){
  const dmg = 220 * player.dmgMul;
  const spd = 320;
  // â˜… ê°ê° ë‹¤ë¥¸ ì  ì¡°ì¤€
  const sortedEnemies = [...enemies].sort((a,b)=>
    dist(player.x,player.y,a.x,a.y) - dist(player.x,player.y,b.x,b.y)
  );
  for(let i=0; i<3; i++){
    let angle;
    if(sortedEnemies.length === 0){
      angle = (i-1)*0.4;
    } else {
      const target = sortedEnemies[i % sortedEnemies.length];
      // ê°™ì€ ì  ì¬ì¡°ì¤€ ì‹œ í¸ì°¨
      const jitter = (sortedEnemies.length < 3 && i > 0) ? (i * 0.2 * (i%2===0?1:-1)) : 0;
      angle = Math.atan2(target.y-player.y, target.x-player.x) + jitter;
    }
    boomerangs.push({
      x:player.x, y:player.y,
      vx:Math.cos(angle)*spd, vy:Math.sin(angle)*spd,
      dmg, r:13, color:'#FFD700', glowColor:'rgba(255,215,0,0.95)',
      maxDist:240, distTraveled:0, returning:false,
      rot:0, rotSpd:18, hitSet:new Set(), pierce:99, life:5.0, isGolden:true,
    });
  }
  SFX.evolution();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  WEAPON FIRING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function fireWeapons(dt){
  for(let wid in player.weapons){
    const wlv=player.weapons[wid]-1;
    const wd=WEAPON_DATA[wid]; if(!wd) continue;
    player.weaponCooldowns[wid]=(player.weaponCooldowns[wid]||0)-dt;
    if(player.weaponCooldowns[wid]>0) continue;
    player.weaponCooldowns[wid]=wd.cdBase*Math.pow(0.85,wlv)*player.cdrMul;
    _currentWeaponId = wid;
    switch(wid){
      case'pickaxe':   firePickaxe(wlv,wd); break;
      case'goldenPick':fireGoldenPick();   break;
      case'orb':    SFX.orbShoot();   fireOrb(wlv,wd);    break;
      case'axe':    SFX.axeThrow();   fireAxe(wlv,wd);    break;
      case'aura':   SFX.auraHum();    fireAura(wlv,wd);   break;
      case'cross':  SFX.crossShoot(); fireCross(wlv,wd);  break;
      case'bolt':   SFX.boltStrike(); fireBolt(wlv,wd);   break;
      case'nova':   SFX.novaExplode();fireNova(wlv,wd);   break;
      case'blade':                    updateBlade(wlv,wd);break;
      case'arrow':  SFX.arrowShoot(); fireArrow(wlv,wd);  break;
      case'ice':    SFX.iceShoot();   fireIce(wlv,wd);    break;
      case'bat':    SFX.whipCrack();  fireBat(wlv,wd);    break;
      case'homerun':SFX.whipCrack();  fireHomerun();  break;
      case'shotgun':SFX.shotgunBlast();fireShotgun(wlv,wd);break;
      case'minigun':SFX.minigunFire(); fireMinigun();  break;
      case'meteor': SFX.meteorFall(); fireMeteor();  break;
      case'storm':  SFX.auraHum();    fireStorm();   break;
      case'divine': SFX.crossShoot(); fireDivine();  break;
      case'thunder':SFX.boltStrike(); fireThunder(); break;
      case'inferno':SFX.novaExplode();fireInferno(); break;
      case'phantom':                  updatePhantom();break;
      case'tempest':SFX.arrowShoot(); fireTempest(); break;
      case'glacier':SFX.iceShoot();   fireGlacier(); break;

    }
  }
  _currentWeaponId = null;
}

function nearestEnemy(x,y){ let b=null,bd=Infinity; for(let e of enemies){const d=dist(x,y,e.x,e.y);if(d<bd){bd=d;b=e;}} return b; }
function dist(x1,y1,x2,y2){ return Math.hypot(x2-x1,y2-y1); }

function fireOrb(wlv,wd){
  const base=1+wlv+(player._orbExtra||0);
  const dmg=(wd.dmgBase+wlv*10)*player.dmgMul;
  const target=nearestEnemy(player.x,player.y);
  const a=target?Math.atan2(target.y-player.y,target.x-player.x):0;
  for(let i=0;i<base;i++) orbBurstQueue.push({angle:a,dmg,spd:wd.spdBase});
}
function updateOrbBurst(dt){
  if(!orbBurstQueue.length) return;
  orbBurstTimer-=dt;
  if(orbBurstTimer<=0){
    orbBurstTimer=0.12;
    const o=orbBurstQueue.shift();
    const sp=(Math.random()-0.5)*0.12;
    projectiles.push({x:player.x,y:player.y,vx:Math.cos(o.angle+sp)*o.spd,vy:Math.sin(o.angle+sp)*o.spd,
      dmg:o.dmg,r:7,color:'#9A4FFF',life:2.5,pierce:1,type:'orb',glow:'rgba(168,85,247,0.7)',hitSet:new Set()});
  }
}
function fireAxe(wlv,wd){
  const cnt=1+Math.floor(wlv/2),dmg=(wd.dmgBase+wlv*20)*player.dmgMul;
  for(let i=0;i<cnt;i++){
    const a=Math.random()*Math.PI*2;
    projectiles.push({x:player.x,y:player.y,vx:Math.cos(a)*wd.spdBase,vy:Math.sin(a)*wd.spdBase-200,
      dmg,r:9,color:'#C0A020',life:2.0,pierce:99,type:'axe',gravity:350,glow:'rgba(200,160,32,0.6)',rot:0});
  }
}
function fireAura(wlv,wd){
  const range=80+wlv*20,dmg=(wd.dmgBase+wlv*8)*0.5*player.dmgMul;
  for(let e of enemies){ if(dist(player.x,player.y,e.x,e.y)<range) hitEnemy(e,dmg); }
  particles.push({x:player.x,y:player.y,r:range,life:0.3,maxLife:0.3,type:'ring',color:'rgba(100,0,150,0.3)'});
}
function fireCross(wlv,wd){
  const dmg=(wd.dmgBase+wlv*25)*player.dmgMul;
  for(let i=0;i<4;i++){const a=i*Math.PI/2;projectiles.push({x:player.x,y:player.y,vx:Math.cos(a)*wd.spdBase,vy:Math.sin(a)*wd.spdBase,dmg,r:8,color:'#FFD700',life:3.0,pierce:99,type:'cross',glow:'rgba(255,215,0,0.7)'});}
}
function fireBolt(wlv,wd){
  const cnt=1+wlv,dmg=(wd.dmgBase+wlv*20)*player.dmgMul;
  if(!enemies.length) return;
  // ì¹´ë©”ë¼(í”Œë ˆì´ì–´) ê¸°ì¤€ í™”ë©´ ì•ˆì— ìˆëŠ” ì ë§Œ ëŒ€ìƒ
  const pool=[...enemies].filter(e=>
    Math.abs(e.x-player.x) < W*0.5 &&
    Math.abs(e.y-player.y) < H*0.5
  );
  if(!pool.length) return;
  const shuffled=[...pool].sort(()=>Math.random()-0.5).slice(0,cnt);
  for(const e of shuffled){
    hitEnemy(e,dmg);
    particles.push({type:'lightning',x:e.x,y:e.y,life:0.25,maxLife:0.25});
    particles.push({x:e.x,y:e.y,r:0,maxR:30,life:0.2,maxLife:0.2,type:'nova',color:'#aaeeff'});
  }
}
function fireNova(wlv,wd){
  const range=100+wlv*30,dmg=(wd.dmgBase+wlv*40)*player.dmgMul;
  for(let e of enemies){ if(dist(player.x,player.y,e.x,e.y)<range) hitEnemy(e,dmg); }
  particles.push({x:player.x,y:player.y,r:0,maxR:range,life:0.4,maxLife:0.4,type:'nova',color:'#FF6600'});
}
function updateBlade(wlv,wd){
  const cnt=2+wlv+(player._bladeExtra||0),dmg=(wd.dmgBase+wlv*8)*player.dmgMul,radius=60;
  for(let e of enemies){
    for(let i=0;i<cnt;i++){
      const angle=gameTime*2.5+i*(Math.PI*2/cnt);
      const bx=player.x+Math.cos(angle)*radius,by=player.y+Math.sin(angle)*radius;
      if(dist(bx,by,e.x,e.y)<e.type.size+10) hitEnemy(e,dmg*0.05);
    }
  }
}
function fireArrow(wlv,wd){
  const cnt=1+Math.floor(wlv/2),dmg=(wd.dmgBase+wlv*12)*player.dmgMul;
  const target=nearestEnemy(player.x,player.y);
  const baseA=target?Math.atan2(target.y-player.y,target.x-player.x):0;
  for(let i=0;i<cnt;i++){
    const a=baseA+(cnt>1?(i-(cnt-1)/2)*0.25:0);
    projectiles.push({x:player.x,y:player.y,vx:Math.cos(a)*wd.spdBase,vy:Math.sin(a)*wd.spdBase,dmg,r:5,color:'#AAFFAA',life:1.8,pierce:3,type:'bolt',glow:'rgba(170,255,170,0.7)'});
  }
}
function fireIce(wlv,wd){
  const target=nearestEnemy(player.x,player.y); if(!target) return;
  const dmg=(wd.dmgBase+wlv*18)*player.dmgMul,a=Math.atan2(target.y-player.y,target.x-player.x);
  projectiles.push({x:player.x,y:player.y,vx:Math.cos(a)*wd.spdBase,vy:Math.sin(a)*wd.spdBase,
    dmg,r:10,color:'#88CCFF',life:2.2,pierce:2+wlv,type:'orb',glow:'rgba(136,200,255,0.9)',
    onHit:(e)=>{ e.spd*=0.5; setTimeout(()=>{ if(e) e.spd*=2; },(1+wlv)*1000); }});
}
function fireBat(wlv,wd){
  const faceAngle = player.aimAngle !== undefined ? player.aimAngle : (player.facing>0?0:Math.PI);
  const arcHalf=Math.PI*(0.38+wlv*0.04);
  const range=110+wlv*18;
  const dmg=(wd.dmgBase+wlv*20)*player.dmgMul*(1+(player._batDmgBonus||0));
  const kb=player._batKnockback||60;
  let hit=0;
  for(let e of enemies){
    const dx=e.x-player.x,dy=e.y-player.y,d=Math.hypot(dx,dy);
    if(d>range) continue;
    let diff=Math.atan2(dy,dx)-faceAngle;
    while(diff>Math.PI) diff-=Math.PI*2; while(diff<-Math.PI) diff+=Math.PI*2;
    if(Math.abs(diff)<arcHalf){
      hitEnemy(e,dmg); e.x+=dx/d*kb; e.y+=dy/d*kb; hit++;
      particles.push({x:e.x,y:e.y,vx:Math.cos(faceAngle)*120,vy:-60,life:0.3,maxLife:0.3,r:4,color:'#fb923c',type:'dot'});
    }
  }
  particles.push({type:'arc',x:player.x,y:player.y,angle:faceAngle,arcHalf,range,life:0.22,maxLife:0.22,color:'rgba(251,146,60,'});
}
function fireHomerun(){
  const range=240*(1+(player._batDmgBonus||0)*0.5);
  const dmg=220*player.dmgMul*(1+(player._batDmgBonus||0));
  const kb=(player._batKnockback||60)*2;
  for(let e of enemies){
    const dx=e.x-player.x,dy=e.y-player.y,d=Math.hypot(dx,dy);
    if(d>range) continue;
    hitEnemy(e,dmg); e.x+=dx/d*kb; e.y+=dy/d*kb;
  }
  for(let i=0;i<24;i++){
    const a=Math.random()*Math.PI*2,r=20+Math.random()*range;
    particles.push({x:player.x+Math.cos(a)*r,y:player.y+Math.sin(a)*r,
      vx:Math.cos(a)*180,vy:Math.sin(a)*180,
      life:0.55,maxLife:0.55,r:3+Math.random()*5,
      color:i%2===0?'#fb923c':'#fbbf24',type:'dot'});
  }
  particles.push({x:player.x,y:player.y,r:0,maxR:range,life:0.5,maxLife:0.5,type:'nova',color:'rgba(251,146,60,0.6)'});
}

// â”€â”€ ìƒ·ê±´: ê°€ì¥ ê°€ê¹Œìš´ ì  ìë™ì¡°ì¤€, ì‚°íƒ„ ë°œì‚¬
function fireShotgun(wlv, wd){
  const pellets = 3 + wlv;          // Lv0=3ë°œ, ìµœëŒ€ Lv4=7ë°œ
  const dmg = (wd.dmgBase + wlv * 8) * player.dmgMul;
  const spd = wd.spdBase;
  const range = 320 + wlv * 20;     // ìœ íš¨ ì‚¬ê±°ë¦¬ (lifeë¡œ ì œí•œ)
  const life = range / spd;

  // ìë™ì¡°ì¤€: í™”ë©´ ì•ˆ ê°€ì¥ ê°€ê¹Œìš´ ì 
  const target = enemies
    .filter(e => Math.abs(e.x-player.x)<W*0.5 && Math.abs(e.y-player.y)<H*0.5)
    .sort((a,b) => dist(player.x,player.y,a.x,a.y)-dist(player.x,player.y,b.x,b.y))[0];

  const baseAngle = target
    ? Math.atan2(target.y-player.y, target.x-player.x)
    : (player.facing > 0 ? 0 : Math.PI);

  const spread = 0.28 + wlv * 0.02;  // ì‚°íƒ„ í¼ì§
  for(let i = 0; i < pellets; i++){
    const t = pellets === 1 ? 0 : (i/(pellets-1) - 0.5);
    const angle = baseAngle + t * spread * 2;
    projectiles.push({
      x: player.x, y: player.y,
      vx: Math.cos(angle)*spd, vy: Math.sin(angle)*spd,
      dmg, r: 5, life, pierce: 1,
      color: '#ffe066', glow: 'rgba(255,224,102,0.8)', type: 'bolt',
    });
  }
  // ì´êµ¬ í™”ì—¼ íŒŒí‹°í´
  const muzzleX = player.x + Math.cos(baseAngle)*20;
  const muzzleY = player.y + Math.sin(baseAngle)*20;
  for(let i=0; i<6; i++){
    const a = baseAngle + (Math.random()-0.5)*spread*2;
    particles.push({x:muzzleX, y:muzzleY, vx:Math.cos(a)*180, vy:Math.sin(a)*180,
      life:0.12, maxLife:0.12, r:3+Math.random()*3, color:'#ffcc44', type:'dot'});
  }
}

// â”€â”€ ê¸°ê´€ì´(ì§„í™”): ì¿¨íƒ€ì„ ê·¹ì†Œ, ìë™ì¡°ì¤€ ë‹¨ë°œ ê³ ì† ì—°ì‚¬
function fireMinigun(){
  const target = enemies
    .filter(e => Math.abs(e.x-player.x)<W*0.5 && Math.abs(e.y-player.y)<H*0.5)
    .sort((a,b) => dist(player.x,player.y,a.x,a.y)-dist(player.x,player.y,b.x,b.y))[0];
  const baseAngle = target
    ? Math.atan2(target.y-player.y, target.x-player.x)
    : (player.facing > 0 ? 0 : Math.PI);
  const spread = (Math.random()-0.5)*0.08;
  const a = baseAngle + spread;
  projectiles.push({
    x: player.x, y: player.y,
    vx: Math.cos(a)*600, vy: Math.sin(a)*600,
    dmg: 35 * player.dmgMul, r: 4, life: 0.7, pierce: 2,
    color: '#ff4466', glow: 'rgba(255,68,102,0.85)', type: 'bolt',
  });
  // ì´êµ¬ ìŠ¤íŒŒí¬
  particles.push({x:player.x+Math.cos(a)*18, y:player.y+Math.sin(a)*18,
    vx:Math.cos(a)*120, vy:Math.sin(a)*120,
    life:0.08, maxLife:0.08, r:3, color:'#ff8888', type:'dot'});
}
function fireTempest(){ const target=nearestEnemy(player.x,player.y),baseA=target?Math.atan2(target.y-player.y,target.x-player.x):0; for(let i=0;i<5;i++){const a=baseA+(i-2)*0.22;projectiles.push({x:player.x,y:player.y,vx:Math.cos(a)*480,vy:Math.sin(a)*480,dmg:180,r:6,color:'#CCFFCC',life:1.5,pierce:99,type:'bolt',glow:'rgba(180,255,180,0.8)'}); } }
function fireGlacier(){ for(let e of enemies){ if(dist(player.x,player.y,e.x,e.y)<350){ hitEnemy(e,200); e.spd*=0.3; setTimeout(()=>{ if(e) e.spd/=0.3; },2000); } } particles.push({x:player.x,y:player.y,r:0,maxR:350,life:0.7,maxLife:0.7,type:'nova',color:'#88CCFF'}); }
function fireMeteor(){ const e=enemies[Math.floor(Math.random()*enemies.length)]; if(!e) return; const tx=e.x+(Math.random()-0.5)*80,ty=e.y+(Math.random()-0.5)*80; projectiles.push({x:tx-200,y:ty-200,vx:200,vy:200,dmg:250,r:14,color:'#FF4400',life:1.5,pierce:99,type:'meteor',glow:'rgba(255,68,0,0.9)'}); }
function fireStorm(){ const range=180,dmg=30; for(let e of enemies){ if(dist(player.x,player.y,e.x,e.y)<range) hitEnemy(e,dmg); } particles.push({x:player.x,y:player.y,r:range,life:0.3,maxLife:0.3,type:'ring',color:'rgba(80,200,255,0.5)'}); }
function fireDivine(){ const dmg=280; for(let i=0;i<8;i++){const a=i*Math.PI/4;projectiles.push({x:player.x,y:player.y,vx:Math.cos(a)*240,vy:Math.sin(a)*240,dmg,r:10,color:'#FFFAAA',life:3.5,pierce:99,type:'cross',glow:'rgba(255,255,180,0.9)'});} }
function fireThunder(){
  const onScreen = enemies.filter(e=>
    Math.abs(e.x-player.x) < W*0.5 &&
    Math.abs(e.y-player.y) < H*0.5
  );
  [...onScreen].sort((a,b)=>dist(player.x,player.y,a.x,a.y)-dist(player.x,player.y,b.x,b.y))
    .slice(0,8).forEach(e=>{
      hitEnemy(e,200);
      particles.push({x:e.x,y:e.y,r:20,life:0.2,maxLife:0.2,type:'nova',color:'#88FFFF'});
    });
}
function fireInferno(){ const range=180,dmg=60; for(let e of enemies){ if(dist(player.x,player.y,e.x,e.y)<range) hitEnemy(e,dmg); } particles.push({x:player.x,y:player.y,r:0,maxR:range,life:0.6,maxLife:0.6,type:'nova',color:'#FF3300'}); }
function updatePhantom(){ const cnt=4,dmg=80,radius=80; for(let e of enemies){ for(let i=0;i<cnt;i++){ const angle=gameTime*3+i*(Math.PI*2/cnt),bx=player.x+Math.cos(angle)*radius,by=player.y+Math.sin(angle)*radius; if(dist(bx,by,e.x,e.y)<e.type.size+14) hitEnemy(e,dmg*0.06); } } }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  HIT / KILL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let _currentWeaponId = null;

function hitEnemy(e,dmg,weaponId){
  e.hp-=dmg; e.hitFlash=0.12;
  dmgNums.push({x:e.x+(Math.random()-0.5)*18,y:e.y-8,val:Math.round(dmg),life:0.8,vy:-45,color:'#f0c040'});
  const wid = weaponId || _currentWeaponId || 'unknown';
  trackDamage(wid, dmg);
  if(e.hp<=0) killEnemy(e);
  else if(Math.random()<0.08) SFX.enemyHit();
}

function killEnemy(e){
  kills++;
  if(e.isBoss){
    activeBoss=null; isBossPhase=false; bossProjectiles=[]; SFX.bossDie();
    for(let i=0;i<3+Math.floor(Math.random()*3);i++){
      const a=Math.random()*Math.PI*2, d=30+Math.random()*80;
      const weights=['coin','coin','magnet','bomb','chicken','chicken'];
      const kind=weights[Math.floor(Math.random()*weights.length)];
      const t2=FLOOR_ITEM_TYPES[kind];
      floorItems.push({x:e.x+Math.cos(a)*d,y:e.y+Math.sin(a)*d,kind,r:t2.r,life:25,bob:Math.random()*6});
    }
    const bossCoins = player.isMiner ? 45 : 30;
    saveData.coins += bossCoins;
    document.getElementById('coin-hud').textContent='ğŸª™ '+saveData.coins;
    showNotif(`ğŸ’€ ë³´ìŠ¤ ì²˜ì¹˜! +${bossCoins}ğŸª™`,'#ffd700');
  } else if(Math.random()<0.3) SFX.enemyDie();

  const xpGain = Math.round(e.xp * (player.bonusXP||1.0));
  xpGems.push({x:e.x,y:e.y,val:xpGain,r:5,life:20});
  for(let i=0;i<6;i++){
    const a=Math.random()*Math.PI*2,spd=40+Math.random()*80;
    particles.push({x:e.x,y:e.y,vx:Math.cos(a)*spd,vy:Math.sin(a)*spd,life:0.5,maxLife:0.5,r:2+Math.random()*2,color:e.type.color,type:'dot'});
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FLOOR ITEMS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const FLOOR_SPAWN_WEIGHTS = ['coin','coin','coin','magnet','bomb','chicken','chicken','poison'];

function spawnFloorItem(){
  const a=Math.random()*Math.PI*2, d=120+Math.random()*180;
  const typeName=FLOOR_SPAWN_WEIGHTS[Math.floor(Math.random()*FLOOR_SPAWN_WEIGHTS.length)];
  const t=FLOOR_ITEM_TYPES[typeName];
  floorItems.push({x:player.x+Math.cos(a)*d,y:player.y+Math.sin(a)*d,kind:typeName,r:t.r,life:18,bob:0});
}

function applyFloorItem(fi){
  if(fi.kind==='coin'){
    const coinAmt = player.isMiner ? 25 : 20;
    saveData.coins+=coinAmt;
    document.getElementById('coin-hud').textContent='ğŸª™ '+saveData.coins;
    SFX.coinEarn();
    dmgNums.push({x:fi.x,y:fi.y-6,val:`+${coinAmt}ğŸª™`,life:1.0,vy:-30,color:'#FFD700'});
  } else if(fi.kind==='magnet'){
    for(let g of xpGems){ g.x=player.x; g.y=player.y; }
    SFX.levelUp(); showNotif('ğŸ§² XP ì „ë¶€ í¡ìˆ˜!','#4488ff');
  } else if(fi.kind==='bomb'){
    const killed=enemies.filter(e=>!e.isBoss);
    killed.forEach(e=>{
      kills++;
      xpGems.push({x:e.x,y:e.y,val:Math.round(e.xp*(player.bonusXP||1.0)),r:5,life:20});
      for(let i=0;i<4;i++){
        const ba=Math.random()*Math.PI*2,bs=40+Math.random()*60;
        particles.push({x:e.x,y:e.y,vx:Math.cos(ba)*bs,vy:Math.sin(ba)*bs,life:0.4,maxLife:0.4,r:2,color:e.type.color,type:'dot'});
      }
    });
    enemies=enemies.filter(e=>e.isBoss);
    particles.push({x:player.x,y:player.y,r:0,maxR:400,life:0.6,maxLife:0.6,type:'nova',color:'#FF4422'});
    SFX.novaExplode(); SFX.bossWarning();
    showNotif('ğŸ’£ í­íƒ„ í­ë°œ!','#ff4422');
  } else if(fi.kind==='chicken'){
    const healed=Math.min(40,player.maxHp-player.hp);
    player.hp=Math.min(player.maxHp,player.hp+40);
    SFX.coinEarn();
    dmgNums.push({x:fi.x,y:fi.y-6,val:'+'+Math.round(healed)+'HP',life:1.0,vy:-30,color:'#4ade80'});
  } else if(fi.kind==='poison'){
    player.hp=Math.max(1,player.hp-30);
    SFX.playerHit();
    dmgNums.push({x:fi.x,y:fi.y-6,val:'-30HP',life:1.0,vy:-30,color:'#AA44FF'});
    particles.push({x:player.x,y:player.y,r:0,maxR:60,life:0.3,maxLife:0.3,type:'nova',color:'#AA44FF'});
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SOUND SYSTEM
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let audioCtx=null, masterGain=null, soundEnabled=true;

function getAudioCtx(){
  if(!audioCtx){ audioCtx=new(window.AudioContext||window.webkitAudioContext)(); masterGain=audioCtx.createGain(); masterGain.gain.value=0.35; masterGain.connect(audioCtx.destination); }
  if(audioCtx.state==='suspended') audioCtx.resume();
  return audioCtx;
}

function playTone({freq=440,freq2=null,type='sine',duration=0.15,volume=0.4,attack=0.005,decay=0.05,sustain=0.3,release=0.1,detune=0,freqSlide=null,delay=0}={}){
  if(!soundEnabled) return;
  try{
    const ac=getAudioCtx(),t=ac.currentTime+delay,osc=ac.createOscillator(),gain=ac.createGain();
    osc.connect(gain);gain.connect(masterGain);osc.type=type;osc.frequency.setValueAtTime(freq,t);osc.detune.setValueAtTime(detune,t);
    if(freqSlide!==null) osc.frequency.linearRampToValueAtTime(freqSlide,t+duration);
    if(freq2!==null) osc.frequency.linearRampToValueAtTime(freq2,t+duration*0.5);
    gain.gain.setValueAtTime(0,t);gain.gain.linearRampToValueAtTime(volume,t+attack);gain.gain.linearRampToValueAtTime(volume*sustain,t+attack+decay);gain.gain.setValueAtTime(volume*sustain,t+duration-release);gain.gain.linearRampToValueAtTime(0,t+duration);
    osc.start(t);osc.stop(t+duration+0.01);
  }catch(e){}
}

function playNoise({duration=0.1,volume=0.3,filterFreq=2000,filterType='bandpass',delay=0}={}){
  if(!soundEnabled) return;
  try{
    const ac=getAudioCtx(),t=ac.currentTime+delay,bufLen=Math.ceil(ac.sampleRate*duration),buf=ac.createBuffer(1,bufLen,ac.sampleRate),data=buf.getChannelData(0);
    for(let i=0;i<bufLen;i++) data[i]=Math.random()*2-1;
    const src=ac.createBufferSource();src.buffer=buf;
    const filter=ac.createBiquadFilter();filter.type=filterType;filter.frequency.value=filterFreq;
    const gain=ac.createGain();
    src.connect(filter);filter.connect(gain);gain.connect(masterGain);
    gain.gain.setValueAtTime(volume,t);gain.gain.linearRampToValueAtTime(0,t+duration);
    src.start(t);src.stop(t+duration+0.01);
  }catch(e){}
}

const SFX={
  orbShoot(){ playTone({freq:520,freqSlide:380,type:'sine',duration:0.12,volume:0.22,attack:0.005,decay:0.04,sustain:0.2,release:0.06}); },
  axeThrow(){ playTone({freq:200,freq2:120,type:'sawtooth',duration:0.18,volume:0.28,attack:0.01,decay:0.08,sustain:0.2,release:0.08}); },
  auraHum(){ playTone({freq:80,type:'sine',duration:0.3,volume:0.1,attack:0.05,decay:0.1,sustain:0.6,release:0.15,detune:5}); },
  crossShoot(){ playTone({freq:660,freqSlide:880,type:'square',duration:0.1,volume:0.2,attack:0.003,decay:0.04,sustain:0.3,release:0.05}); },
  boltStrike(){ playNoise({duration:0.06,volume:0.45,filterFreq:6000,filterType:'highpass'}); playTone({freq:120,freqSlide:60,type:'sawtooth',duration:0.08,volume:0.3,attack:0.001,decay:0.03,sustain:0.1,release:0.04}); },
  novaExplode(){ playNoise({duration:0.25,volume:0.4,filterFreq:800,filterType:'lowpass'}); playTone({freq:100,freqSlide:50,type:'sawtooth',duration:0.25,volume:0.28,attack:0.01,decay:0.1,sustain:0.2,release:0.12}); },
  whipCrack(){ playNoise({duration:0.08,volume:0.5,filterFreq:4000,filterType:'bandpass'}); playTone({freq:300,freqSlide:800,type:'sawtooth',duration:0.07,volume:0.25,attack:0.001,decay:0.03,sustain:0.1,release:0.03}); },
  shotgunBlast(){ playNoise({duration:0.14,volume:0.7,filterFreq:1200,filterType:'lowpass'}); playTone({freq:90,freqSlide:40,type:'sawtooth',duration:0.14,volume:0.4,attack:0.001,decay:0.05,sustain:0.1,release:0.06}); },
  minigunFire(){ playNoise({duration:0.04,volume:0.35,filterFreq:2500,filterType:'bandpass'}); },
  arrowShoot(){ playTone({freq:700,freqSlide:500,type:'sawtooth',duration:0.09,volume:0.18,attack:0.002,decay:0.04,sustain:0.15,release:0.04}); },
  iceShoot(){ playTone({freq:900,freqSlide:600,type:'sine',duration:0.14,volume:0.2,attack:0.005,decay:0.05,sustain:0.3,release:0.07,detune:-10}); playTone({freq:1100,freqSlide:700,type:'sine',duration:0.14,volume:0.1,attack:0.01,decay:0.05,sustain:0.2,release:0.07,delay:0.02}); },
  meteorFall(){ playNoise({duration:0.3,volume:0.45,filterFreq:400,filterType:'lowpass'}); playTone({freq:80,freqSlide:40,type:'sawtooth',duration:0.3,volume:0.35,attack:0.01,decay:0.1,sustain:0.4,release:0.15}); },
  enemyHit(){ playTone({freq:180,freqSlide:120,type:'square',duration:0.05,volume:0.15,attack:0.001,decay:0.02,sustain:0.1,release:0.02}); },
  enemyDie(){ playNoise({duration:0.1,volume:0.25,filterFreq:600,filterType:'lowpass'}); playTone({freq:150,freqSlide:60,type:'sawtooth',duration:0.1,volume:0.2,attack:0.002,decay:0.04,sustain:0.1,release:0.05}); },
  bossDie(){ for(let i=0;i<4;i++){ playNoise({duration:0.3,volume:0.45-i*0.07,filterFreq:800-i*100,filterType:'lowpass',delay:i*0.08}); playTone({freq:200-i*30,freqSlide:80-i*10,type:'sawtooth',duration:0.3,volume:0.3,attack:0.01,decay:0.08,sustain:0.3,release:0.15,delay:i*0.08}); } },
  playerHit(){ playNoise({duration:0.1,volume:0.35,filterFreq:300,filterType:'lowpass'}); playTone({freq:100,freqSlide:60,type:'square',duration:0.1,volume:0.28,attack:0.001,decay:0.04,sustain:0.2,release:0.05}); },
  playerDie(){ playNoise({duration:0.5,volume:0.55,filterFreq:200,filterType:'lowpass'}); for(let i=0;i<5;i++) playTone({freq:300-i*40,freqSlide:80,type:'sawtooth',duration:0.4,volume:0.28-i*0.04,attack:0.01,decay:0.1,sustain:0.3,release:0.2,delay:i*0.05}); },
  xpPickup(){ playTone({freq:880,freqSlide:1100,type:'sine',duration:0.07,volume:0.12,attack:0.003,decay:0.02,sustain:0.2,release:0.03}); },
  levelUp(){ const notes=[523,659,784,1047]; notes.forEach((f,i)=>playTone({freq:f,freqSlide:f*1.05,type:'sine',duration:0.18,volume:0.32,attack:0.005,decay:0.06,sustain:0.4,release:0.08,delay:i*0.1})); playTone({freq:1568,type:'triangle',duration:0.4,volume:0.18,attack:0.01,decay:0.1,sustain:0.3,release:0.2,delay:0.4}); },
  evolution(){ const notes=[262,330,392,523,659,784]; notes.forEach((f,i)=>playTone({freq:f,freqSlide:f*1.1,type:'sawtooth',duration:0.3,volume:0.28,attack:0.01,decay:0.08,sustain:0.5,release:0.15,delay:i*0.07})); playNoise({duration:0.4,volume:0.18,filterFreq:3000,filterType:'highpass',delay:0.1}); },
  bossWarning(){ playTone({freq:110,freqSlide:55,type:'sawtooth',duration:0.5,volume:0.38,attack:0.02,decay:0.1,sustain:0.6,release:0.2}); playTone({freq:110,freqSlide:55,type:'sawtooth',duration:0.5,volume:0.32,attack:0.02,decay:0.1,sustain:0.6,release:0.2,delay:0.55,detune:15}); },
  bossSpawn(){ playNoise({duration:0.6,volume:0.45,filterFreq:200,filterType:'lowpass'}); for(let i=0;i<3;i++) playTone({freq:80+i*20,type:'sawtooth',duration:0.6,volume:0.35,attack:0.02,decay:0.15,sustain:0.5,release:0.25,delay:i*0.12}); },
  coinEarn(){ playTone({freq:1047,freqSlide:1319,type:'sine',duration:0.12,volume:0.28,attack:0.004,decay:0.05,sustain:0.3,release:0.06}); playTone({freq:1319,freqSlide:1568,type:'sine',duration:0.12,volume:0.18,attack:0.006,decay:0.05,sustain:0.3,release:0.06,delay:0.08}); },
  buyItem(){ playTone({freq:440,freqSlide:550,type:'sine',duration:0.15,volume:0.28,attack:0.005,decay:0.05,sustain:0.4,release:0.07}); playTone({freq:660,freqSlide:880,type:'sine',duration:0.15,volume:0.18,attack:0.01,decay:0.05,sustain:0.3,release:0.07,delay:0.1}); },
  stageClear(){ const mel=[523,659,784,880,1047,880,1047,1319]; mel.forEach((f,i)=>playTone({freq:f,type:'sine',duration:0.22,volume:0.32,attack:0.005,decay:0.07,sustain:0.5,release:0.1,delay:i*0.12})); },
  chestOpen(){ playNoise({duration:0.15,volume:0.28,filterFreq:2000,filterType:'bandpass'}); [330,415,523,622,784].forEach((f,i)=>playTone({freq:f,type:'sine',duration:0.18,volume:0.28,attack:0.005,decay:0.06,sustain:0.4,release:0.09,delay:i*0.06})); },
};

function toggleSound(){ soundEnabled=!soundEnabled; document.getElementById('snd-btn').textContent=soundEnabled?'ğŸ”Š':'ğŸ”‡'; }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  XP / LEVEL UP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function gainXP(val){
  player.xp+=val;
  if(player.xp>=player.xpNext){
    player.xp-=player.xpNext;
    const growthRate=player.level<10?1.18:player.level<20?1.12:1.08;
    player.xpNext=Math.round(player.xpNext*growthRate);
    player.level++;
    const evos=getEvolutions();
    if(evos.length>0){ SFX.evolution(); showEvoChoice(evos); }
    else{ SFX.levelUp(); showLevelUp(); }
  }
}

function getEvolutions(){
  const evos=[];
  const charDef = selectedChar ? CHARACTERS[selectedChar] : null;
  const bannedWeapons = charDef ? (charDef.bannedWeapons||[]) : [];
  for(let r of EVO_RECIPES){
    const wMaxLv = WEAPON_DATA[r.weapon]?.maxLv;
    const hasWeaponMaxed = player.weapons[r.weapon] && player.weapons[r.weapon]>=wMaxLv;
    const hasAcc = player.accessories[r.acc] && !player.accessories[r.acc+'_evolved'];
    const notYetEvolved = !player.weapons[r.result];
    const notBanned = !bannedWeapons.includes(r.result);
    if(hasWeaponMaxed && hasAcc && notYetEvolved && notBanned) evos.push(r);
  }
  return evos;
}

function applyEvolution(r){
  delete player.weapons[r.weapon];
  delete player.weaponCooldowns[r.weapon];
  if(player.accessories[r.acc]) player.accessories[r.acc+'_evolved']=1;
  player.weapons[r.result]=1; player.weaponCooldowns[r.result]=0;
  if(r.result==='goldenPick') boomerangs=[];
  updateSlots(); updateCooldownHUD();
  showNotif(`${r.icon} ${r.name} ìœ¼ë¡œ ì§„í™”!`,'#fb923c');
}

function showLevelUp(){ state='levelup'; document.getElementById('luscreen').style.display='flex'; document.getElementById('lvn').textContent=player.level; renderCards(buildUpgradePool(),false); updateRerollBtn(); }

function showEvoChoice(evos){
  state='levelup'; document.getElementById('luscreen').style.display='flex';
  const normal=buildUpgradePool().slice(0,2);
  const cards=[];
  for(let r of evos.slice(0,1)) cards.push({id:r.result,name:`${r.icon} ${r.name}`,icon:r.icon,evo:true,recipe:r,desc:`${WEAPON_DATA[r.weapon].name} MAX + ${ACC_DATA[r.acc].name} â†’ ì§„í™”!`});
  cards.push(...normal);
  renderCards(cards,true);
  updateRerollBtn();
}

function renderCards(pool,hasEvo){
  const titleEl=document.getElementById('lu-title');
  titleEl.textContent=hasEvo?'ì§„í™” ê°€ëŠ¥':'ë ˆë²¨ ì—…'; titleEl.className=hasEvo?'evo':'';
  const container=document.getElementById('cards'); container.innerHTML='';
  for(let up of pool){
    const d=document.createElement('div'); d.className='card'+(up.evo?' evo-card':'');
    d.innerHTML=`<div class="ci">${up.icon}</div><div class="cn">${up.name}</div><div class="cd">${up.desc||''}</div>${up.evo?'<div class="evo-badge">Evolution</div>':''}`;
    d.onclick=()=>{ if(up.evo) applyEvolution(up.recipe); else applyUpgrade(up); document.getElementById('luscreen').style.display='none'; state='playing'; };
    container.appendChild(d);
  }
}

let rerollUsed = false;

function updateRerollBtn(){
  const btn = document.getElementById('reroll-btn');
  const badge = document.getElementById('reroll-badge');
  if(!btn) return;
  if(rerollUsed){
    btn.disabled = true;
    btn.style.opacity = '0.35';
    btn.style.cursor = 'not-allowed';
    badge.textContent = 'ì‚¬ìš©ë¨';
    badge.style.background = 'rgba(100,100,100,0.5)';
  } else {
    btn.disabled = false;
    btn.style.opacity = '1';
    btn.style.cursor = 'pointer';
    badge.textContent = '1íšŒ';
    badge.style.background = 'rgba(124,92,252,0.6)';
  }
}

function rerollCards(){
  if(rerollUsed) return;
  rerollUsed = true;
  renderCards(buildUpgradePool(), false);
  updateRerollBtn();
}

function buildUpgradePool(){
  const pool=[];
  const all=[...UPGRADES].sort(()=>Math.random()-0.5);
  // ì§„í™” ë¬´ê¸° í¬í•¨ ì „ì²´ ë¬´ê¸° ìˆ˜
  const weaponCount=Object.keys(player.weapons).length;
  const accCount=Object.keys(player.accessories).filter(k=>!k.endsWith('_evolved')).length;
  const charDef = selectedChar ? CHARACTERS[selectedChar] : null;
  const bannedWeapons = charDef ? (charDef.bannedWeapons||[]) : [];
  // ì§„í™”ë¡œ ì´ë¯¸ ì‚¬ìš©ëœ ì›ë³¸ ë¬´ê¸° ëª©ë¡ (ê²°ê³¼ ë¬´ê¸°ê°€ í˜„ì¬ ìˆìœ¼ë©´ ì›ë³¸ì€ ì œì•ˆ ë¶ˆê°€)
  const evolvedOrigins = new Set(
    EVO_RECIPES.filter(r=>player.weapons[r.result]).map(r=>r.weapon)
  );
  const isHunterChar = selectedChar === 'hunter';
  if(isHunterChar){
    all.sort((a,b)=>{
      const batPrio = ['bat','slugger','homerun'];
      const aW = batPrio.includes(a.id) ? 0 : 1;
      const bW = batPrio.includes(b.id) ? 0 : 1;
      return aW - bW || Math.random() - 0.5;
    });
  }
  for(let up of all){
    if(pool.length>=3) break;
    if(up.weapon){
      const wd=WEAPON_DATA[up.id]; if(!wd||wd.evolved) continue;
      // ì§„í™”ë¡œ ì´ë¯¸ ì‚¬ìš©ëœ ì›ë³¸ì€ ì œì•ˆ ì•ˆ í•¨
      if(evolvedOrigins.has(up.id)) continue;
      if(bannedWeapons.includes(up.id) && !player.weapons[up.id]) continue;
      const wlv=player.weapons[up.id];
      if(wlv){ if(wlv<wd.maxLv) pool.push({...up,desc:wd.desc(wlv),name:up.name+` Lv.${wlv+1}`}); }
      else if(weaponCount<MAX_WEAPONS) pool.push({...up,desc:wd.desc(0)});
    } else if(up.accessory){
      if(!player.accessories[up.id]&&accCount<MAX_ABILITIES){ const ad=ACC_DATA[up.id]; pool.push({...up,desc:ad?ad.desc:'ë³´ì¡° ì•„ì´í…œ'}); }
    } else {
      const descs={maxhp:'ìµœëŒ€ HP +50',speed:'ì´ë™ ì†ë„ +15%',pickup:'ìˆ˜ì§‘ ë²”ìœ„ +30',heal:'HP 50 ì¦‰ì‹œ íšŒë³µ',dmgup:'ê³µê²©ë ¥ +15%',cdr:'ì¿¨íƒ€ì„ ê°ì†Œ -10%'};
      pool.push({...up,desc:descs[up.id]||''});
    }
  }
  while(pool.length<3) pool.push({id:'heal',name:'ì¦‰ì‹œ íšŒë³µ',icon:'ğŸ’‰',desc:'HP 50 ì¦‰ì‹œ íšŒë³µ'});
  return pool.slice(0,3);
}

function applyUpgrade(up){
  if(up.weapon){
    const weaponCount=Object.keys(player.weapons).length;
    const alreadyHas=!!player.weapons[up.id];
    if(!alreadyHas&&weaponCount>=MAX_WEAPONS){ showNotif('âš ï¸ ë¬´ê¸° ìŠ¬ë¡¯ì´ ê°€ë“ ì°¼ìŠµë‹ˆë‹¤ (ìµœëŒ€ 5ê°œ)','#ff6b63'); return; }
    if(!player.weapons[up.id]){ player.weapons[up.id]=1; player.weaponCooldowns[up.id]=0; }
    else player.weapons[up.id]++;
    updateSlots(); updateCooldownHUD();
  } else if(up.accessory){
    const accCount=Object.keys(player.accessories).length;
    if(!player.accessories[up.id]&&accCount>=MAX_ABILITIES){ showNotif('âš ï¸ ëŠ¥ë ¥ ìŠ¬ë¡¯ì´ ê°€ë“ ì°¼ìŠµë‹ˆë‹¤ (ìµœëŒ€ 5ê°œ)','#ff6b63'); return; }
    player.accessories[up.id]=1;
    const p=ACC_DATA[up.id]?.passive;
    if(p){
      if(p.cdr)    player.cdrMul=Math.max(0.2,player.cdrMul-p.cdr);
      if(p.dmg)    player.dmgMul+=p.dmg;
      if(p.hp)     { player.maxHp+=p.hp; player.hp=Math.min(player.hp+p.hp,player.maxHp); }
      if(p.spd)    player.spd*=(1+p.spd);
      if(p.pickup) player.pickupRange+=p.pickup;
    }
    updateSlots(); updateCooldownHUD();
  } else if(up.id==='maxhp'){ player.maxHp+=50; player.hp=Math.min(player.hp+50,player.maxHp); }
  else if(up.id==='speed')  player.spd*=1.15;
  else if(up.id==='pickup') player.pickupRange+=30;
  else if(up.id==='heal')   player.hp=Math.min(player.hp+50,player.maxHp);
  else if(up.id==='dmgup')  player.dmgMul+=0.15;
  else if(up.id==='cdr')    { player.cdrMul=Math.max(0.2,player.cdrMul-0.10); updateCooldownHUD(); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SLOT UI
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateSlots(){
  const container=document.getElementById('slots'); container.innerHTML='';
  const wCnt=Object.keys(player.weapons).length;
  const aCnt=Object.keys(player.accessories).filter(k=>!k.endsWith('_evolved')).length;
  const hdr=document.createElement('div');
  hdr.style.cssText='font-family:Rajdhani,sans-serif;font-size:8px;font-weight:700;color:rgba(136,153,187,0.5);letter-spacing:1px;text-align:right;padding:0 7px 2px;';
  hdr.textContent=`ë¬´ê¸° ${wCnt}/${MAX_WEAPONS}  ëŠ¥ë ¥ ${aCnt}/${MAX_ABILITIES}`;
  container.appendChild(hdr);
  for(let wid in player.weapons){
    const wd=WEAPON_DATA[wid]; if(!wd) continue;
    const lv=player.weapons[wid],maxed=wd.maxLv&&lv>=wd.maxLv,isEvolved=wd.evolved;
    const d=document.createElement('div');
    d.className='slot '+(isEvolved?'evolved':'wpn');
    d.innerHTML=`<span class="si">${wd.icon}</span><span class="sn ${isEvolved?'evo-name':''}">${wd.name}</span>${!isEvolved?`<span class="slv ${maxed?'maxed':''}">Lv.${lv}${maxed?' MAX':''}</span>`:'<span class="slv maxed">ì§„í™”</span>'}`;
    container.appendChild(d);
  }
  for(let aid in player.accessories){
    if(aid.endsWith('_evolved')) continue;
    const ad=ACC_DATA[aid]; if(!ad) continue;
    const isEvolved=!!player.accessories[aid+'_evolved'];
    const d=document.createElement('div'); d.className='slot itm';
    d.innerHTML=`<span class="si">${ad.icon}</span><span class="sn item-name">${ad.name}</span>${isEvolved?'<span class="slv maxed">ì§„í™”ë¨</span>':''}`;
    container.appendChild(d);
  }
  saveData.ownedEquip.forEach(eid=>{
    const eq=[...SHOP_ARMORS].find(e=>e.id===eid); if(!eq) return;
    const d=document.createElement('div'); d.className='slot armor-slot';
    d.innerHTML=`<span class="si">${eq.icon}</span><span class="sn armor-name">${eq.name}</span>`;
    container.appendChild(d);
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  GAME LOOP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function gameLoop(ts){
  if(state==='over'||state==='win'||state==='cleared'||state==='paused') return;
  animId=requestAnimationFrame(gameLoop);
  if(lastTime===0) lastTime=ts;
  const dt=Math.min((ts-lastTime)/1000,0.05);
  lastTime=ts;
  if(state==='playing') update(dt);
  else if(state==='dying'){
    gameTime+=dt;
    particles.forEach(p=>{ p.life-=dt; if(p.vx!==undefined){p.x+=p.vx*dt;p.y+=p.vy*dt;p.vx*=0.9;p.vy*=0.9;} });
    particles=particles.filter(p=>p.life>0);
    dmgNums.forEach(d=>{ d.life-=dt; d.y+=d.vy*dt; });
    dmgNums=dmgNums.filter(d=>d.life>0);
  }
  render();
}

function update(dt){
  gameTime+=dt;

  let dx=0,dy=0;
  if(keys['ArrowLeft']||keys['KeyA']) dx-=1;
  if(keys['ArrowRight']||keys['KeyD']) dx+=1;
  if(keys['ArrowUp']||keys['KeyW']) dy-=1;
  if(keys['ArrowDown']||keys['KeyS']) dy+=1;
  const joy=getJoystickInput(); dx+=joy.x; dy+=joy.y;
  const dl=Math.hypot(dx,dy)||1;
  if(Math.abs(dx)>0.05||Math.abs(dy)>0.05){
    player.x+=dx/dl*player.spd*dt; player.y+=dy/dl*player.spd*dt;
    if(dx>0.05) player.facing=1; else if(dx<-0.05) player.facing=-1;
    // í’€ ë°©í–¥ ê°ë„ ê¸°ë¡ (ë°©ë§ì´ ë“± ë°©í–¥ì„± ë¬´ê¸°ì— ì‚¬ìš©)
    player.aimAngle = Math.atan2(dy, dx);
  }
  cam.x=player.x; cam.y=player.y;

  if(player.invincible>0) player.invincible-=dt;

  if(!isBossPhase){
    spawnTimer-=dt;
    if(spawnTimer<=0){ spawnTimer=getSpawnRate(); const cnt=Math.floor(1+gameTime/90*(0.5+currentStage*0.3)); for(let i=0;i<cnt;i++) spawnEnemy(); }
  }

  floorItemSpawnTimer-=dt;
  if(floorItemSpawnTimer<=0){ floorItemSpawnTimer=15+Math.random()*10; spawnFloorItem(); }
  for(let i=floorItems.length-1;i>=0;i--){
    const fi=floorItems[i]; fi.life-=dt; fi.bob=(fi.bob||0)+dt;
    if(dist(player.x,player.y,fi.x,fi.y)<fi.r+18||fi.life<=0){ if(fi.life>0) applyFloorItem(fi); floorItems.splice(i,1); }
  }

  if(gameTime>=nextBossTime-10&&bossWarningTimer<=0&&!activeBoss){
    bossWarningTimer=10;
    const bossIdx=Math.min(Math.floor((nextBossTime-300)/300)+(currentStage-1),BOSS_TYPES.length-1);
    showBossWarning(BOSS_TYPES[bossIdx]);
  }
  if(bossWarningTimer>0){ bossWarningTimer-=dt; if(bossWarningTimer<=0&&gameTime>=nextBossTime) spawnBoss(); }
  if(activeBoss&&activeBoss.hp<=0){
    if(activeBoss.isFinalBoss){ activeBoss=null; stageClear(); return; }
    activeBoss=null;
  }
  updateBossAttacks(dt);

  for(let i=enemies.length-1;i>=0;i--){
    const e=enemies[i];
    const dx2=player.x-e.x,dy2=player.y-e.y,d=Math.hypot(dx2,dy2)||1;
    e.x+=dx2/d*e.spd*dt; e.y+=dy2/d*e.spd*dt;
    if(e.hitFlash>0) e.hitFlash-=dt;
    if(e.hp<=0){enemies.splice(i,1);continue;}
    if(d<e.type.size+16&&player.invincible<=0){
      player.hp-=e.dmg*dt; player.invincible=0.1;
      if(player.hp<=0){
        player.hp=0; SFX.playerDie();
        dmgNums.push({x:player.x,y:player.y-10,val:'ì‚¬ë§!',life:1.5,vy:-80,color:'#FF2020',big:true});
        setTimeout(()=>gameOver(),600); state='dying'; return;
      } else { SFX.playerHit(); }
    }
  }

  fireWeapons(dt);
  updateOrbBurst(dt);
  updateBoomerangs(dt);

  for(let i=projectiles.length-1;i>=0;i--){
    const p=projectiles[i];
    p.x+=p.vx*dt; p.y+=p.vy*dt; p.life-=dt;
    if(p.gravity) p.vy+=p.gravity*dt;
    if(p.rot!==undefined) p.rot+=5*dt;
    if(p.life<=0){projectiles.splice(i,1);continue;}
    let removed=false;
    for(let j=enemies.length-1;j>=0;j--){
      const e=enemies[j];
      if(p.hitSet&&p.hitSet.has(e)) continue;
      if(dist(p.x,p.y,e.x,e.y)<p.r+e.type.size){
        if(p.hitSet) p.hitSet.add(e);
        if(p.onHit) p.onHit(e);
        hitEnemy(e,p.dmg); p.pierce--;
        if(p.pierce<=0){projectiles.splice(i,1);removed=true;break;}
        if(e.hp<=0) enemies.splice(j,1);
      }
    }
    if(!removed&&dist(p.x,p.y,player.x,player.y)>750) projectiles.splice(i,1);
  }

  for(let i=xpGems.length-1;i>=0;i--){
    const g=xpGems[i]; g.life-=dt;
    const d=dist(player.x,player.y,g.x,g.y);
    if(d<player.pickupRange){ const spd=200+d*2,dx3=player.x-g.x,dy3=player.y-g.y,dl2=Math.hypot(dx3,dy3)||1; g.x+=dx3/dl2*spd*dt; g.y+=dy3/dl2*spd*dt; }
    if(dist(player.x,player.y,g.x,g.y)<18||g.life<=0){ if(g.life>0){ gainXP(g.val); SFX.xpPickup(); } xpGems.splice(i,1); }
  }

  for(let i=particles.length-1;i>=0;i--){ const p=particles[i]; p.life-=dt; if(p.vx!==undefined){p.x+=p.vx*dt;p.y+=p.vy*dt;p.vx*=0.9;p.vy*=0.9;} if(p.life<=0) particles.splice(i,1); }
  for(let i=dmgNums.length-1;i>=0;i--){ const d=dmgNums[i]; d.life-=dt; d.y+=d.vy*dt; if(d.life<=0) dmgNums.splice(i,1); }

  const remaining=900-gameTime;
  // 15ë¶„(900ì´ˆ): ë³´ìŠ¤ê°€ ì—†ìœ¼ë©´ ìµœì¢… ë³´ìŠ¤ ì†Œí™˜, ìˆìœ¼ë©´ ì²˜ì¹˜ ëŒ€ê¸°
  if(remaining<=0){
    if(!activeBoss){
      // ìµœì¢… ë³´ìŠ¤ê°€ ì•„ì§ ì•ˆ ë‚˜ì™”ìœ¼ë©´ ê°•ì œ ìŠ¤í°
      if(!finalBossSpawned){
        finalBossSpawned=true;
        spawnFinalBoss();
      } else {
        // ìµœì¢… ë³´ìŠ¤ë„ ì²˜ì¹˜ ì™„ë£Œ â†’ í´ë¦¬ì–´
        stageClear(); return;
      }
    }
    // ìµœì¢… ë³´ìŠ¤ ì²˜ì¹˜ íŒì •
    if(finalBossSpawned && activeBoss && activeBoss.hp<=0){
      stageClear(); return;
    }
  }
  const rm=Math.max(0,Math.floor(remaining/60)),rs=Math.max(0,Math.floor(remaining%60));
  document.getElementById('timer').textContent=remaining>0?(String(rm).padStart(2,'0')+':'+String(rs).padStart(2,'0')):'FINAL';
  document.getElementById('timer').style.color=remaining<=0?'#ff0044':remaining<60?'#ff6b63':remaining<180?'#fad86a':'var(--c-text)';

  document.getElementById('hp').style.width=(player.hp/player.maxHp*100)+'%';
  document.getElementById('xp').style.width=(player.xp/player.xpNext*100)+'%';
  document.getElementById('kills').innerHTML='KILL <span>'+kills+'</span>';
  if(isBossPhase){ document.getElementById('stage-hud').innerHTML=`<span style="color:#ff6b63">âš” BOSS âš”</span>`; }
  else { document.getElementById('stage-hud').innerHTML=`STAGE <span>${currentStage}</span>`; }
  document.getElementById('coin-hud').textContent='ğŸª™ '+saveData.coins;

  refreshCooldownBars();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RENDER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function render(){
  ctx.clearRect(0,0,W,H);
  const stg=STAGES[currentStage-1]||STAGES[0], theme=BG_THEMES[stg.bg]||BG_THEMES.forest;
  ctx.save();
  const S=72,wx=W/2-cam.x,wy=H/2-cam.y;
  const stx=Math.floor(-wx/S)-1,sty=Math.floor(-wy/S)-1,etx=Math.ceil((W-wx)/S)+1,ety=Math.ceil((H-wy)/S)+1;
  ctx.fillStyle=theme.base; ctx.fillRect(0,0,W,H);
  for(let tx2=stx;tx2<=etx;tx2++) for(let ty2=sty;ty2<=ety;ty2++){ const sx=wx+tx2*S,sy=wy+ty2*S,px=((tx2%2)+2)%2,py=((ty2%2)+2)%2; if((px+py)%2===0){ctx.fillStyle=theme.grid2;ctx.fillRect(sx,sy,S,S);} }
  ctx.strokeStyle=theme.grid1; ctx.lineWidth=1;
  for(let tx2=stx;tx2<=etx;tx2++){const sx=wx+tx2*S;ctx.beginPath();ctx.moveTo(sx,0);ctx.lineTo(sx,H);ctx.stroke();}
  for(let ty2=sty;ty2<=ety;ty2++){const sy=wy+ty2*S;ctx.beginPath();ctx.moveTo(0,sy);ctx.lineTo(W,sy);ctx.stroke();}
  const vg=ctx.createRadialGradient(W/2,H/2,60,W/2,H/2,460);
  vg.addColorStop(0,theme.vignette[0]); vg.addColorStop(1,theme.vignette[1]);
  ctx.fillStyle=vg; ctx.fillRect(0,0,W,H);
  ctx.restore();

  const tx=W/2-cam.x, ty2=H/2-cam.y;
  ctx.save(); ctx.translate(tx,ty2);

  for(let wid of['aura','storm']){
    if(!player.weapons[wid]) continue;
    const lv=player.weapons[wid]-1,range=wid==='storm'?180:80+lv*20,color=wid==='storm'?'80,200,255':'160,100,255';
    ctx.beginPath();ctx.arc(player.x,player.y,range,0,Math.PI*2);ctx.strokeStyle=`rgba(${color},0.35)`;ctx.lineWidth=1.5;ctx.stroke();ctx.fillStyle=`rgba(${color},0.04)`;ctx.fill();
  }

  for(let wid of['blade','phantom']){
    if(!player.weapons[wid]) continue;
    const isPhantom=wid==='phantom',cnt=isPhantom?4:2+(player.weapons[wid]-1)+(player._bladeExtra||0);
    const radius=isPhantom?80:60,color=isPhantom?'rgba(180,180,255,0.8)':'rgba(200,200,60,0.9)';
    for(let i=0;i<cnt;i++){
      const a=gameTime*(isPhantom?3:2.5)+i*(Math.PI*2/cnt),bx=player.x+Math.cos(a)*radius,by=player.y+Math.sin(a)*radius;
      ctx.save();ctx.translate(bx,by);ctx.rotate(a);ctx.shadowColor=color;ctx.shadowBlur=10;ctx.fillStyle=color;
      if(isPhantom){ctx.beginPath();ctx.arc(0,-6,5,Math.PI,0);ctx.lineTo(5,4);ctx.quadraticCurveTo(0,8,-5,4);ctx.closePath();ctx.fill();}
      else{ctx.fillRect(-10,-3,20,6);ctx.fillRect(-12,-5,4,10);}
      ctx.restore();
    }
  }

  for(let p of particles){
    const alpha=p.life/p.maxLife;
    if(p.type==='dot'){ctx.globalAlpha=alpha;ctx.fillStyle=p.color;ctx.beginPath();ctx.arc(p.x,p.y,p.r,0,Math.PI*2);ctx.fill();}
    else if(p.type==='ring'){ctx.globalAlpha=alpha*0.6;ctx.strokeStyle=p.color;ctx.lineWidth=3;ctx.beginPath();ctx.arc(p.x,p.y,p.r,0,Math.PI*2);ctx.stroke();}
    else if(p.type==='nova'){const r=p.maxR*(1-p.life/p.maxLife);ctx.globalAlpha=alpha*0.5;ctx.fillStyle=p.color;ctx.beginPath();ctx.arc(p.x,p.y,r,0,Math.PI*2);ctx.fill();ctx.globalAlpha=alpha;ctx.strokeStyle=p.color;ctx.lineWidth=3;ctx.beginPath();ctx.arc(p.x,p.y,r,0,Math.PI*2);ctx.stroke();}
    else if(p.type==='arc'){ctx.save();ctx.globalAlpha=alpha*0.85;ctx.strokeStyle=p.color+'0.9)';ctx.lineWidth=5+alpha*4;ctx.lineCap='round';ctx.shadowColor=p.color+'0.8)';ctx.shadowBlur=12;ctx.beginPath();ctx.arc(p.x,p.y,p.range*(1.05-alpha*0.15),p.angle-p.arcHalf,p.angle+p.arcHalf);ctx.stroke();ctx.restore();}
    else if(p.type==='lightning'){const topY=p.y-340;ctx.save();ctx.globalAlpha=alpha*0.9;ctx.strokeStyle='#ffffff';ctx.lineWidth=3;ctx.shadowColor='#88eeff';ctx.shadowBlur=18;ctx.beginPath();ctx.moveTo(p.x,topY);for(let s=1;s<=7;s++){const sy2=topY+(p.y-topY)*(s/7),jitter=s<7?Math.sin(s*73.1+p.life*40)*18:0;ctx.lineTo(p.x+jitter,sy2);}ctx.stroke();ctx.restore();}
    ctx.globalAlpha=1;
  }

  for(let g of xpGems){
    const pulse=0.8+0.2*Math.sin(gameTime*8+g.x);
    ctx.save();ctx.translate(g.x,g.y);ctx.shadowColor='#A855F7';ctx.shadowBlur=8;ctx.fillStyle='#A855F7';
    ctx.beginPath();ctx.moveTo(0,-g.r*pulse);ctx.lineTo(g.r*0.6*pulse,g.r*0.6*pulse);ctx.lineTo(-g.r*0.6*pulse,g.r*0.6*pulse);ctx.closePath();ctx.fill();ctx.restore();
  }

  for(let fi of floorItems){
    const t=FLOOR_ITEM_TYPES[fi.kind],bob=Math.sin(fi.bob*3)*4,alpha=fi.life<3?(fi.life/3):1,pulse=0.85+0.15*Math.sin(fi.bob*5);
    ctx.save();ctx.translate(fi.x,fi.y+bob);ctx.globalAlpha=alpha;ctx.shadowColor=t.color;ctx.shadowBlur=18;ctx.fillStyle=t.color+'44';
    ctx.beginPath();ctx.arc(0,0,fi.r*1.6*pulse,0,Math.PI*2);ctx.fill();ctx.strokeStyle=t.color+'99';ctx.lineWidth=1.5;ctx.beginPath();ctx.arc(0,0,fi.r*1.6*pulse,0,Math.PI*2);ctx.stroke();
    ctx.font=`${Math.round(fi.r*2.2)}px serif`;ctx.textAlign='center';ctx.textBaseline='middle';ctx.shadowBlur=8;ctx.fillStyle='#fff';ctx.fillText(t.icon,0,0);
    ctx.font='700 8px Rajdhani,sans-serif';ctx.fillStyle=t.color;ctx.shadowBlur=0;ctx.fillText(t.label,0,fi.r*2.2);ctx.restore();
  }

  // â˜… ë¶€ë©”ë‘ ë Œë”ë§
  for(let b of boomerangs){
    ctx.save();ctx.translate(b.x,b.y);ctx.rotate(b.rot);
    ctx.shadowColor=b.glowColor; ctx.shadowBlur=18;
    ctx.fillStyle=b.color;
    if(b.isGolden){
      ctx.fillStyle='#FFD700';
      ctx.fillRect(-b.r,-b.r*0.3,b.r*2,b.r*0.6);
      ctx.fillRect(-b.r*0.3,-b.r,b.r*0.6,b.r*2);
      ctx.fillStyle='rgba(255,255,200,0.6)';
      ctx.beginPath();ctx.arc(0,0,b.r*0.4,0,Math.PI*2);ctx.fill();
    } else {
      ctx.save();ctx.rotate(Math.PI/4);
      ctx.fillStyle=b.color;
      ctx.fillRect(-b.r*0.8,-b.r*0.25,b.r*1.6,b.r*0.5);
      ctx.fillStyle='#e8d890';
      ctx.beginPath();ctx.moveTo(b.r*0.8,-b.r*0.25);ctx.lineTo(b.r*1.2,0);ctx.lineTo(b.r*0.8,b.r*0.25);ctx.closePath();ctx.fill();
      ctx.restore();
      if(b.returning){
        ctx.globalAlpha=0.5;
        ctx.fillStyle='rgba(255,220,100,0.6)';
        ctx.beginPath();ctx.arc(0,0,b.r*1.5,0,Math.PI*2);ctx.fill();
      }
    }
    ctx.globalAlpha=1;ctx.restore();
  }

  for(let e of enemies){
    ctx.save();ctx.translate(e.x,e.y);
    const flash=e.hitFlash>0;
    if(e.isBoss){
      const pulse=0.7+0.3*Math.sin(gameTime*4);
      ctx.globalAlpha=0.18*pulse;ctx.fillStyle=e.type.color;ctx.shadowColor=e.type.color;ctx.shadowBlur=40;
      ctx.beginPath();ctx.arc(0,0,e.type.size*1.6,0,Math.PI*2);ctx.fill();
      ctx.globalAlpha=flash?1:(e.type.alpha||1);ctx.shadowBlur=flash?30:20;
    } else { ctx.fillStyle=flash?'#FFFFFF':e.type.color; if(e.type.alpha) ctx.globalAlpha=e.type.alpha; ctx.shadowColor=e.type.color;ctx.shadowBlur=flash?14:6; }
    ctx.fillStyle=flash?'#FFFFFF':e.type.color;
    if(e.type.shape==='circle'){ ctx.beginPath();ctx.arc(0,0,e.type.size,0,Math.PI*2);ctx.fill(); if(!e.isBoss){ctx.fillStyle='#FF2200';ctx.shadowBlur=4;ctx.beginPath();ctx.arc(-4,-3,2.5,0,Math.PI*2);ctx.fill();ctx.beginPath();ctx.arc(4,-3,2.5,0,Math.PI*2);ctx.fill();} }
    else if(e.type.shape==='tri'){ ctx.beginPath();ctx.moveTo(0,-e.type.size);ctx.lineTo(e.type.size*0.8,e.type.size*0.6);ctx.lineTo(-e.type.size*0.8,e.type.size*0.6);ctx.closePath();ctx.fill(); }
    else { ctx.beginPath(); for(let a=0;a<Math.PI*2;a+=0.2){const r2=e.type.size*(0.8+0.2*Math.sin(a*3+gameTime*2));a<0.2?ctx.moveTo(Math.cos(a)*r2,Math.sin(a)*r2):ctx.lineTo(Math.cos(a)*r2,Math.sin(a)*r2);} ctx.closePath();ctx.fill(); }
    if(e.isBoss){ ctx.globalAlpha=0.9;ctx.shadowBlur=0;ctx.font=`${Math.round(e.type.size*0.9)}px serif`;ctx.textAlign='center';ctx.textBaseline='middle';ctx.fillText(e.type.icon,0,0); }
    if(e.hp<e.maxHp){
      const bw=e.isBoss?e.type.size*3.2:e.type.size*2.6,bh=e.isBoss?5:2.5,bx2=-bw/2,by2=-e.type.size-(e.isBoss?14:7);
      ctx.globalAlpha=0.9;ctx.fillStyle='rgba(255,255,255,0.08)';ctx.fillRect(bx2,by2,bw,bh);
      ctx.fillStyle=e.isBoss?'#ff4444':'#e8453c';if(e.isBoss){ctx.shadowColor='#ff0000';ctx.shadowBlur=8;}
      ctx.fillRect(bx2,by2,bw*(e.hp/e.maxHp),bh);ctx.shadowBlur=0;
      if(e.isBoss){ctx.globalAlpha=0.75;ctx.font='700 9px Rajdhani,sans-serif';ctx.fillStyle='#ffaaaa';ctx.textAlign='center';ctx.fillText(e.type.name,0,by2-5);}
    }
    ctx.globalAlpha=1;ctx.restore();
  }

  for(let p of bossProjectiles){
    ctx.save();ctx.translate(p.x,p.y);ctx.shadowColor=p.glow;ctx.shadowBlur=16;ctx.fillStyle=p.color;
    if(p.type==='boss_void'){
      const pulse=0.8+0.2*Math.sin(gameTime*8+p.x);ctx.globalAlpha=0.85;ctx.beginPath();ctx.arc(0,0,p.r*pulse,0,Math.PI*2);ctx.fill();ctx.fillStyle='rgba(180,0,255,0.4)';ctx.beginPath();ctx.arc(0,0,p.r*1.6*pulse,0,Math.PI*2);ctx.fill();
    } else if(p.type==='boss_spread'){
      ctx.globalAlpha=0.9;ctx.beginPath();ctx.arc(0,0,p.r,0,Math.PI*2);ctx.fill();ctx.fillStyle='rgba(255,200,50,0.7)';ctx.beginPath();ctx.arc(-1,-1,p.r*0.5,0,Math.PI*2);ctx.fill();
    } else if(p.type==='boss_burst'){
      ctx.globalAlpha=0.9;ctx.beginPath();ctx.arc(0,0,p.r,0,Math.PI*2);ctx.fill();ctx.strokeStyle='rgba(255,100,100,0.8)';ctx.lineWidth=2;ctx.beginPath();ctx.arc(0,0,p.r*1.4,0,Math.PI*2);ctx.stroke();
    } else {
      ctx.globalAlpha=0.9;ctx.beginPath();ctx.arc(0,0,p.r,0,Math.PI*2);ctx.fill();ctx.fillStyle='rgba(255,255,255,0.5)';ctx.beginPath();ctx.arc(-2,-2,p.r*0.35,0,Math.PI*2);ctx.fill();
    }
    ctx.globalAlpha=1;ctx.restore();
  }

  for(let p of projectiles){
    ctx.save();ctx.translate(p.x,p.y);if(p.rot!==undefined) ctx.rotate(p.rot);
    ctx.shadowColor=p.glow;ctx.shadowBlur=12;ctx.fillStyle=p.color;
    if(p.type==='orb'){ctx.beginPath();ctx.arc(0,0,p.r,0,Math.PI*2);ctx.fill();ctx.fillStyle='rgba(255,255,255,0.5)';ctx.beginPath();ctx.arc(-2,-2,p.r*0.35,0,Math.PI*2);ctx.fill();}
    else if(p.type==='axe'){ctx.beginPath();ctx.moveTo(-p.r,-p.r*0.5);ctx.lineTo(p.r,0);ctx.lineTo(-p.r,p.r*0.5);ctx.closePath();ctx.fill();}
    else if(p.type==='cross'){ctx.fillRect(-p.r,-p.r*0.3,p.r*2,p.r*0.6);ctx.fillRect(-p.r*0.3,-p.r,p.r*0.6,p.r*2);}
    else if(p.type==='bolt'){ctx.shadowBlur=18;ctx.beginPath();ctx.moveTo(-p.r*2,-p.r);ctx.lineTo(0,p.r);ctx.lineTo(p.r*2,-p.r);ctx.closePath();ctx.fill();}
    else if(p.type==='meteor'){ctx.shadowBlur=20;ctx.beginPath();ctx.arc(0,0,p.r,0,Math.PI*2);ctx.fill();ctx.fillStyle='rgba(255,200,100,0.7)';ctx.beginPath();ctx.arc(-2,-3,p.r*0.5,0,Math.PI*2);ctx.fill();}
    ctx.restore();
  }

  ctx.save();ctx.translate(player.x,player.y);
  if(player.invincible>0) ctx.globalAlpha=0.5+0.5*Math.sin(gameTime*20);

  // â”€â”€ ë°©í–¥ í™”ì‚´í‘œ (íƒ€ìì¼ ë•Œë§Œ, scale ì ìš© ì „ ì›”ë“œ ì¢Œí‘œì—ì„œ ê·¸ë¦¼)
  if(player.isHunter || player.isGunner){
    const ang = player.aimAngle || 0;
    const arrowDist = 30;
    ctx.save();
    ctx.globalAlpha = (player.invincible>0?(0.5+0.5*Math.sin(gameTime*20)):1)*0.82;
    ctx.rotate(ang);
    // í™”ì‚´í‘œ ì„ 
    ctx.strokeStyle='#fb923c'; ctx.lineWidth=2.5; ctx.lineCap='round';
    ctx.shadowColor='#fb923c'; ctx.shadowBlur=10;
    ctx.beginPath(); ctx.moveTo(18, 0); ctx.lineTo(arrowDist, 0); ctx.stroke();
    // í™”ì‚´í‘œ ë¨¸ë¦¬
    ctx.beginPath();
    ctx.moveTo(arrowDist+7, 0);
    ctx.lineTo(arrowDist+1, -4);
    ctx.lineTo(arrowDist+1, 4);
    ctx.closePath();
    ctx.fillStyle='#fb923c'; ctx.fill();
    ctx.restore();
  }

  ctx.scale(player.facing,1);
  ctx.globalAlpha*=0.25;ctx.fillStyle='#000';ctx.beginPath();ctx.ellipse(0,16,11,5,0,0,Math.PI*2);ctx.fill();
  ctx.globalAlpha=player.invincible>0?(0.5+0.5*Math.sin(gameTime*20)):1;

  if(player.isMiner){
    ctx.shadowColor='rgba(200,160,96,0.6)';ctx.shadowBlur=14;ctx.fillStyle='#7a5030';
    ctx.beginPath();ctx.ellipse(0,3,12,16,0,0,Math.PI*2);ctx.fill();
    ctx.fillStyle='#5a3818';ctx.fillRect(-11,-2,22,4);
    ctx.shadowBlur=0;ctx.fillStyle='#e8cdb0';ctx.beginPath();ctx.ellipse(0,-6,6,7,0,0,Math.PI*2);ctx.fill();
    ctx.fillStyle='#f0c040';ctx.shadowColor='#f0c040';ctx.shadowBlur=8;
    ctx.beginPath();ctx.arc(0,-9,7,Math.PI,0);ctx.fill();
    ctx.fillRect(-7,-9,14,3);
    ctx.fillStyle='#d4a830';ctx.fillRect(-7,-10,14,2);
    ctx.shadowBlur=0;ctx.fillStyle='#444';
    ctx.beginPath();ctx.arc(-2.5,-6,2.2,0,Math.PI*2);ctx.fill();
    ctx.beginPath();ctx.arc(2.5,-6,2.2,0,Math.PI*2);ctx.fill();
    ctx.fillStyle='rgba(200,240,255,0.7)';ctx.beginPath();ctx.arc(-1.5,-6.5,0.8,0,Math.PI*2);ctx.fill();
    ctx.beginPath();ctx.arc(3.5,-6.5,0.8,0,Math.PI*2);ctx.fill();
    ctx.strokeStyle='#888';ctx.lineWidth=1;
    ctx.beginPath();ctx.arc(-2.5,-6,2.5,0,Math.PI*2);ctx.stroke();
    ctx.beginPath();ctx.arc(2.5,-6,2.5,0,Math.PI*2);ctx.stroke();
  } else if(player.isHunter){
    // íƒ€ì: ì•¼êµ¬ ìœ ë‹ˆí¼, í—¬ë©§, ë°©ë§ì´
    const t = gameTime;
    // ìœ ë‹ˆí¼ ëª¸í†µ (í°ìƒ‰ + ì£¼í™© ì¤„ë¬´ëŠ¬)
    ctx.shadowColor='rgba(251,146,60,0.7)';ctx.shadowBlur=14;
    ctx.fillStyle='#f0ede0';
    ctx.beginPath();ctx.ellipse(0,3,13,17,0,0,Math.PI*2);ctx.fill();
    // ì„¸ë¡œ ì¤„ë¬´ëŠ¬
    ctx.fillStyle='#fb923c';
    ctx.fillRect(-2,-14,3,28);
    ctx.fillRect(-8,-12,2,22);
    ctx.fillRect(6,-12,2,22);
    // ìœ ë‹ˆí¼ ë²ˆí˜¸
    ctx.font='700 7px Rajdhani,sans-serif';ctx.fillStyle='#fb923c';ctx.textAlign='center';ctx.fillText('7',0,8);
    // ë²¨íŠ¸
    ctx.fillStyle='#3a2010';ctx.fillRect(-11,6,22,3);
    ctx.fillStyle='#c8a030';ctx.fillRect(-3,5.5,6,4);
    // ì–¼êµ´
    ctx.shadowBlur=0;ctx.fillStyle='#d4a882';ctx.beginPath();ctx.ellipse(0,-6,6,7,0,0,Math.PI*2);ctx.fill();
    // ì•¼êµ¬ í—¬ë©§ (ì£¼í™©+ê²€ì •)
    ctx.shadowColor='#fb923c';ctx.shadowBlur=8;
    ctx.fillStyle='#1a0a00';
    // í—¬ë©§ ë©”ì¸
    ctx.beginPath();ctx.arc(0,-10,9,Math.PI,0);ctx.fill();
    ctx.fillRect(-9,-10,18,5);
    // í—¬ë©§ ì±™ (ì™¼ìª½ìœ¼ë¡œ)
    ctx.fillStyle='#2a1200';
    ctx.beginPath();ctx.moveTo(-9,-8);ctx.lineTo(-16,-7);ctx.lineTo(-13,-4);ctx.lineTo(-9,-5);ctx.closePath();ctx.fill();
    // í—¬ë©§ ì¤„ë¬´ëŠ¬
    ctx.fillStyle='#fb923c';ctx.fillRect(-2,-18,3,9);
    // ëˆˆ (ê²°ì˜ì— ì°¬ ëˆˆ)
    ctx.shadowBlur=0;ctx.fillStyle='#1a1a1a';
    ctx.beginPath();ctx.arc(-2.5,-5.5,2,0,Math.PI*2);ctx.fill();
    ctx.beginPath();ctx.arc(2.5,-5.5,2,0,Math.PI*2);ctx.fill();
    ctx.fillStyle='#fb923c';
    ctx.beginPath();ctx.arc(-2,-5,0.8,0,Math.PI*2);ctx.fill();
    ctx.beginPath();ctx.arc(3,-5,0.8,0,Math.PI*2);ctx.fill();
    // ì•¼êµ¬ë°©ë§ì´ (aimAngle ë°©í–¥, scale ë³´ì • í›„)
    {
      const t2 = gameTime;
      // facing ë³´ì •: scale(facing,1) ë‚´ë¶€ì´ë¯€ë¡œ facing*aimAngle
      const batAng = player.aimAngle * player.facing;
      // ìŠ¤ìœ™ ì‹œ ì•½ê°„ì˜ ì§„ë™
      const swing = Math.sin(t2 * 5) * 0.15;
      ctx.save();
      ctx.rotate(batAng + swing - Math.PI/2);  // ë°©ë§ì´ê°€ ë°©í–¥ìª½ ì •ë©´ìœ¼ë¡œ
      ctx.translate(0, -14);  // í”Œë ˆì´ì–´ ì¤‘ì‹¬ì—ì„œ ì•ìª½
      // ë°©ë§ì´ ì†ì¡ì´
      ctx.strokeStyle='#8B5E3C';ctx.lineWidth=3;ctx.lineCap='round';
      ctx.beginPath();ctx.moveTo(0,8);ctx.lineTo(0,-14);ctx.stroke();
      // ë°©ë§ì´ ë°°ëŸ´
      ctx.strokeStyle='#C8922A';ctx.lineWidth=6;ctx.shadowColor='#e8b040';ctx.shadowBlur=6;
      ctx.beginPath();ctx.moveTo(0,-6);ctx.lineTo(0,-14);ctx.stroke();
      // ë°©ë§ì´ ë ìº¡
      ctx.fillStyle='#e8b040';ctx.beginPath();ctx.arc(0,-14,4,0,Math.PI*2);ctx.fill();
      // ì†ì¡ì´ ê·¸ë¦½
      ctx.fillStyle='rgba(0,0,0,0.4)';ctx.fillRect(-1.5,6,3,5);
      // ìŠ¤ìœ™ ì”ìƒ
      if(Math.abs(Math.sin(t2*5))>0.85){
        ctx.strokeStyle='rgba(251,146,60,0.45)';ctx.lineWidth=2;ctx.setLineDash([3,3]);ctx.shadowBlur=0;
        ctx.beginPath();ctx.moveTo(4,8);ctx.lineTo(4,-12);ctx.stroke();
        ctx.setLineDash([]);
      }
      ctx.restore();
    }
  } else if(player.isGunner){
    // ìƒ·ê±´ë§¨: êµ°ë³µ + í—¬ë©§ + ìƒ·ê±´
    const t = gameTime;
    // êµ°ë³µ ëª¸í†µ (ì˜¬ë¦¬ë¸Œ ê·¸ë¦°)
    ctx.shadowColor='rgba(180,190,180,0.5)';ctx.shadowBlur=10;
    ctx.fillStyle='#3a4a2a';
    ctx.beginPath();ctx.ellipse(0,3,13,17,0,0,Math.PI*2);ctx.fill();
    // ë°©íƒ„ì¡°ë¼
    ctx.fillStyle='#2a3520';
    ctx.beginPath();ctx.moveTo(-10,0);ctx.lineTo(-10,14);ctx.lineTo(10,14);ctx.lineTo(10,0);ctx.lineTo(5,-6);ctx.lineTo(-5,-6);ctx.closePath();ctx.fill();
    // ì¡°ë¼ í¬ì¼“
    ctx.fillStyle='#222a18';ctx.fillRect(-9,2,7,5);ctx.fillRect(2,2,7,5);
    // ë²¨íŠ¸
    ctx.fillStyle='#4a3a20';ctx.fillRect(-11,12,22,3);
    ctx.fillStyle='#c8a030';ctx.fillRect(-3,11.5,6,4);
    // ì–¼êµ´
    ctx.shadowBlur=0;ctx.fillStyle='#c8a070';ctx.beginPath();ctx.ellipse(0,-6,6,7,0,0,Math.PI*2);ctx.fill();
    // êµ°ìš© í—¬ë©§
    ctx.fillStyle='#2e3b22';ctx.shadowColor='#aab8aa';ctx.shadowBlur=4;
    ctx.beginPath();ctx.arc(0,-10,9,Math.PI,0);ctx.fill();
    ctx.fillRect(-9,-10,18,4);
    // í—¬ë©§ ì±™
    ctx.fillStyle='#252f1a';
    ctx.beginPath();ctx.moveTo(-9,-8);ctx.lineTo(-12,-6);ctx.lineTo(12,-6);ctx.lineTo(9,-8);ctx.closePath();ctx.fill();
    // í—¬ë©§ ìŠ¤íŠ¸ë©
    ctx.strokeStyle='#8a7050';ctx.lineWidth=1.5;
    ctx.beginPath();ctx.moveTo(-6,-5);ctx.lineTo(-4,-1);ctx.stroke();
    ctx.beginPath();ctx.moveTo(6,-5);ctx.lineTo(4,-1);ctx.stroke();
    // ëˆˆ
    ctx.shadowBlur=0;ctx.fillStyle='#111';
    ctx.beginPath();ctx.arc(-2.5,-5.5,2,0,Math.PI*2);ctx.fill();
    ctx.beginPath();ctx.arc(2.5,-5.5,2,0,Math.PI*2);ctx.fill();
    ctx.fillStyle='#d1d5db';
    ctx.beginPath();ctx.arc(-2,-5,0.8,0,Math.PI*2);ctx.fill();
    ctx.beginPath();ctx.arc(3,-5,0.8,0,Math.PI*2);ctx.fill();
    // ìƒ·ê±´ (ì•ìª½ìœ¼ë¡œ ê²¨ëˆ”, ì´êµ¬ ë°©í–¥ ì• ë‹ˆ)
    {
      const shootAng = player.aimAngle * player.facing;
      ctx.save();
      ctx.rotate(shootAng);
      // ì´ ëª¸ì²´
      ctx.fillStyle='#1a1a1a';ctx.shadowColor='#888';ctx.shadowBlur=4;
      ctx.fillRect(8,-3,24,5);
      // ì´ì—´ (ìœ„)
      ctx.fillStyle='#2a2a2a';ctx.fillRect(8,-5,22,3);
      // ì´êµ¬
      ctx.fillStyle='#333';ctx.fillRect(30,-4,4,7);
      // ê°œë¨¸ë¦¬íŒ
      ctx.fillStyle='#5a3a1a';ctx.fillRect(4,-2,6,4);
      // ì´êµ¬ í™”ì—¼ (ë°œì‚¬ ì§í›„ ê¹œë¹¡ì„)
      if(Math.sin(t*18)>0.6 && (player.weapons['shotgun']||player.weapons['minigun'])){
        ctx.fillStyle='rgba(255,200,50,0.85)';ctx.shadowColor='#ff8800';ctx.shadowBlur=14;
        ctx.beginPath();ctx.ellipse(35,0,7,4,0,0,Math.PI*2);ctx.fill();
      }
      ctx.restore();
    }
  } else {
    ctx.shadowColor='rgba(124,92,252,0.7)';ctx.shadowBlur=16;ctx.fillStyle='#1a0d3a';
    ctx.beginPath();ctx.ellipse(0,3,13,17,0,0,Math.PI*2);ctx.fill();
    ctx.fillStyle='rgba(124,92,252,0.18)';ctx.beginPath();ctx.ellipse(-3,0,7,11,0.2,0,Math.PI*2);ctx.fill();
    ctx.shadowBlur=0;ctx.fillStyle='#e8cdb0';ctx.beginPath();ctx.ellipse(0,-6,6,7,0,0,Math.PI*2);ctx.fill();
    ctx.fillStyle='#e8453c';ctx.shadowColor='#e8453c';ctx.shadowBlur=8;
    ctx.beginPath();ctx.arc(-2.5,-6.5,1.8,0,Math.PI*2);ctx.fill();
    ctx.beginPath();ctx.arc(2.5,-6.5,1.8,0,Math.PI*2);ctx.fill();
  }
  ctx.restore();

  for(let d of dmgNums){
    const alpha=Math.min(1,d.life/0.8);
    ctx.save();ctx.globalAlpha=alpha;
    if(d.big){ const t2=1-d.life/1.5;ctx.font=`700 ${Math.round(38+t2*6)}px 'Rajdhani',sans-serif`;ctx.fillStyle='#e8453c';ctx.strokeStyle='rgba(0,0,0,0.7)';ctx.lineWidth=3;ctx.textAlign='center';ctx.shadowColor='#e8453c';ctx.shadowBlur=24;ctx.strokeText(d.val,d.x,d.y);ctx.fillText(d.val,d.x,d.y); }
    else { ctx.font=`600 ${12+Math.round((1-alpha)*3)}px 'Rajdhani',sans-serif`;ctx.fillStyle=d.color||'#f0c040';ctx.shadowColor=d.color||'#f0c040';ctx.shadowBlur=4;ctx.textAlign='center';ctx.fillText(d.val,d.x,d.y); }
    ctx.restore();
  }
  ctx.restore();

  if(isBossPhase){
    const pulse=0.4+0.3*Math.sin(gameTime*3);
    ctx.save();ctx.strokeStyle=`rgba(232,69,60,${pulse})`;ctx.lineWidth=6;ctx.strokeRect(3,3,W-6,H-6);
    ctx.font='700 11px Rajdhani,sans-serif';ctx.fillStyle=`rgba(255,100,80,${0.7+0.3*Math.sin(gameTime*4)})`;ctx.textAlign='center';ctx.fillText('âš” BOSS BATTLE âš”',W/2,H-14);ctx.restore();
  }

  if(activeBoss&&activeBoss.hp>0){
    const bx=W/2-180,by2=8,bw=360,bh=8,pct=activeBoss.hp/activeBoss.maxHp,pulse=0.85+0.15*Math.sin(gameTime*6);
    ctx.fillStyle='rgba(0,0,0,0.65)';ctx.fillRect(bx-2,by2-2,bw+4,bh+4);
    ctx.fillStyle='rgba(255,255,255,0.07)';ctx.fillRect(bx,by2,bw,bh);
    const g=ctx.createLinearGradient(bx,0,bx+bw*pct,0);g.addColorStop(0,'#7b0000');g.addColorStop(1,`rgba(255,${Math.round(40*pulse)},40,1)`);
    ctx.fillStyle=g;ctx.shadowColor='#ff2020';ctx.shadowBlur=10;ctx.fillRect(bx,by2,bw*pct,bh);ctx.shadowBlur=0;
    ctx.font='700 11px Rajdhani,sans-serif';ctx.fillStyle='rgba(255,170,170,0.9)';ctx.textAlign='center';ctx.fillText(`${activeBoss.type.icon} ${activeBoss.type.name}`,W/2,by2+bh+12);
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  GAME OVER / CLEAR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function gameOver(){
  state='over';
  document.getElementById('pause-btn').style.display='none';
  const remaining=900-gameTime,m=Math.floor((900-remaining)/60),s=Math.floor((900-remaining)%60);
  document.getElementById('rstats').innerHTML=`
    <div class="stat-row">
      <div class="stat-pill"><span class="val">${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}</span><span class="lbl">ìƒì¡´ ì‹œê°„</span></div>
      <div class="stat-pill"><span class="val">${kills}</span><span class="lbl">ì²˜ì¹˜ ìˆ˜</span></div>
      <div class="stat-pill"><span class="val">${player.level}</span><span class="lbl">ë ˆë²¨</span></div>
    </div>
    <span class="note">ìŠ¤í…Œì´ì§€ ${currentStage} â€” ${STAGES[currentStage-1].name}</span>`;
  let flashes=0;
  const fi=setInterval(()=>{
    ctx.save();ctx.fillStyle=`rgba(200,0,0,${0.6-flashes*0.12})`;ctx.fillRect(0,0,W,H);ctx.restore();
    flashes++;if(flashes>=5){clearInterval(fi);document.getElementById('goscreen').style.display='flex';}
  },80);
}

function stageClear(){
  state='cleared';
  document.getElementById('pause-btn').style.display='none';
  cancelAnimationFrame(animId);
  const stg=STAGES[currentStage-1];
  if(!saveData.clearedStages.includes(currentStage)) saveData.clearedStages.push(currentStage);
  const earned=stg.coinReward;
  saveData.coins+=earned;
  writeSave();
  SFX.stageClear();
  document.getElementById('coin-hud').textContent='ğŸª™ '+saveData.coins;

  document.getElementById('cstats').innerHTML=`
    <div class="stat-row">
      <div class="stat-pill"><span class="val">${kills}</span><span class="lbl">ì²˜ì¹˜ ìˆ˜</span></div>
      <div class="stat-pill"><span class="val">${player.level}</span><span class="lbl">ë ˆë²¨</span></div>
      <div class="stat-pill"><span class="val">Stage ${currentStage}</span><span class="lbl">í´ë¦¬ì–´</span></div>
    </div>`;
  document.getElementById('coin-reward').textContent=`ğŸª™ +${earned} ì½”ì¸ íšë“!`;

  let flashes=0;
  const fi=setInterval(()=>{
    ctx.save();ctx.fillStyle=`rgba(240,192,64,${0.4-flashes*0.08})`;ctx.fillRect(0,0,W,H);ctx.restore();
    flashes++;if(flashes>=5){clearInterval(fi);document.getElementById('clearscreen').style.display='flex';}
  },80);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INPUT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.addEventListener('keydown',e=>{
  if(e.code==='Escape' && (state==='playing'||state==='paused')){ togglePause(); return; }
  keys[e.code]=true; e.preventDefault(); getAudioCtx();
});
document.addEventListener('keyup',e=>{ keys[e.code]=false; });
document.addEventListener('click',()=>getAudioCtx(),{once:true});
document.addEventListener('touchstart',()=>getAudioCtx(),{once:true});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SCREEN ORIENTATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function checkOrientation(){
  // ì„¸ë¡œ ëª¨ë“œë„ ì§€ì›í•˜ë¯€ë¡œ rotate prompt í‘œì‹œ ì•ˆ í•¨
  const prompt=document.getElementById('rotate-prompt');
  if(prompt) prompt.classList.remove('show');
}
window.addEventListener('resize',()=>{ resizeCanvas(); });
window.addEventListener('orientationchange',()=>{ setTimeout(()=>{ resizeCanvas(); },200); });

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CANVAS SCALING (ì„¸ë¡œ/ê°€ë¡œ ëª¨ë‘ ì§€ì›)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let scale=1;
function resizeCanvas(){
  const sw=window.innerWidth, sh=window.innerHeight;
  const isPortrait = sh > sw;

  if(isPortrait){
    // ì„¸ë¡œ ëª¨ë“œ: ë„ˆë¹„ ê¸°ì¤€ìœ¼ë¡œ ìº”ë²„ìŠ¤, ë¹„ìœ¨ 9:16 ëŠë‚Œ
    W = Math.min(sw, 560);
    H = Math.min(sh, Math.round(W * 1.6));
    // ë„ˆë¬´ ê¸¸ë©´ ë†’ì´ ê¸°ì¤€ìœ¼ë¡œ
    if(H > sh){ H = sh; W = Math.round(H / 1.6); }
  } else {
    // ê°€ë¡œ ëª¨ë“œ: ê¸°ì¡´ 800x560 ê¸°ì¤€
    W = 800; H = 560;
  }

  scale = Math.min(sw/W, sh/H, 1);
  const gw=document.getElementById('gw');
  gw.style.width=(W*scale)+'px'; gw.style.height=(H*scale)+'px';
  gw.style.transform=`scale(${scale})`; gw.style.transformOrigin='top left';
  gw.style.left=Math.round((sw-W*scale)/2)+'px';
  gw.style.top=Math.round((sh-H*scale)/2)+'px';
  canvas.width=W; canvas.height=H;

  // ì„¸ë¡œëª¨ë“œì¼ ë•Œ ì¡°ì´ìŠ¤í‹± í•˜ë‹¨ ì¤‘ì•™ ì™¼ìª½ì— ìœ„ì¹˜
  const jBase=document.getElementById('joystick-base');
  if(jBase){
    if(isPortrait){
      jBase.style.left='20px'; jBase.style.bottom='24px'; jBase.style.top='auto';
    } else {
      jBase.style.left='20px'; jBase.style.bottom='20px'; jBase.style.top='auto';
    }
  }
}
resizeCanvas();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  VIRTUAL JOYSTICK
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const jBase=document.getElementById('joystick-base'),jThumb=document.getElementById('joystick-thumb');
let jActive=false,jId=null,jOrigin={x:0,y:0},jDelta={x:0,y:0};
const JR=38;

function jStart(cx,cy){
  const gw=document.getElementById('gw'),rect=gw.getBoundingClientRect();
  const lx=(cx-rect.left)/scale,ly=(cy-rect.top)/scale;
  const isPortrait = window.innerHeight > window.innerWidth;
  // ì„¸ë¡œ: í™”ë©´ í•˜ë‹¨ ì ˆë°˜, ê°€ë¡œ: í™”ë©´ ì™¼ìª½ ì ˆë°˜
  if(isPortrait ? ly < H*0.5 : lx > W/2) return false;
  jActive=true;jBase.style.left=(lx-50)+'px';jBase.style.bottom='auto';jBase.style.top=(ly-50)+'px';
  jOrigin={x:lx,y:ly};jDelta={x:0,y:0};jThumb.style.left='50%';jThumb.style.top='50%';return true;
}
function jMove(cx,cy){
  if(!jActive) return;
  const gw=document.getElementById('gw'),rect=gw.getBoundingClientRect();
  const lx=(cx-rect.left)/scale,ly=(cy-rect.top)/scale;
  const dx=lx-jOrigin.x,dy=ly-jOrigin.y,len=Math.hypot(dx,dy)||1,clamped=Math.min(len,JR);
  jDelta={x:(dx/len)*clamped/JR,y:(dy/len)*clamped/JR};
  jThumb.style.left=(50+jDelta.x*JR)+'px';jThumb.style.top=(50+jDelta.y*JR)+'px';jThumb.style.transform='translate(-50%,-50%)';
}
function jEnd(){ jActive=false;jId=null;jDelta={x:0,y:0};jThumb.style.left='50%';jThumb.style.top='50%';jBase.style.left='20px';jBase.style.top='auto';jBase.style.bottom='20px'; }
function getJoystickInput(){ return jActive?jDelta:{x:0,y:0}; }

canvas.addEventListener('touchstart',e=>{e.preventDefault();for(const t of e.changedTouches){if(jId===null&&jStart(t.clientX,t.clientY)){jId=t.identifier;}}},{passive:false});
canvas.addEventListener('touchmove',e=>{e.preventDefault();for(const t of e.changedTouches){if(t.identifier===jId)jMove(t.clientX,t.clientY);}},{passive:false});
canvas.addEventListener('touchend',e=>{e.preventDefault();for(const t of e.changedTouches){if(t.identifier===jId)jEnd();}},{passive:false});
canvas.addEventListener('touchcancel',e=>{e.preventDefault();jEnd();},{passive:false});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  START SCREEN BG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
(function initRender(){ animId=requestAnimationFrame(initRender); renderStartBg(); })();
function renderStartBg(){
  ctx.fillStyle='#0d1018';ctx.fillRect(0,0,W,H);
  ctx.strokeStyle='rgba(255,255,255,0.04)';ctx.lineWidth=1;
  for(let x=0;x<W;x+=72){ctx.beginPath();ctx.moveTo(x,0);ctx.lineTo(x,H);ctx.stroke();}
  for(let y=0;y<H;y+=72){ctx.beginPath();ctx.moveTo(0,y);ctx.lineTo(W,y);ctx.stroke();}
  const vg=ctx.createRadialGradient(W/2,H/2,60,W/2,H/2,420);
  vg.addColorStop(0,'rgba(124,92,252,0.06)'); vg.addColorStop(1,'rgba(0,0,0,0.6)');
  ctx.fillStyle=vg;ctx.fillRect(0,0,W,H);
}
</script>
</body>
</html>
